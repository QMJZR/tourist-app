// entry/src/main/ets/api/profile.ets

import { http } from "@kit.NetworkKit"
import StorageUtil from "../utils/Storage"

// ==================== æ‰“å¡è®°å½•æ¥å£å®šä¹‰ ====================

/**
 * æ‰“å¡è®°å½•é¡¹æ¥å£
 */
interface CheckinItem {
  checkinId: number;
  spotId: number;
  spotName: string;
  images: string[];
  pointsEarned: number;
  createdAt: string;
}

/**
 * æ‰“å¡è®°å½•å“åº”æ•°æ®æ¥å£
 */
interface CheckinsData {
  list: CheckinItem[];
  page: number;
  total: number;
}

/**
 * æ‰“å¡è®°å½•APIå“åº”æ¥å£
 */
export interface CheckinsApiResponse {
  code: number;
  msg: string;
  data: CheckinsData | null;
}

// ==================== ç§¯åˆ†è®°å½•æ¥å£å®šä¹‰ ====================

/**
 * ç§¯åˆ†è®°å½•é¡¹æ¥å£
 */
interface PointsRecord {
  recordId: number;
  type: string;  // "earn" | "spend"
  source: string;
  points: number;
  createdAt: string;
}

/**
 * ç§¯åˆ†è®°å½•å“åº”æ•°æ®æ¥å£
 */
interface PointsData {
  list: PointsRecord[];
  totalPoints: number;
  page: number;
  pageSize: number;
  total: number;
}

/**
 * ç§¯åˆ†è®°å½•APIå“åº”æ¥å£
 */
export interface PointsApiResponse {
  code: number;
  msg: string;
  data: PointsData | null;
}

// ==================== ç¤¼å“åˆ—è¡¨æ¥å£å®šä¹‰ ====================

/**
 * ç¤¼å“é¡¹æ¥å£
 */
interface GiftItem {
  giftId: number;
  name: string;
  pointsRequired: number;
  status: string;  // "available" | "redeemed" | "expired"
  redeemedAt: string | null;
}

/**
 * ç¤¼å“åˆ—è¡¨å“åº”æ•°æ®æ¥å£
 */
interface GiftsData {
  list: GiftItem[];
  page: number;
  total: number;
}

/**
 * ç¤¼å“åˆ—è¡¨APIå“åº”æ¥å£
 */
export interface GiftsApiResponse {
  code: number;
  msg: string;
  data: GiftsData | null;
}

// ==================== APIå‡½æ•° ====================

/**
 * è·å–ç”¨æˆ·æ‰“å¡è®°å½•
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<CheckinsApiResponse> å“åº”ç»“æœ
 */
export async function getCheckins(page: number = 1): Promise<CheckinsApiResponse | void> {
  let request = http.createHttp();

  try {
    // éœ€è¦å…ˆä»å­˜å‚¨è·å–token
    const token = await StorageUtil.getToken();
    if (!token) {
      console.warn('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
      return;
    }

    console.log('ğŸ” DEBUG: Token from storage =', token);
    console.log('ğŸ” DEBUG: Token length =', token.length);

    const url = `http://10.54.37.27:8080/user/checkins?page=${page}`;
    console.log('ğŸ” DEBUG: è¯·æ±‚URL =', url);

    const response = await request.request(
      url,
      {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,  // æ·»åŠ  Authorization å¤´
          'token': token  // ä¿ç•™åŸæœ‰çš„ token å¤´
        }
      }
    );

    console.log('ğŸ” DEBUG: æ‰“å¡è®°å½•å“åº”çŠ¶æ€ =', response.responseCode);

    // å®‰å…¨çš„headerè®¿é—®
    if (response.header) {
      console.log('ğŸ” DEBUG: å“åº”Headers =', response.header);
    }

    if (response.result) {
      const resultStr = String(response.result);
      console.log('ğŸ” DEBUG: å“åº”Body =', resultStr);
    }

    if (response.responseCode === 200) {
      if (response.result) {
        const resultStr = String(response.result);
        console.log('æ‰“å¡è®°å½•å“åº”:', resultStr);

        try {
          const res: CheckinsApiResponse = JSON.parse(resultStr);

          if (res.code === 200 && res.data) {
            console.log('è·å–æ‰“å¡è®°å½•æˆåŠŸ');
            return res;
          } else {
            console.log('è·å–æ‰“å¡è®°å½•å¤±è´¥:', res.msg);
            return res;
          }
        } catch (parseError) {
          console.error('è§£ææ‰“å¡è®°å½•å“åº”å¤±è´¥:', parseError);
        }
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
      }
    } else if (response.responseCode === 401 || response.responseCode === 403) {
      // å¤„ç†è®¤è¯å¤±è´¥çš„æƒ…å†µ
      console.log("TokenéªŒè¯å¤±è´¥æˆ–ç”¨æˆ·ä¸å­˜åœ¨");

      return {
        code: response.responseCode,
        msg: "ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•",
        data: null
      } as CheckinsApiResponse;
    } else if (response.responseCode === 500) {
      // å¤„ç†æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
      console.log("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼ˆ500ï¼‰");

      if (response.result) {
        const errorResult = String(response.result);
        console.log("é”™è¯¯å“åº”å†…å®¹:", errorResult);
      }

      return {
        code: 500,
        msg: "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•",
        data: null
      } as CheckinsApiResponse;
    } else {
      console.log("è·å–æ‰“å¡è®°å½•å¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);

      // æ·»åŠ è¯¦ç»†é”™è¯¯ä¿¡æ¯
      if (response.result) {
        const errorResult = String(response.result);
        console.log("é”™è¯¯å“åº”å†…å®¹:", errorResult);
        try {
          const errorJson: CheckinsApiResponse = JSON.parse(errorResult);
          console.log("é”™è¯¯JSON:", errorJson);
          return errorJson;
        } catch (e) {
          console.log("é”™è¯¯å†…å®¹ä¸æ˜¯JSONæ ¼å¼");
        }
      }

      // è¿”å›é€šç”¨çš„é”™è¯¯å“åº”
      return {
        code: response.responseCode,
        msg: `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.responseCode}`,
        data: null
      } as CheckinsApiResponse;
    }
  } catch (error) {
    console.error('è·å–æ‰“å¡è®°å½•å¼‚å¸¸:', error);
    // è¿”å›ç½‘ç»œå¼‚å¸¸çš„é”™è¯¯å“åº”
    return {
      code: -1,
      msg: 'ç½‘ç»œè¯·æ±‚å¼‚å¸¸',
      data: null
    } as CheckinsApiResponse;
  } finally {
    request.destroy();
  }
}

/**
 * è·å–ç”¨æˆ·ç§¯åˆ†è®°å½•
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<PointsApiResponse> å“åº”ç»“æœ
 */
export async function getPoints(page: number = 1): Promise<PointsApiResponse | void> {
  let request = http.createHttp();

  try {
    // éœ€è¦å…ˆä»å­˜å‚¨è·å–token
    const token = await StorageUtil.getToken();
    if (!token) {
      console.warn('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
      return;
    }

    console.log('ğŸ” DEBUG: Token from storage =', token);
    console.log('ğŸ” DEBUG: Token length =', token.length);

    const url = `http://10.54.37.27:8080/user/points?page=${page}`;
    console.log('ğŸ” DEBUG: è¯·æ±‚URL =', url);

    const response = await request.request(
      url,
      {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'token': token  // åŒtokenå¤´
        }
      }
    );

    console.log('ğŸ” DEBUG: ç§¯åˆ†è®°å½•å“åº”çŠ¶æ€ =', response.responseCode);

    if (response.result) {
      const resultStr = String(response.result);
      console.log('ğŸ” DEBUG: å“åº”Body =', resultStr);
    }

    if (response.responseCode === 200) {
      if (response.result) {
        const resultStr = String(response.result);
        console.log('ç§¯åˆ†è®°å½•å“åº”:', resultStr);

        try {
          const res: PointsApiResponse = JSON.parse(resultStr);

          if (res.code === 200 && res.data) {
            console.log('è·å–ç§¯åˆ†è®°å½•æˆåŠŸ');
            return res;
          } else {
            console.log('è·å–ç§¯åˆ†è®°å½•å¤±è´¥:', res.msg);
            return res;
          }
        } catch (parseError) {
          console.error('è§£æç§¯åˆ†è®°å½•å“åº”å¤±è´¥:', parseError);
        }
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
      }
    } else {
      console.log("è·å–ç§¯åˆ†è®°å½•å¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);

      if (response.result) {
        const errorResult = String(response.result);
        console.log("é”™è¯¯å“åº”å†…å®¹:", errorResult);
        try {
          const errorJson: PointsApiResponse = JSON.parse(errorResult);
          console.log("é”™è¯¯JSON:", errorJson);
        } catch (e) {
          console.log("é”™è¯¯å†…å®¹ä¸æ˜¯JSONæ ¼å¼");
        }
      }
    }
  } catch (error) {
    console.error('è·å–ç§¯åˆ†è®°å½•å¼‚å¸¸:', error);
  } finally {
    request.destroy();
  }
}

/**
 * è·å–ç”¨æˆ·ç¤¼å“åˆ—è¡¨
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @param status ç¤¼å“çŠ¶æ€ï¼š"available" | "redeemed" | "expired" | "all"ï¼Œé»˜è®¤"all"
 * @returns Promise<GiftsApiResponse> å“åº”ç»“æœ
 */
export async function getGifts(page: number = 1, status: string = "all"): Promise<GiftsApiResponse | void> {
  let request = http.createHttp();

  try {
    // éœ€è¦å…ˆä»å­˜å‚¨è·å–token
    const token = await StorageUtil.getToken();
    if (!token) {
      console.warn('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
      return;
    }

    console.log('ğŸ” DEBUG: Token from storage =', token);
    console.log('ğŸ” DEBUG: Token length =', token.length);

    const url = `http://10.54.37.27:8080/user/gifts?page=${page}&status=${status}`;
    console.log('ğŸ” DEBUG: è¯·æ±‚URL =', url);

    const response = await request.request(
      url,
      {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'token': token  // åŒtokenå¤´
        }
      }
    );

    console.log('ğŸ” DEBUG: ç¤¼å“åˆ—è¡¨å“åº”çŠ¶æ€ =', response.responseCode);

    if (response.result) {
      const resultStr = String(response.result);
      console.log('ğŸ” DEBUG: å“åº”Body =', resultStr);
    }

    if (response.responseCode === 200) {
      if (response.result) {
        const resultStr = String(response.result);
        console.log('ç¤¼å“åˆ—è¡¨å“åº”:', resultStr);

        try {
          const res: GiftsApiResponse = JSON.parse(resultStr);

          if (res.code === 200 && res.data) {
            console.log('è·å–ç¤¼å“åˆ—è¡¨æˆåŠŸ');
            return res;
          } else {
            console.log('è·å–ç¤¼å“åˆ—è¡¨å¤±è´¥:', res.msg);
            return res;
          }
        } catch (parseError) {
          console.error('è§£æç¤¼å“åˆ—è¡¨å“åº”å¤±è´¥:', parseError);
        }
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
      }
    } else {
      console.log("è·å–ç¤¼å“åˆ—è¡¨å¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);

      if (response.result) {
        const errorResult = String(response.result);
        console.log("é”™è¯¯å“åº”å†…å®¹:", errorResult);
        try {
          const errorJson: GiftsApiResponse = JSON.parse(errorResult);
          console.log("é”™è¯¯JSON:", errorJson);
        } catch (e) {
          console.log("é”™è¯¯å†…å®¹ä¸æ˜¯JSONæ ¼å¼");
        }
      }
    }
  } catch (error) {
    console.error('è·å–ç¤¼å“åˆ—è¡¨å¼‚å¸¸:', error);
  } finally {
    request.destroy();
  }
}

/**
 * è·å–å¯å…‘æ¢ç¤¼å“ï¼ˆçŠ¶æ€ä¸ºavailableï¼‰
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<GiftsApiResponse> å“åº”ç»“æœ
 */
export async function getAvailableGifts(page: number = 1): Promise<GiftsApiResponse | void> {
  return await getGifts(page, "available");
}

/**
 * è·å–å·²å…‘æ¢ç¤¼å“ï¼ˆçŠ¶æ€ä¸ºredeemedï¼‰
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<GiftsApiResponse> å“åº”ç»“æœ
 */
export async function getRedeemedGifts(page: number = 1): Promise<GiftsApiResponse | void> {
  return await getGifts(page, "redeemed");
}