// entry/src/main/ets/api/recommend.ets

import { http } from "@kit.NetworkKit";
import StorageUtil from "../utils/Storage";

// ==================== é™„è¿‘æ¨èç›¸å…³æ¥å£å®šä¹‰ ====================

/**
 * é™„è¿‘æ¨èé¡¹æ¥å£
 */
export interface NearbyItem {
  id: number;                // èµ„æºID
  type: string;             // èµ„æºç±»å‹ï¼š"spot" | "merchant"
  name: string;             // åç§°
  latitude: number;         // çº¬åº¦
  longitude: number;        // ç»åº¦
  distance: number;         // ä¸ç”¨æˆ·å½“å‰ä½ç½®è·ç¦»ï¼ˆç±³ï¼‰
  thumbnail: string;        // ç¼©ç•¥å›¾
  popularity: number;       // çƒ­åº¦è¯„åˆ†
}

/**
 * é™„è¿‘æ¨èåˆ—è¡¨å“åº”æ•°æ®æ¥å£
 */
export interface NearbyData {
  list: NearbyItem[];
  page: number;
  pageSize: number;
  total: number;
}

/**
 * é™„è¿‘æ¨èAPIå“åº”æ¥å£
 */
export interface NearbyApiResponse {
  code: number;
  message: string;
  data: NearbyData | null;
}

/**
 * è·å–é™„è¿‘æ¨èçš„è¯·æ±‚å‚æ•°
 */
export interface GetNearbyParams {
  latitude: number;         // ç”¨æˆ·å½“å‰çº¬åº¦ï¼ˆå¿…éœ€ï¼‰
  longitude: number;        // ç”¨æˆ·å½“å‰ç»åº¦ï¼ˆå¿…éœ€ï¼‰
  sort?: string;           // æ’åºæ–¹å¼ï¼š"distance" | "popularity"ï¼Œé»˜è®¤"popularity"
  type?: string;           // æ¨èç±»å‹ï¼š"spot" | "merchant" | "all"ï¼Œé»˜è®¤"all"
  page?: number;           // é¡µç ï¼Œé»˜è®¤1
}

// ==================== APIå‡½æ•° ====================

/**
 * è·å–é™„è¿‘æ¨èæ•°æ®
 * @param params è¯·æ±‚å‚æ•°ï¼ŒåŒ…å«ç»çº¬åº¦ã€æ’åºã€ç±»å‹ã€é¡µç 
 * @returns Promise<NearbyApiResponse | void> å“åº”ç»“æœ
 */
export async function getNearbyRecommendations(params: GetNearbyParams): Promise<NearbyApiResponse | void> {
  let request = http.createHttp();

  try {
    // éœ€è¦å…ˆä»å­˜å‚¨è·å–token
    const token = await StorageUtil.getToken();
    if (!token) {
      console.warn('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
      return;
    }

    console.log('ğŸ” DEBUG: Token from storage =', token);
    console.log('ğŸ” DEBUG: Token length =', token.length);

    // æ„å»ºæŸ¥è¯¢å‚æ•°
    const latitude = params.latitude;
    const longitude = params.longitude;
    const sort = params.sort || 'popularity';
    const type = params.type || 'all';
    const page = params.page || 1;

    const url = `http://10.54.37.27:8080/recommend/nearby?latitude=${latitude}&longitude=${longitude}&sort=${sort}&type=${type}&page=${page}`;
    console.log('ğŸ” DEBUG: è¯·æ±‚URL =', url);

    const response = await request.request(
      url,
      {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'token': token  // åŒtokenå¤´ï¼Œä¿æŒä¸ç°æœ‰æ¥å£ä¸€è‡´
        }
      }
    );

    console.log('ğŸ” DEBUG: é™„è¿‘æ¨èå“åº”çŠ¶æ€ =', response.responseCode);

    // å®‰å…¨çš„headerè®¿é—®
    if (response.header) {
      console.log('ğŸ” DEBUG: å“åº”Headers =', response.header);
    }

    if (response.result) {
      const resultStr = String(response.result);
      console.log('ğŸ” DEBUG: å“åº”Body =', resultStr);
    }

    if (response.responseCode === 200) {
      if (response.result) {
        const resultStr = String(response.result);
        console.log('é™„è¿‘æ¨èå“åº”:', resultStr);

        try {
          const res: NearbyApiResponse = JSON.parse(resultStr);

          if (res.code === 200 && res.data) {
            console.log('è·å–é™„è¿‘æ¨èæˆåŠŸ');
            return res;
          } else {
            console.log('è·å–é™„è¿‘æ¨èå¤±è´¥:', res.message);
            return res;
          }
        } catch (parseError) {
          console.error('è§£æé™„è¿‘æ¨èå“åº”å¤±è´¥:', parseError);
        }
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
      }
    } else {
      console.log("è·å–é™„è¿‘æ¨èå¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);

      // æ·»åŠ è¯¦ç»†é”™è¯¯ä¿¡æ¯
      if (response.result) {
        const errorResult = String(response.result);
        console.log("é”™è¯¯å“åº”å†…å®¹:", errorResult);
        try {
          const errorJson: NearbyApiResponse = JSON.parse(errorResult);
          console.log("é”™è¯¯JSON:", errorJson);
        } catch (e) {
          console.log("é”™è¯¯å†…å®¹ä¸æ˜¯JSONæ ¼å¼");
        }
      }
    }
  } catch (error) {
    console.error('è·å–é™„è¿‘æ¨èå¼‚å¸¸:', error);
  } finally {
    request.destroy();
  }
}

/**
 * è·å–è·ç¦»æœ€è¿‘çš„é™„è¿‘æ¨è
 * @param latitude çº¬åº¦
 * @param longitude ç»åº¦
 * @param type æ¨èç±»å‹ï¼Œé»˜è®¤"all"
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<NearbyApiResponse | void> å“åº”ç»“æœ
 */
export async function getNearbyByDistance(latitude: number, longitude: number, type: string = 'all', page: number = 1): Promise<NearbyApiResponse | void> {
  return await getNearbyRecommendations({
    latitude,
    longitude,
    sort: 'distance',
    type,
    page
  });
}

/**
 * è·å–çƒ­åº¦æœ€é«˜çš„é™„è¿‘æ¨è
 * @param latitude çº¬åº¦
 * @param longitude ç»åº¦
 * @param type æ¨èç±»å‹ï¼Œé»˜è®¤"all"
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<NearbyApiResponse | void> å“åº”ç»“æœ
 */
export async function getNearbyByPopularity(latitude: number, longitude: number, type: string = 'all', page: number = 1): Promise<NearbyApiResponse | void> {
  return await getNearbyRecommendations({
    latitude,
    longitude,
    sort: 'popularity',
    type,
    page
  });
}

/**
 * è·å–é™„è¿‘æ™¯ç‚¹æ¨è
 * @param latitude çº¬åº¦
 * @param longitude ç»åº¦
 * @param sort æ’åºæ–¹å¼ï¼Œé»˜è®¤"popularity"
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<NearbyApiResponse | void> å“åº”ç»“æœ
 */
export async function getNearbySpots(latitude: number, longitude: number, sort: string = 'popularity', page: number = 1): Promise<NearbyApiResponse | void> {
  return await getNearbyRecommendations({
    latitude,
    longitude,
    sort,
    type: 'spot',
    page
  });
}

/**
 * è·å–é™„è¿‘å•†å®¶æ¨è
 * @param latitude çº¬åº¦
 * @param longitude ç»åº¦
 * @param sort æ’åºæ–¹å¼ï¼Œé»˜è®¤"popularity"
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<NearbyApiResponse | void> å“åº”ç»“æœ
 */
export async function getNearbyMerchants(latitude: number, longitude: number, sort: string = 'popularity', page: number = 1): Promise<NearbyApiResponse | void> {
  return await getNearbyRecommendations({
    latitude,
    longitude,
    sort,
    type: 'merchant',
    page
  });
}

/**
 * è·å–å½“å‰ä½ç½®é™„è¿‘çš„æ¨èï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨é»˜è®¤ä½ç½®ï¼‰
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @param sort æ’åºæ–¹å¼ï¼Œé»˜è®¤"popularity"
 * @param type æ¨èç±»å‹ï¼Œé»˜è®¤"all"
 * @returns Promise<NearbyApiResponse | void> å“åº”ç»“æœ
 */
export async function getNearbyRecommendationsSimple(page: number = 1, sort: string = 'popularity', type: string = 'all'): Promise<NearbyApiResponse | void> {
  // è¿™é‡Œå¯ä»¥ä½¿ç”¨é»˜è®¤ä½ç½®æˆ–ä»è®¾å¤‡è·å–ä½ç½®
  // å®é™…åº”ç”¨ä¸­åº”è¯¥ä»è®¾å¤‡GPSè·å–
  const defaultLatitude = 23.112233;  // é»˜è®¤çº¬åº¦
  const defaultLongitude = 113.332211; // é»˜è®¤ç»åº¦

  return await getNearbyRecommendations({
    latitude: defaultLatitude,
    longitude: defaultLongitude,
    sort,
    type,
    page
  });
}