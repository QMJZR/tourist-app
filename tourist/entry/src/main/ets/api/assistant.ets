// entry/src/main/ets/api/assistant.ets

import { http } from "@kit.NetworkKit"
import StorageUtil from "../utils/Storage"

// ==================== è¯·æ±‚æ¥å£å®šä¹‰ ====================

/**
 * æé—®æ™ºèƒ½åŠ©æ‰‹è¯·æ±‚æ¥å£
 */
interface GeneratedTypeLiteralInterface_1 {
  latitude?: number;
  longitude?: number;
  history?: string[];
}

export class AskAssistantRequest {
  question: string = '';
  context?: GeneratedTypeLiteralInterface_1;
}

// ==================== å“åº”æ¥å£å®šä¹‰ ====================

/**
 * æ¨èèµ„æºæ¥å£
 */
interface GeneratedTypeLiteralInterface_2 {
  type: string;
  id: number;
  name: string;
  latitude: number;
  longitude: number;
  distance: number;
}

/**
 * æ™ºèƒ½é—®ç­”å“åº”æ•°æ®æ¥å£
 */
interface GeneratedTypeLiteralInterface_3 {
  answer: string;
  recommendations: GeneratedTypeLiteralInterface_2[];
}

/**
 * æ™ºèƒ½é—®ç­”APIå“åº”æ¥å£ - ä¸ç”¨æˆ·æ¥å£ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨msgå­—æ®µ
 */
export interface AskAssistantApiResponse {
  code: number;
  msg: string;  // ä½¿ç”¨msgï¼Œä¸æ‚¨çš„å…¶ä»–æ¥å£ä¸€è‡´
  data: GeneratedTypeLiteralInterface_3 | null;
}

// ==================== APIå‡½æ•° ====================

/**
 * å‘æ™ºèƒ½åŠ©æ‰‹æé—®
 * @param askData æé—®è¯·æ±‚æ•°æ®
 * @returns Promise<AskAssistantApiResponse> å“åº”ç»“æœ
 */
export async function askAssistant(askData: AskAssistantRequest): Promise<AskAssistantApiResponse | void> {
  let request = http.createHttp();

  try {
    // éœ€è¦å…ˆä»å­˜å‚¨è·å–token
    const token = await StorageUtil.getToken();
    if (!token) {
      console.warn('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
      return;
    }

    console.log('ğŸ” DEBUG: Token from storage =', token);
    console.log('ğŸ” DEBUG: Token length =', token.length);

    const response = await request.request(
      "http://10.54.37.27:8080/assistant/ask",
      {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,  // ä¿æŒ Authorization
          'token': token  // åŒæ—¶å‘é€ token å¤´
        },
        extraData: JSON.stringify(askData)
      }
    );

    console.log('ğŸ” DEBUG: Response Status =', response.responseCode);

    // å®‰å…¨çš„headerè®¿é—®
    if (response.header) {
      console.log('ğŸ” DEBUG: Response Headers =', response.header);
    }

    if (response.result) {
      const resultStr = String(response.result);
      console.log('ğŸ” DEBUG: Response Body =', resultStr);
    }

    if (response.responseCode === 200) {
      if (response.result) {
        const resultStr = String(response.result);
        console.log('æé—®æ™ºèƒ½åŠ©æ‰‹å“åº”:', resultStr);

        try {
          const res: AskAssistantApiResponse = JSON.parse(resultStr);

          if (res.code === 200 && res.data) {
            console.log('æ™ºèƒ½åŠ©æ‰‹å›ç­”æˆåŠŸ');
            return res;
          } else {
            console.log('æ™ºèƒ½åŠ©æ‰‹è¿”å›é”™è¯¯:', res.msg);
            return res;
          }
        } catch (parseError) {
          console.error('è§£ææ™ºèƒ½åŠ©æ‰‹å“åº”å¤±è´¥:', parseError);
        }
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
      }
    } else {
      console.log("æé—®æ™ºèƒ½åŠ©æ‰‹å¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);
      // æ·»åŠ è¯¦ç»†é”™è¯¯ä¿¡æ¯
      if (response.result) {
        const errorResult = String(response.result);
        console.log("é”™è¯¯å“åº”å†…å®¹:", errorResult);
        try {
          const errorJson: AskAssistantApiResponse = JSON.parse(errorResult);
          console.log("é”™è¯¯JSON:", errorJson);
        } catch (e) {
          console.log("é”™è¯¯å†…å®¹ä¸æ˜¯JSONæ ¼å¼");
        }
      }
    }
  } catch (error) {
    console.error('æé—®æ™ºèƒ½åŠ©æ‰‹å¼‚å¸¸:', error);
  } finally {
    request.destroy();
  }
}

/**
 * ç®€åŒ–ç‰ˆæé—®å‡½æ•°ï¼ˆæ— ä¸Šä¸‹æ–‡ï¼‰
 * @param question ç”¨æˆ·é—®é¢˜
 * @returns Promise<AskAssistantApiResponse> å“åº”ç»“æœ
 */
export async function askSimple(question: string): Promise<AskAssistantApiResponse | void> {
  const askData: AskAssistantRequest = {
    question: question
  };

  return await askAssistant(askData);
}