// entry/src/main/ets/api/ranking.ets

import { http } from "@kit.NetworkKit";
import StorageUtil from "../utils/Storage";

// ==================== æ’è¡Œæ¦œç›¸å…³æ¥å£å®šä¹‰ ====================

/**
 * æ’è¡Œæ¦œé¡¹æ¥å£
 */
export interface RankingItem {
  rank: number;          // æ’å
  userId: number;       // ç”¨æˆ·ID
  username: string;     // ç”¨æˆ·å
  avatar: string;       // ç”¨æˆ·å¤´åƒ
  totalCheckins: number; // æ€»æ‰“å¡æ•°
  totalLikes: number;   // æ€»ç‚¹èµæ•°
  score: number;        // ç»¼åˆè¯„åˆ†
}

/**
 * æ’è¡Œæ¦œåˆ—è¡¨å“åº”æ•°æ®æ¥å£
 */
export interface RankingsData {
  list: RankingItem[];
  page: number;
  pageSize: number;
  total: number;
}

/**
 * æ’è¡Œæ¦œAPIå“åº”æ¥å£
 */
export interface RankingsApiResponse {
  code: number;
  message: string;  // æ³¨æ„ï¼šæ’è¡Œæ¦œæ¥å£ä½¿ç”¨çš„æ˜¯messageï¼Œä¸æ˜¯msg
  data: RankingsData | null;
}

/**
 * è·å–æ’è¡Œæ¦œçš„è¯·æ±‚å‚æ•°
 */
export interface GetRankingsParams {
  period?: string;  // æ—¶é—´å‘¨æœŸï¼š"daily" | "weekly" | "monthly"ï¼Œé»˜è®¤"weekly"
  page?: number;    // é¡µç ï¼Œé»˜è®¤1
  sort?: string;    // æ’åºæ–¹å¼ï¼š"points" | "checkins"ï¼Œé»˜è®¤"points"
}

// ==================== APIå‡½æ•° ====================

/**
 * è·å–æ’è¡Œæ¦œæ•°æ®
 * @param params è¯·æ±‚å‚æ•°ï¼ŒåŒ…å«periodã€pageã€sort
 * @returns Promise<RankingsApiResponse | void> å“åº”ç»“æœ
 */
export async function getRankings(params: GetRankingsParams = {}): Promise<RankingsApiResponse | void> {
  let request = http.createHttp();

  try {
    // éœ€è¦å…ˆä»å­˜å‚¨è·å–token
    const token = await StorageUtil.getToken();
    if (!token) {
      console.warn('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
      return;
    }

    console.log('ğŸ” DEBUG: Token from storage =', token);
    console.log('ğŸ” DEBUG: Token length =', token.length);

    // æ„å»ºæŸ¥è¯¢å‚æ•°
    const period = params.period || 'weekly';
    const page = params.page || 1;
    const sort = params.sort || 'points';

    const url = `http://10.54.37.27:8080/rankings?period=${period}&page=${page}&sort=${sort}`;
    console.log('ğŸ” DEBUG: è¯·æ±‚URL =', url);

    const response = await request.request(
      url,
      {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'token': token  // åŒtokenå¤´ï¼Œä¿æŒä¸ç°æœ‰æ¥å£ä¸€è‡´
        }
      }
    );

    console.log('ğŸ” DEBUG: æ’è¡Œæ¦œå“åº”çŠ¶æ€ =', response.responseCode);

    // å®‰å…¨çš„headerè®¿é—®
    if (response.header) {
      console.log('ğŸ” DEBUG: å“åº”Headers =', response.header);
    }

    if (response.result) {
      const resultStr = String(response.result);
      console.log('ğŸ” DEBUG: å“åº”Body =', resultStr);
    }

    if (response.responseCode === 200) {
      if (response.result) {
        const resultStr = String(response.result);
        console.log('æ’è¡Œæ¦œå“åº”:', resultStr);

        try {
          const res: RankingsApiResponse = JSON.parse(resultStr);

          if (res.code === 200 && res.data) {
            console.log('è·å–æ’è¡Œæ¦œæˆåŠŸ');
            return res;
          } else {
            console.log('è·å–æ’è¡Œæ¦œå¤±è´¥:', res.message);
            return res;
          }
        } catch (parseError) {
          console.error('è§£ææ’è¡Œæ¦œå“åº”å¤±è´¥:', parseError);
        }
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
      }
    } else {
      console.log("è·å–æ’è¡Œæ¦œå¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);

      // æ·»åŠ è¯¦ç»†é”™è¯¯ä¿¡æ¯
      if (response.result) {
        const errorResult = String(response.result);
        console.log("é”™è¯¯å“åº”å†…å®¹:", errorResult);
        try {
          const errorJson: RankingsApiResponse = JSON.parse(errorResult);
          console.log("é”™è¯¯JSON:", errorJson);
        } catch (e) {
          console.log("é”™è¯¯å†…å®¹ä¸æ˜¯JSONæ ¼å¼");
        }
      }
    }
  } catch (error) {
    console.error('è·å–æ’è¡Œæ¦œå¼‚å¸¸:', error);
  } finally {
    request.destroy();
  }
}

/**
 * è·å–ä»Šæ—¥æ’è¡Œæ¦œ
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @param sort æ’åºæ–¹å¼ï¼Œé»˜è®¤"points"
 * @returns Promise<RankingsApiResponse | void> å“åº”ç»“æœ
 */
export async function getDailyRankings(page: number = 1, sort: string = 'points'): Promise<RankingsApiResponse | void> {
  return await getRankings({ period: 'daily', page, sort });
}

/**
 * è·å–æœ¬å‘¨æ’è¡Œæ¦œ
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @param sort æ’åºæ–¹å¼ï¼Œé»˜è®¤"points"
 * @returns Promise<RankingsApiResponse | void> å“åº”ç»“æœ
 */
export async function getWeeklyRankings(page: number = 1, sort: string = 'points'): Promise<RankingsApiResponse | void> {
  return await getRankings({ period: 'weekly', page, sort });
}

/**
 * è·å–æœ¬æœˆæ’è¡Œæ¦œ
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @param sort æ’åºæ–¹å¼ï¼Œé»˜è®¤"points"
 * @returns Promise<RankingsApiResponse | void> å“åº”ç»“æœ
 */
export async function getMonthlyRankings(page: number = 1, sort: string = 'points'): Promise<RankingsApiResponse | void> {
  return await getRankings({ period: 'monthly', page, sort });
}

/**
 * æŒ‰æ‰“å¡æ•°æ’åºçš„æ’è¡Œæ¦œ
 * @param period æ—¶é—´å‘¨æœŸï¼Œé»˜è®¤"weekly"
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<RankingsApiResponse | void> å“åº”ç»“æœ
 */
export async function getRankingsByCheckins(period: string = 'weekly', page: number = 1): Promise<RankingsApiResponse | void> {
  return await getRankings({ period, page, sort: 'checkins' });
}

/**
 * æŒ‰ç»¼åˆè¯„åˆ†æ’åºçš„æ’è¡Œæ¦œ
 * @param period æ—¶é—´å‘¨æœŸï¼Œé»˜è®¤"weekly"
 * @param page é¡µç ï¼Œé»˜è®¤1
 * @returns Promise<RankingsApiResponse | void> å“åº”ç»“æœ
 */
export async function getRankingsByPoints(period: string = 'weekly', page: number = 1): Promise<RankingsApiResponse | void> {
  return await getRankings({ period, page, sort: 'points' });
}