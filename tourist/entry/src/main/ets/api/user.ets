import { http } from "@kit.NetworkKit"
import StorageUtil from "../utils/Storage"
export class RegisterRequest {
  username: string = '';
  password: string = '';
  email: string = '';
}

// ä¿®æ”¹ä¸ªäººä¿¡æ¯è¯·æ±‚æ¥å£
export class UpdateProfileRequest {
  nickname: string = '';  // ä¿æŒä¸ç°æœ‰æ¥å£ä¸€è‡´ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²
  avatar: string = '';
  email: string = '';
}

// æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯å“åº”æ¥å£ - ä¸ProfileApiResponseä¿æŒä¸€è‡´
interface GeneratedTypeLiteralInterface_3 {
  userId: number;
  username: string;
  nickname: string;
  avatar: string;
  points: number;
  checkinCount: number;
  isMerchant: string;
  checkinSpotIds: number[];
  email: string;
}

interface UpdateProfileApiResponse {
  code: number;
  msg: string;  // æ³¨æ„ï¼šæ ¹æ®ä½ çš„ç°æœ‰æ¥å£ï¼Œä½¿ç”¨msgè€Œä¸æ˜¯message
  data: GeneratedTypeLiteralInterface_3;
}


export async function register(RegisterData: RegisterRequest): Promise<string> {
  let request = http.createHttp();

  try {
    const response = await request.request(
      "http://10.54.37.27:8080/api/v1/auth/register",  // æ³¨æ„ï¼šhttp:// ä¸æ˜¯ https://
      {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json'
        },
        extraData: JSON.stringify(RegisterData)  // å¿…é¡»åºåˆ—åŒ–
      }
    );
    if (response.responseCode === 200 || response.responseCode === 201) {
      console.log("æ³¨å†Œè¯·æ±‚æˆåŠŸ");

      // å®‰å…¨åœ°è·å–ç»“æœ
      if (response.result) {
        return String(response.result);
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
        return '{}';  // è¿”å›ç©ºJSONå¯¹è±¡å­—ç¬¦ä¸²
      }
    } else {
      console.log("æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);
      // å°è¯•è·å–é”™è¯¯ä¿¡æ¯
      if (response.result) {
        return String(response.result);
      }
      return '';
    }
  } catch (error) {
    console.error('æ³¨å†Œè¯·æ±‚å¼‚å¸¸:', error);
    return '';
  } finally {
    // ç¡®ä¿é”€æ¯è¯·æ±‚å¯¹è±¡
    request.destroy();
  }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼š
// const data = new RegisterRequest();
// data.username = 'test';
// data.password = '123456';
// data.email = 'test@example.com';
// const result = await register(data);
// console.log('æ³¨å†Œç»“æœ:', result);

export class LoginRequest {
  username:string = "";
  password:string = "";
}

interface GeneratedTypeLiteralInterface_1 {
  userId: number;
  token: string;
  expiresIn?: number;
}

interface LoginApiResponse {
  code: number;
  msg: string;
  data: GeneratedTypeLiteralInterface_1;
}

export async function login(loginData: LoginRequest): Promise<string> {
  let request = http.createHttp();

  try {
    const response = await request.request(
      "http://10.54.37.27:8080/api/v1/auth/login",
      {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json'
        },
        extraData: JSON.stringify(loginData)
      }
    );

    if (response.responseCode === 200) {
      console.log("ç™»å½•è¯·æ±‚æˆåŠŸ");

      if (response.result) {
        const result = String(response.result);
        // é€šå¸¸ç™»å½•æˆåŠŸä¼šè¿”å› tokenï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œå¤„ç†

        console.log('ç™»å½•å“åº”:', result);
        const res : LoginApiResponse = JSON.parse(result);
        console.log("before save loginInfo, userId is" ,res.data.userId);
        StorageUtil.saveLoginInfo(res.data.token, res.data.userId);
        return result;
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
        return '{}';
      }
    } else {
      console.log("ç™»å½•è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);
      if (response.result) {
        return String(response.result);
      }
      return '';
    }
  } catch (error) {
    console.error('ç™»å½•è¯·æ±‚å¼‚å¸¸:', error);
    return '';
  } finally {
    request.destroy();
  }
}

// get profile by Id
// å…ˆå®šä¹‰æ¥å£ç±»å‹
interface GeneratedTypeLiteralInterface_2 {
  userId: number;
  username: string;
  nickname: string;
  avatar: string;
  points: number;
  checkinCount: number;
  isMerchant: string;
  checkinSpotIds: number[];
  email: string;
}

interface ProfileApiResponse {
  code: number;
  msg: string;
  data: GeneratedTypeLiteralInterface_2;
}

// è·å–ç”¨æˆ·èµ„æ–™
export async function getProfile(): Promise<ProfileApiResponse | void> {
  let request = http.createHttp();

  try {
    // éœ€è¦å…ˆä»å­˜å‚¨è·å–token
    const token = await StorageUtil.getToken();
    if (!token) {
      console.warn('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
      return;
    }
    const userId = await StorageUtil.getUserId();
    console.log("when getProfile, i got userId:", userId);
    const response = await request.request(
      `http://10.54.37.27:8080/api/v1/auth/profile?userId=${userId}`,
      {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`  // æ·»åŠ è®¤è¯å¤´
        }
      }
    );

    console.log('è·å–èµ„æ–™å“åº”çŠ¶æ€:', response.responseCode);

    if (response.responseCode === 200) {
      if (response.result) {
        const resultStr = String(response.result);
        console.log('ç”¨æˆ·èµ„æ–™å“åº”:', resultStr);

        try {
          const res: ProfileApiResponse = JSON.parse(resultStr);

          // å¦‚æœè·å–æˆåŠŸï¼Œæ›´æ–°æœ¬åœ°å­˜å‚¨
          if (res.code === 200 && res.data) {
            console.log('è·å–ç”¨æˆ·èµ„æ–™æˆåŠŸ');

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
            //await StorageUtil.saveUserInfo(res.data);

            return res;
          } else {
            //console.log('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', res.message || res.msg);
            return res;
          }
        } catch (parseError) {
          console.error('è§£æç”¨æˆ·èµ„æ–™å“åº”å¤±è´¥:', parseError);
          // return {
          //   code: 500,
          //   //message: 'å“åº”æ•°æ®æ ¼å¼é”™è¯¯'
          // };
        }
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
        // return {
        //   code: 500,
        //   message: 'æœåŠ¡å™¨è¿”å›ç©ºå“åº”'
        // };
      }
    } else {
      console.log("è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);

    }
  } catch (error) {
    console.error('è·å–ç”¨æˆ·èµ„æ–™å¼‚å¸¸:', error);
  } finally {
    request.destroy();
  }
}

export async function updateProfile(updateData: UpdateProfileRequest): Promise<UpdateProfileApiResponse | void> {
  let request = http.createHttp();

  try {
    // éœ€è¦å…ˆä»å­˜å‚¨è·å–token
    const token = await StorageUtil.getToken();
    if (!token) {
      console.warn('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
      return;
    }

    console.log('ğŸ” DEBUG: Token from storage =', token);
    console.log('ğŸ” DEBUG: Token length =', token.length);

    const response = await request.request(
      "http://10.54.37.27:8080/user/profile",
      {
        method: http.RequestMethod.PUT,
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,  // ä¿æŒ Authorization
          'token': token  // åŒæ—¶å‘é€ token å¤´
        },
        extraData: JSON.stringify(updateData)
      }
    );

    console.log('ğŸ” DEBUG: Response Status =', response.responseCode);

    // å®‰å…¨çš„headerè®¿é—®
    if (response.header) {
      console.log('ğŸ” DEBUG: Response Headers =', response.header);
    }

    if (response.result) {
      const resultStr = String(response.result);
      console.log('ğŸ” DEBUG: Response Body =', resultStr);
    }

    if (response.responseCode === 200) {
      if (response.result) {
        const resultStr = String(response.result);
        console.log('æ›´æ–°ç”¨æˆ·èµ„æ–™å“åº”:', resultStr);

        try {
          const res: UpdateProfileApiResponse = JSON.parse(resultStr);

          if (res.code === 200 && res.data) {
            console.log('æ›´æ–°ç”¨æˆ·èµ„æ–™æˆåŠŸ');
            return res;
          } else {
            console.log('æ›´æ–°ç”¨æˆ·èµ„æ–™å¤±è´¥:', res.msg);
            return res;
          }
        } catch (parseError) {
          console.error('è§£ææ›´æ–°ç”¨æˆ·èµ„æ–™å“åº”å¤±è´¥:', parseError);
        }
      } else {
        console.warn('å“åº”ç»“æœä¸ºç©º');
      }
    } else {
      console.log("æ›´æ–°ç”¨æˆ·èµ„æ–™å¤±è´¥ï¼ŒçŠ¶æ€ç :", response.responseCode);
      // æ·»åŠ è¯¦ç»†é”™è¯¯ä¿¡æ¯
      if (response.result) {
        const errorResult = String(response.result);
        console.log("é”™è¯¯å“åº”å†…å®¹:", errorResult);
        try {
          const errorJson: UpdateProfileApiResponse = JSON.parse(errorResult);
          console.log("é”™è¯¯JSON:", errorJson);
        } catch (e) {
          console.log("é”™è¯¯å†…å®¹ä¸æ˜¯JSONæ ¼å¼");
        }
      }
    }
  } catch (error) {
    console.error('æ›´æ–°ç”¨æˆ·èµ„æ–™å¼‚å¸¸:', error);
  } finally {
    request.destroy();
  }
}