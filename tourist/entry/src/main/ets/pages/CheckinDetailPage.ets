// entry/src/main/ets/pages/CheckinDetailPage.ets

import { router } from '@kit.ArkUI';

// æ‰“å¡è®°å½•ç±»å‹å®šä¹‰
interface CheckinRecordLocal {
  checkinId: number;
  spotId: number;
  spotName: string;
  images: Array<string>;
  pointsEarned: number;
  createdAt: string;
}

@Entry
@Component
struct CheckinDetailPage {
  @State totalCheckins: number = 0;  // æ€»æ‰“å¡æ¬¡æ•°
  @State checkinRecords: Array<CheckinRecordLocal> = [];  // æ‰“å¡è®°å½•åˆ—è¡¨
  @State currentPage: number = 1;  // å½“å‰é¡µç 
  @State totalPages: number = 1;  // æ€»é¡µæ•°

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;
  @State isError: boolean = false;
  @State errorMessage: string = '';

  // ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    console.log('æ‰“å¡è¯¦æƒ…é¡µé¢æ˜¾ç¤º');
    this.loadCheckinData();
  }

  // åŠ è½½æ‰“å¡æ•°æ®ï¼ˆä½¿ç”¨å‡æ•°æ®ï¼‰
  private loadCheckinData() {
    if (this.isLoading) {
      return;
    }

    this.isLoading = true;
    this.isError = false;

    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      try {
        // ç”Ÿæˆå‡æ•°æ®
        this.generateMockData();

        console.log(`âœ… åŠ è½½æ‰“å¡æ•°æ®æˆåŠŸï¼Œå…±${this.totalCheckins}æ¡è®°å½•ï¼Œå½“å‰ç¬¬${this.currentPage}é¡µ`);
      } catch (error) {
        this.isError = true;
        this.errorMessage = 'åŠ è½½æ‰“å¡æ•°æ®å¤±è´¥';
        console.error('è·å–æ‰“å¡æ•°æ®å¼‚å¸¸:', error);
      } finally {
        this.isLoading = false;
        this.isRefreshing = false;
      }
    }, 800);
  }

  // ç”Ÿæˆå‡æ•°æ®
  private generateMockData() {
    const mockRecords: Array<CheckinRecordLocal> = [
      {
        checkinId: 101,
        spotId: 1,
        spotName: 'å¤å»ºç­‘ç¾¤',
        images: ['https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w=800&auto=format&fit=crop'],
        pointsEarned: 50,
        createdAt: '2025-12-14 14:30:25'
      },
      {
        checkinId: 102,
        spotId: 2,
        spotName: 'ç‰¹è‰²ç¾é£Ÿè¡—',
        images: ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&auto=format&fit=crop'],
        pointsEarned: 30,
        createdAt: '2025-12-13 11:20:15'
      },
      {
        checkinId: 103,
        spotId: 3,
        spotName: 'ç”Ÿæ€æ¹¿åœ°å…¬å›­',
        images: ['https://images.unsplash.com/photo-1501854140801-50d01698950b?w=800&auto=format&fit=crop'],
        pointsEarned: 40,
        createdAt: '2025-12-12 16:45:33'
      },
      {
        checkinId: 104,
        spotId: 4,
        spotName: 'è‰ºæœ¯ç”»å»Š',
        images: ['https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=800&auto=format&fit=crop'],
        pointsEarned: 35,
        createdAt: '2025-12-11 10:15:42'
      },
      {
        checkinId: 105,
        spotId: 5,
        spotName: 'å„¿ç«¥æ¸¸ä¹åœº',
        images: ['https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=800&auto=format&fit=crop'],
        pointsEarned: 25,
        createdAt: '2025-12-10 15:50:18'
      },
      {
        checkinId: 106,
        spotId: 6,
        spotName: 'ç§‘æŠ€ä½“éªŒé¦†',
        images: ['https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&auto=format&fit=crop'],
        pointsEarned: 60,
        createdAt: '2025-12-09 13:25:59'
      },
      {
        checkinId: 107,
        spotId: 7,
        spotName: 'åŸå¸‚å…¬å›­',
        images: ['https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&auto=format&fit=crop'],
        pointsEarned: 20,
        createdAt: '2025-12-08 09:40:12'
      },
      {
        checkinId: 108,
        spotId: 8,
        spotName: 'è´­ç‰©ä¸­å¿ƒ',
        images: ['https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800&auto=format&fit=crop'],
        pointsEarned: 15,
        createdAt: '2025-12-07 18:30:27'
      },
      {
        checkinId: 109,
        spotId: 1,
        spotName: 'å¤å»ºç­‘ç¾¤',
        images: ['https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w=800&auto=format&fit=crop'],
        pointsEarned: 45,
        createdAt: '2025-12-06 14:20:38'
      },
      {
        checkinId: 110,
        spotId: 2,
        spotName: 'ç‰¹è‰²ç¾é£Ÿè¡—',
        images: ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&auto=format&fit=crop'],
        pointsEarned: 35,
        createdAt: '2025-12-05 12:15:22'
      }
    ];

    // æ ¹æ®å½“å‰é¡µç åŠ è½½æ•°æ®
    const pageSize = 10;  // æ¯é¡µ10æ¡
    const startIndex = (this.currentPage - 1) * pageSize;

    if (this.currentPage === 1) {
      // ç¬¬ä¸€é¡µï¼šæ˜¾ç¤ºå‰10æ¡æ•°æ®
      this.checkinRecords = mockRecords.slice(0, Math.min(pageSize, mockRecords.length));
    } else if (this.currentPage === 2) {
      // ç¬¬äºŒé¡µï¼šæ˜¾ç¤ºæ›´å¤šå‡æ•°æ®
      const moreMockRecords: Array<CheckinRecordLocal> = [
        {
          checkinId: 111,
          spotId: 3,
          spotName: 'ç”Ÿæ€æ¹¿åœ°å…¬å›­',
          images: ['https://images.unsplash.com/photo-1501854140801-50d01698950b?w=800&auto=format&fit=crop'],
          pointsEarned: 40,
          createdAt: '2025-12-04 16:10:55'
        },
        {
          checkinId: 112,
          spotId: 4,
          spotName: 'è‰ºæœ¯ç”»å»Š',
          images: ['https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=800&auto=format&fit=crop'],
          pointsEarned: 35,
          createdAt: '2025-12-03 11:45:19'
        },
        {
          checkinId: 113,
          spotId: 5,
          spotName: 'å„¿ç«¥æ¸¸ä¹åœº',
          images: ['https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=800&auto=format&fit=crop'],
          pointsEarned: 25,
          createdAt: '2025-12-02 14:30:44'
        },
        {
          checkinId: 114,
          spotId: 6,
          spotName: 'ç§‘æŠ€ä½“éªŒé¦†',
          images: ['https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&auto=format&fit=crop'],
          pointsEarned: 60,
          createdAt: '2025-12-01 10:20:33'
        }
      ];
      this.checkinRecords = [...this.checkinRecords, ...moreMockRecords];
    }

    // æ›´æ–°æ€»æ•°
    this.totalCheckins = this.currentPage === 1 ? 24 : 14; // æ¨¡æ‹Ÿæ€»æ•°æ®é‡å˜åŒ–

    // è®¡ç®—æ€»é¡µæ•°
    this.totalPages = Math.ceil(this.totalCheckins / pageSize);
  }

  // åˆ·æ–°æ•°æ®
  private refreshData() {
    this.currentPage = 1;
    this.isRefreshing = true;
    this.loadCheckinData();
  }

  // åŠ è½½æ›´å¤š
  private loadMore() {
    if (this.isLoading || this.currentPage >= this.totalPages) {
      return;
    }

    this.currentPage += 1;
    this.isLoading = true;

    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      try {
        this.generateMockData();
        console.log(`âœ… åŠ è½½æ›´å¤šæˆåŠŸï¼Œå½“å‰å…±${this.checkinRecords.length}æ¡è®°å½•`);
      } catch (error) {
        console.error('åŠ è½½æ›´å¤šå¼‚å¸¸:', error);
        // å›é€€é¡µç 
        this.currentPage -= 1;
      } finally {
        this.isLoading = false;
      }
    }, 800);
  }

  // æ ¼å¼åŒ–æ—¶é—´ï¼ˆå»æ‰ç§’ï¼‰
  private formatTime(createdAt: string): string {
    if (!createdAt) return '';
    // å°† "2025-01-11 14:20:33" æ ¼å¼åŒ–ä¸º "2025-01-11 14:20"
    return createdAt.substring(0, 16);
  }

  // æ„å»ºæ‰“å¡å¡ç‰‡
  @Builder
  buildCheckinCard() {
    Column({ space: 12 }) {
      // æ‰“å¡æ ‡é¢˜
      Text('æˆ‘çš„æ‰“å¡')
        .fontSize(16)
        .fontColor('#666666')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Start)
        .width('100%')

      // æ‰“å¡æ•°å€¼
      Row({ space: 8 }) {
        Text(this.totalCheckins.toString())
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor('#34C759')

        Text('æ¬¡')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ top: 20 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)

      // æ‰“å¡è¯´æ˜
      Text('æ‰“å¡å¯ä»¥èµšå–ç§¯åˆ†ï¼Œè§£é”æ›´å¤šæ—…è¡Œæˆå°±')
        .fontSize(14)
        .fontColor('#999999')
        .textAlign(TextAlign.Start)
        .width('100%')
        .margin({ top: 8 })
    }
    .padding({ left: 24, right: 24, top: 28, bottom: 28 })
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({ radius: 8, color: '#34C75910' })
  }

  // æ„å»ºæ‰“å¡è®°å½•é¡¹
  @Builder
  buildCheckinRecordItem(record: CheckinRecordLocal, index: number) {
    Column() {
      Row({ space: 16 }) {
        // å·¦ä¾§ï¼šæ‰“å¡å›¾æ ‡
        Column() {
          Text('ğŸ“')
            .fontSize(20)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#34C759')
        .borderRadius(20)

        // ä¸­é—´ï¼šè¯¦æƒ…
        Column({ space: 4 }) {
          // æ™¯ç‚¹åç§°
          Text(record.spotName || 'æœªçŸ¥æ™¯ç‚¹')
            .fontSize(16)
            .fontColor('#333333')
            .fontWeight(FontWeight.Medium)
            .textAlign(TextAlign.Start)
            .width('100%')

          // æ—¶é—´å’Œç§¯åˆ†
          Row({ space: 12 }) {
            Text(this.formatTime(record.createdAt))
              .fontSize(13)
              .fontColor('#999999')

            Text(`+${record.pointsEarned || 0}ç§¯åˆ†`)
              .fontSize(13)
              .fontColor('#FF9500')
              .backgroundColor('#FFF4E6')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)
          }
          .width('100%')
        }
        .layoutWeight(1)

        // å³ä¾§ï¼šå›¾ç‰‡é¢„è§ˆï¼ˆå¦‚æœæœ‰å›¾ç‰‡ï¼‰
        if (record.images && record.images.length > 0 && record.images[0]) {
          Image(record.images[0])
            .width(40)
            .height(40)
            .objectFit(ImageFit.Cover)
            .borderRadius(8)
        } else {
          // é»˜è®¤å›¾ç‰‡å ä½
          Column() {
            Text('ğŸ“·')
              .fontSize(20)
              .fontColor('#999999')
          }
          .width(40)
          .height(40)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#F0F0F0')
          .borderRadius(8)
        }
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })

      // åˆ†éš”çº¿ï¼ˆä¸æ˜¯æœ€åä¸€é¡¹æ—¶æ˜¾ç¤ºï¼‰
      if (index < this.checkinRecords.length - 1) {
        Divider()
          .color('#F0F0F0')
          .margin({ left: 72, right: 16 })
          .strokeWidth(0.5)
      }
    }
  }

  // æ„å»ºè®°å½•åˆ—è¡¨
  @Builder
  buildRecordsList() {
    Column() {
      // åˆ—è¡¨æ ‡é¢˜
      Row({ space: 8 }) {
        Text('æ‰“å¡è®°å½•')
          .fontSize(18)
          .fontColor('#333333')
          .fontWeight(FontWeight.Bold)

        if (this.totalCheckins > 0) {
          Text(`å…±${this.totalCheckins}æ¬¡`)
            .fontSize(12)
            .fontColor('#666666')
            .backgroundColor('#F0F0F0')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(10)
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 16 })

      // è®°å½•åˆ—è¡¨
      if (this.checkinRecords.length > 0) {
        Column({ space: 0 }) {
          ForEach(this.checkinRecords, (record: CheckinRecordLocal, index: number) => {
            this.buildCheckinRecordItem(record, index)
          })
        }
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ left: 16, right: 16 })
        .shadow({ radius: 4, color: '#00000008' })

        // åŠ è½½æ›´å¤šæç¤º
        if (this.currentPage < this.totalPages) {
          Column() {
            if (this.isLoading) {
              LoadingProgress()
                .width(24)
                .height(24)
                .color('#007AFF')
                .margin({ bottom: 8 })

              Text('åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#666666')
            } else {
              Text('ç‚¹å‡»åŠ è½½æ›´å¤š')
                .fontSize(14)
                .fontColor('#007AFF')
                .padding({ top: 16, bottom: 16 })
                .onClick(() => {
                  this.loadMore();
                })
            }
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .margin({ top: 20, bottom: 20 })
        }
      } else {
        // ç©ºçŠ¶æ€
        Column({ space: 16 }) {
          Text('ğŸ“')
            .fontSize(60)
            .fontColor('#34C759')

          Text('æš‚æ— æ‰“å¡è®°å½•')
            .fontSize(16)
            .fontColor('#999999')

          Text('å¿«å»æ¢ç´¢æ™¯ç‚¹å¹¶æ‰“å¡å§ï¼')
            .fontSize(14)
            .fontColor('#CCCCCC')
        }
        .width('100%')
        .padding(40)
        .alignItems(HorizontalAlign.Center)
      }
    }
  }

  // æ„å»ºåŠ è½½çŠ¶æ€
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007AFF')

      Text('åŠ è½½æ‰“å¡æ•°æ®ä¸­...')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // æ„å»ºé”™è¯¯çŠ¶æ€
  @Builder
  buildErrorView() {
    Column({ space: 16 }) {
      Text('åŠ è½½å¤±è´¥')
        .fontSize(18)
        .fontColor('#FF3B30')
        .fontWeight(FontWeight.Medium)

      Text(this.errorMessage)
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .width('80%')

      Button('é‡æ–°åŠ è½½')
        .backgroundColor('#007AFF')
        .fontColor(Color.White)
        .fontSize(14)
        .width(120)
        .height(36)
        .onClick(() => {
          this.refreshData();
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .fontColor('#333333')
          .onClick(() => this.goBack())

        // æ ‡é¢˜
        Text('æ‰“å¡è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // åˆ·æ–°æŒ‰é’®
        Button('åˆ·æ–°')
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007AFF')
          .onClick(() => {
            this.refreshData();
          })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 0 }) {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (this.isLoading && !this.isRefreshing && this.checkinRecords.length === 0) {
            this.buildLoadingView()
          }
          // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
          else if (this.isError && this.checkinRecords.length === 0) {
            this.buildErrorView()
          }
          // æ˜¾ç¤ºæ­£å¸¸å†…å®¹
          else {
            // æ‰“å¡å¡ç‰‡
            Column() {
              this.buildCheckinCard()
            }
            .padding({ left: 16, right: 16, top: 20, bottom: 16 })

            // æ‰“å¡è®°å½•åˆ—è¡¨
            this.buildRecordsList()

            // åº•éƒ¨å®‰å…¨åŒºåŸŸå ä½
            Row()
              .height(40)
              .width('100%')
          }
        }
        .width('100%')
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}