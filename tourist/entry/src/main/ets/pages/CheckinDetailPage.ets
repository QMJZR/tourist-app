// entry/src/main/ets/pages/CheckinDetailPage.ets

import { router } from '@kit.ArkUI';
import { getCheckins, CheckinsApiResponse } from '../api/profile';

// æ‰“å¡è®°å½•ç±»å‹å®šä¹‰
interface CheckinRecordLocal {
  checkinId: number;
  spotId: number;
  spotName: string;
  images: Array<string>;
  pointsEarned: number;
  createdAt: string;
}

@Entry
@Component
struct CheckinDetailPage {
  @State totalCheckins: number = 0;  // æ€»æ‰“å¡æ¬¡æ•°
  @State checkinRecords: Array<CheckinRecordLocal> = [];  // æ‰“å¡è®°å½•åˆ—è¡¨
  @State currentPage: number = 1;  // å½“å‰é¡µç 
  @State totalPages: number = 1;  // æ€»é¡µæ•°

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;
  @State isError: boolean = false;
  @State errorMessage: string = '';
  @State apiFailed: boolean = false; // APIè°ƒç”¨å¤±è´¥æ ‡è®°

  // ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    console.log('æ‰“å¡è¯¦æƒ…é¡µé¢æ˜¾ç¤º');
    this.loadCheckinData();
  }

  // åŠ è½½æ‰“å¡æ•°æ®ï¼ˆä¼˜å…ˆè°ƒç”¨æ¥å£ï¼‰
  private async loadCheckinData() {
    if (this.isLoading) {
      return;
    }

    this.isLoading = true;
    this.isError = false;
    this.apiFailed = false;

    console.log('å¼€å§‹åŠ è½½æ‰“å¡æ•°æ®...');

    try {
      // å…ˆå°è¯•è°ƒç”¨æ¥å£è·å–æ•°æ®
      const response = await getCheckins(this.currentPage);

      // å…ˆè¿›è¡Œç±»å‹æ–­è¨€ï¼Œç¡®ä¿responseæ˜¯CheckinsApiResponseç±»å‹
      const typedResponse = response as CheckinsApiResponse;

      // æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
      if (typedResponse && typedResponse.code === 200 && typedResponse.data) {
        console.log('âœ… æ‰“å¡æ¥å£è°ƒç”¨æˆåŠŸï¼Œè·å–åˆ°', typedResponse.data.list.length, 'æ¡è®°å½•');
        this.processApiData(typedResponse);
        this.isLoading = false;
        this.isRefreshing = false;
        return;
      }

      // æ¥å£è°ƒç”¨å¤±è´¥çš„æƒ…å†µ
      console.warn('æ‰“å¡æ¥å£è¿”å›æ•°æ®å¼‚å¸¸ï¼Œä½¿ç”¨å‡æ•°æ®');
      this.apiFailed = true;

      // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ¶ˆæ¯
      if (typedResponse && typedResponse.msg) {
        this.errorMessage = typedResponse.msg;
      } else {
        this.errorMessage = 'æ¥å£è¿”å›æ•°æ®å¼‚å¸¸';
      }

    } catch (error) {
      console.error('æ‰“å¡æ¥å£è°ƒç”¨å¤±è´¥:', error);
      this.apiFailed = true;
      this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
    }

    // å¦‚æœæ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å‡æ•°æ®
    console.log('ä½¿ç”¨å‡æ•°æ®');
    this.useMockData();
  }

  // å¤„ç†APIè¿”å›çš„æ•°æ®
  private processApiData(response: CheckinsApiResponse) {
    if (!response.data || !response.data.list) {
      console.warn('APIè¿”å›æ•°æ®ä¸ºç©º');
      return;
    }

    const apiItems = response.data.list;
    console.log('å¤„ç†APIæ‰“å¡æ•°æ®:', apiItems);

    // å°†APIæ•°æ®è½¬æ¢ä¸ºé¡µé¢éœ€è¦çš„æ•°æ®æ ¼å¼
    const convertedRecords: CheckinRecordLocal[] = apiItems.map((item, index) => {
      // æ˜ç¡®åˆ›å»ºç¬¦åˆ CheckinRecordLocal æ¥å£çš„å¯¹è±¡
      const record: CheckinRecordLocal = {
        checkinId: item.checkinId || (index + 101),
        spotId: item.spotId || index + 1,
        spotName: item.spotName || `æ™¯ç‚¹${index + 1}`,
        images: item.images || [],
        pointsEarned: item.pointsEarned || Math.floor(Math.random() * 50) + 10,
        createdAt: item.createdAt || this.generateMockTime(index)
      };

      return record;
    });

    // å¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼Œç›´æ¥è®¾ç½®æ•°æ®
    if (this.currentPage === 1) {
      this.checkinRecords = convertedRecords;
    } else {
      // å¦åˆ™è¿½åŠ æ•°æ®
      this.checkinRecords = [...this.checkinRecords, ...convertedRecords];
    }

    // æ›´æ–°æ€»æ•°å’Œé¡µæ•°
    this.totalCheckins = response.data.total || convertedRecords.length;
    const pageSize = 10; // æ¯é¡µ10æ¡
    this.totalPages = Math.ceil(this.totalCheckins / pageSize);

    console.log('æ•°æ®è½¬æ¢å®Œæˆï¼Œå…±', this.checkinRecords.length, 'æ¡è®°å½•ï¼Œæ€»', this.totalCheckins, 'æ¬¡');
  }

  // ç”Ÿæˆæ¨¡æ‹Ÿæ—¶é—´
  private generateMockTime(index: number): string {
    const now = new Date();
    const daysAgo = Math.floor(index / 2); // æ¯ä¸¤æ¡è®°å½•é—´éš”ä¸€å¤©
    const date = new Date(now.getTime() - daysAgo * 24 * 60 * 60 * 1000);

    const hours = 9 + (index % 8); // 9ç‚¹åˆ°17ç‚¹ä¹‹é—´
    const minutes = (index * 7) % 60;
    const seconds = (index * 11) % 60;

    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  // ä½¿ç”¨å‡æ•°æ®
  private useMockData() {
    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      try {
        // ç”Ÿæˆå‡æ•°æ®
        this.generateMockData();
        console.log(`âœ… ä½¿ç”¨å‡æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±${this.totalCheckins}æ¡è®°å½•ï¼Œå½“å‰ç¬¬${this.currentPage}é¡µ`);
      } catch (error) {
        this.isError = true;
        this.errorMessage = 'åŠ è½½æ‰“å¡æ•°æ®å¤±è´¥';
        console.error('è·å–æ‰“å¡æ•°æ®å¼‚å¸¸:', error);
      } finally {
        this.isLoading = false;
        this.isRefreshing = false;
      }
    }, 800);
  }

  // ç”Ÿæˆå‡æ•°æ®ï¼ˆä¿ç•™åŸæœ‰çš„å‡æ•°æ®ç”Ÿæˆé€»è¾‘ï¼‰
  private generateMockData() {
    const mockRecords: Array<CheckinRecordLocal> = [
      {
        checkinId: 101,
        spotId: 1,
        spotName: 'å¤å»ºç­‘ç¾¤',
        images: ['https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w=800&auto=format&fit=crop'],
        pointsEarned: 50,
        createdAt: '2025-12-14 14:30:25'
      },
      {
        checkinId: 102,
        spotId: 2,
        spotName: 'ç‰¹è‰²ç¾é£Ÿè¡—',
        images: ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&auto=format&fit=crop'],
        pointsEarned: 30,
        createdAt: '2025-12-13 11:20:15'
      },
      {
        checkinId: 103,
        spotId: 3,
        spotName: 'ç”Ÿæ€æ¹¿åœ°å…¬å›­',
        images: ['https://images.unsplash.com/photo-1501854140801-50d01698950b?w=800&auto=format&fit=crop'],
        pointsEarned: 40,
        createdAt: '2025-12-12 16:45:33'
      },
      {
        checkinId: 104,
        spotId: 4,
        spotName: 'è‰ºæœ¯ç”»å»Š',
        images: ['https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=800&auto=format&fit=crop'],
        pointsEarned: 35,
        createdAt: '2025-12-11 10:15:42'
      },
      {
        checkinId: 105,
        spotId: 5,
        spotName: 'å„¿ç«¥æ¸¸ä¹åœº',
        images: ['https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=800&auto=format&fit=crop'],
        pointsEarned: 25,
        createdAt: '2025-12-10 15:50:18'
      },
      {
        checkinId: 106,
        spotId: 6,
        spotName: 'ç§‘æŠ€ä½“éªŒé¦†',
        images: ['https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&auto=format&fit=crop'],
        pointsEarned: 60,
        createdAt: '2025-12-09 13:25:59'
      },
      {
        checkinId: 107,
        spotId: 7,
        spotName: 'åŸå¸‚å…¬å›­',
        images: ['https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&auto=format&fit=crop'],
        pointsEarned: 20,
        createdAt: '2025-12-08 09:40:12'
      },
      {
        checkinId: 108,
        spotId: 8,
        spotName: 'è´­ç‰©ä¸­å¿ƒ',
        images: ['https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800&auto=format&fit=crop'],
        pointsEarned: 15,
        createdAt: '2025-12-07 18:30:27'
      },
      {
        checkinId: 109,
        spotId: 1,
        spotName: 'å¤å»ºç­‘ç¾¤',
        images: ['https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w=800&auto=format&fit=crop'],
        pointsEarned: 45,
        createdAt: '2025-12-06 14:20:38'
      },
      {
        checkinId: 110,
        spotId: 2,
        spotName: 'ç‰¹è‰²ç¾é£Ÿè¡—',
        images: ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&auto=format&fit=crop'],
        pointsEarned: 35,
        createdAt: '2025-12-05 12:15:22'
      }
    ];

    // æ ¹æ®å½“å‰é¡µç åŠ è½½æ•°æ®
    const pageSize = 10;  // æ¯é¡µ10æ¡

    if (this.currentPage === 1) {
      // ç¬¬ä¸€é¡µï¼šæ˜¾ç¤ºå‰10æ¡æ•°æ®
      this.checkinRecords = mockRecords.slice(0, Math.min(pageSize, mockRecords.length));
    } else if (this.currentPage === 2) {
      // ç¬¬äºŒé¡µï¼šæ˜¾ç¤ºæ›´å¤šå‡æ•°æ®
      const moreMockRecords: Array<CheckinRecordLocal> = [
        {
          checkinId: 111,
          spotId: 3,
          spotName: 'ç”Ÿæ€æ¹¿åœ°å…¬å›­',
          images: ['https://images.unsplash.com/photo-1501854140801-50d01698950b?w=800&auto=format&fit=crop'],
          pointsEarned: 40,
          createdAt: '2025-12-04 16:10:55'
        },
        {
          checkinId: 112,
          spotId: 4,
          spotName: 'è‰ºæœ¯ç”»å»Š',
          images: ['https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=800&auto=format&fit=crop'],
          pointsEarned: 35,
          createdAt: '2025-12-03 11:45:19'
        },
        {
          checkinId: 113,
          spotId: 5,
          spotName: 'å„¿ç«¥æ¸¸ä¹åœº',
          images: ['https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=800&auto=format&fit=crop'],
          pointsEarned: 25,
          createdAt: '2025-12-02 14:30:44'
        },
        {
          checkinId: 114,
          spotId: 6,
          spotName: 'ç§‘æŠ€ä½“éªŒé¦†',
          images: ['https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&auto=format&fit=crop'],
          pointsEarned: 60,
          createdAt: '2025-12-01 10:20:33'
        }
      ];
      this.checkinRecords = [...this.checkinRecords, ...moreMockRecords];
    }

    // æ›´æ–°æ€»æ•°
    this.totalCheckins = this.currentPage === 1 ? 24 : 14; // æ¨¡æ‹Ÿæ€»æ•°æ®é‡å˜åŒ–

    // è®¡ç®—æ€»é¡µæ•°
    this.totalPages = Math.ceil(this.totalCheckins / pageSize);
  }

  // åˆ·æ–°æ•°æ®
  private refreshData() {
    this.currentPage = 1;
    this.isRefreshing = true;
    this.loadCheckinData();
  }

  // åŠ è½½æ›´å¤š
  private async loadMore() {
    if (this.isLoading || this.currentPage >= this.totalPages) {
      return;
    }

    this.currentPage += 1;
    this.isLoading = true;

    // å¦‚æœAPIä¹‹å‰å¤±è´¥äº†ï¼Œç›´æ¥ä½¿ç”¨å‡æ•°æ®
    if (this.apiFailed) {
      setTimeout(() => {
        try {
          this.generateMockData();
          console.log(`âœ… åŠ è½½æ›´å¤šæˆåŠŸï¼Œå½“å‰å…±${this.checkinRecords.length}æ¡è®°å½•`);
        } catch (error) {
          console.error('åŠ è½½æ›´å¤šå¼‚å¸¸:', error);
          // å›é€€é¡µç 
          this.currentPage -= 1;
        } finally {
          this.isLoading = false;
        }
      }, 800);
      return;
    }

    // å¦åˆ™å°è¯•è°ƒç”¨API
    try {
      const response = await getCheckins(this.currentPage);

      // ä½¿ç”¨ç±»å‹æ–­è¨€
      const typedResponse = response as CheckinsApiResponse;

      // ä½¿ç”¨ç±»å‹æ£€æŸ¥
      if (typedResponse && typedResponse.code === 200 && typedResponse.data) {
        console.log('âœ… åŠ è½½æ›´å¤šæ¥å£è°ƒç”¨æˆåŠŸ');
        this.processApiData(typedResponse);
      } else {
        console.warn('åŠ è½½æ›´å¤šæ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
        this.generateMockData();
      }
    } catch (error) {
      console.error('åŠ è½½æ›´å¤šæ¥å£è°ƒç”¨å¼‚å¸¸:', error);
      // å›é€€é¡µç 
      this.currentPage -= 1;
    } finally {
      this.isLoading = false;
    }
  }

  // æ„å»ºAPIå¤±è´¥æç¤º
  @Builder
  buildApiFailNotice() {
    if (this.apiFailed && !this.isLoading) {
      Row({ space: 8 }) {
        Text('âš ï¸')
          .fontSize(14)
          .fontColor('#FF9500')

        Text('æ¥å£è°ƒç”¨å¤±è´¥ï¼Œå·²æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®')
          .fontSize(12)
          .fontColor('#666666')
          .layoutWeight(1)

        Button('é‡è¯•')
          .fontSize(12)
          .backgroundColor('#007AFF10')
          .borderRadius(8)
          .padding({ left: 8, right: 8 })
          .height(24)
          .onClick(() => {
            console.log('ç‚¹å‡»é‡è¯•æ¥å£');
            this.refreshData();
          })
      }
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor('#FFF8E6')
      .borderRadius(8)
      .margin({ left: 16, right: 16, top: 8 })
      .shadow({ radius: 2, color: '#00000004' })
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´ï¼ˆå»æ‰ç§’ï¼‰
  private formatTime(createdAt: string): string {
    if (!createdAt) return '';
    // å°† "2025-01-11 14:20:33" æ ¼å¼åŒ–ä¸º "2025-01-11 14:20"
    if (createdAt.length >= 16) {
      return createdAt.substring(0, 16);
    }
    return createdAt;
  }

  // æ„å»ºæ‰“å¡å¡ç‰‡
  @Builder
  buildCheckinCard() {
    Column({ space: 12 }) {
      // æ‰“å¡æ ‡é¢˜
      Text('æˆ‘çš„æ‰“å¡')
        .fontSize(16)
        .fontColor('#666666')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Start)
        .width('100%')

      // æ‰“å¡æ•°å€¼
      Row({ space: 8 }) {
        Text(this.totalCheckins.toString())
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor('#34C759')

        Text('æ¬¡')
          .fontSize(16)
          .fontColor('#666666')
          .margin({ top: 20 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)

      // æ‰“å¡è¯´æ˜
      Text('æ‰“å¡å¯ä»¥èµšå–ç§¯åˆ†ï¼Œè§£é”æ›´å¤šæ—…è¡Œæˆå°±')
        .fontSize(14)
        .fontColor('#999999')
        .textAlign(TextAlign.Start)
        .width('100%')
        .margin({ top: 8 })
    }
    .padding({ left: 24, right: 24, top: 28, bottom: 28 })
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({ radius: 8, color: '#34C75910' })
  }

  // æ„å»ºæ‰“å¡è®°å½•é¡¹
  @Builder
  buildCheckinRecordItem(record: CheckinRecordLocal, index: number) {
    Column() {
      Row({ space: 16 }) {
        // å·¦ä¾§ï¼šæ‰“å¡å›¾æ ‡
        Column() {
          Text('ğŸ“')
            .fontSize(20)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#34C759')
        .borderRadius(20)

        // ä¸­é—´ï¼šè¯¦æƒ…
        Column({ space: 4 }) {
          // æ™¯ç‚¹åç§°
          Text(record.spotName || 'æœªçŸ¥æ™¯ç‚¹')
            .fontSize(16)
            .fontColor('#333333')
            .fontWeight(FontWeight.Medium)
            .textAlign(TextAlign.Start)
            .width('100%')

          // æ—¶é—´å’Œç§¯åˆ†
          Row({ space: 12 }) {
            Text(this.formatTime(record.createdAt))
              .fontSize(13)
              .fontColor('#999999')

            Text(`+${record.pointsEarned || 0}ç§¯åˆ†`)
              .fontSize(13)
              .fontColor('#FF9500')
              .backgroundColor('#FFF4E6')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)
          }
          .width('100%')
        }
        .layoutWeight(1)

        // å³ä¾§ï¼šå›¾ç‰‡é¢„è§ˆï¼ˆå¦‚æœæœ‰å›¾ç‰‡ï¼‰
        if (record.images && record.images.length > 0 && record.images[0]) {
          Image(record.images[0])
            .width(40)
            .height(40)
            .objectFit(ImageFit.Cover)
            .borderRadius(8)
        } else {
          // é»˜è®¤å›¾ç‰‡å ä½
          Column() {
            Text('ğŸ“·')
              .fontSize(20)
              .fontColor('#999999')
          }
          .width(40)
          .height(40)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#F0F0F0')
          .borderRadius(8)
        }
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })

      // åˆ†éš”çº¿ï¼ˆä¸æ˜¯æœ€åä¸€é¡¹æ—¶æ˜¾ç¤ºï¼‰
      if (index < this.checkinRecords.length - 1) {
        Divider()
          .color('#F0F0F0')
          .margin({ left: 72, right: 16 })
          .strokeWidth(0.5)
      }
    }
  }

  // æ„å»ºè®°å½•åˆ—è¡¨
  @Builder
  buildRecordsList() {
    Column() {
      // APIå¤±è´¥æç¤º
      this.buildApiFailNotice()

      // åˆ—è¡¨æ ‡é¢˜
      Row({ space: 8 }) {
        Text('æ‰“å¡è®°å½•')
          .fontSize(18)
          .fontColor('#333333')
          .fontWeight(FontWeight.Bold)

        if (this.totalCheckins > 0) {
          Text(`å…±${this.totalCheckins}æ¬¡`)
            .fontSize(12)
            .fontColor('#666666')
            .backgroundColor('#F0F0F0')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(10)
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 16 })

      // è®°å½•åˆ—è¡¨
      if (this.checkinRecords.length > 0) {
        Column({ space: 0 }) {
          ForEach(this.checkinRecords, (record: CheckinRecordLocal, index: number) => {
            this.buildCheckinRecordItem(record, index)
          })
        }
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ left: 16, right: 16 })
        .shadow({ radius: 4, color: '#00000008' })

        // åŠ è½½æ›´å¤šæç¤º
        if (this.currentPage < this.totalPages) {
          Column() {
            if (this.isLoading) {
              LoadingProgress()
                .width(24)
                .height(24)
                .color('#007AFF')
                .margin({ bottom: 8 })

              Text('åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#666666')
            } else {
              Text('ç‚¹å‡»åŠ è½½æ›´å¤š')
                .fontSize(14)
                .fontColor('#007AFF')
                .padding({ top: 16, bottom: 16 })
                .onClick(() => {
                  this.loadMore();
                })
            }
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .margin({ top: 20, bottom: 20 })
        }
      } else {
        // ç©ºçŠ¶æ€
        Column({ space: 16 }) {
          Text('ğŸ“')
            .fontSize(60)
            .fontColor('#34C759')

          Text('æš‚æ— æ‰“å¡è®°å½•')
            .fontSize(16)
            .fontColor('#999999')

          Text('å¿«å»æ¢ç´¢æ™¯ç‚¹å¹¶æ‰“å¡å§ï¼')
            .fontSize(14)
            .fontColor('#CCCCCC')
        }
        .width('100%')
        .padding(40)
        .alignItems(HorizontalAlign.Center)
      }
    }
  }

  // æ„å»ºåŠ è½½çŠ¶æ€
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007AFF')

      Text('åŠ è½½æ‰“å¡æ•°æ®ä¸­...')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // æ„å»ºé”™è¯¯çŠ¶æ€
  @Builder
  buildErrorView() {
    Column({ space: 16 }) {
      Text('åŠ è½½å¤±è´¥')
        .fontSize(18)
        .fontColor('#FF3B30')
        .fontWeight(FontWeight.Medium)

      Text(this.errorMessage)
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .width('80%')

      Button('é‡æ–°åŠ è½½')
        .backgroundColor('#007AFF')
        .fontColor(Color.White)
        .fontSize(14)
        .width(120)
        .height(36)
        .onClick(() => {
          this.refreshData();
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .fontColor('#333333')
          .onClick(() => this.goBack())

        // æ ‡é¢˜
        Text('æ‰“å¡è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // åˆ·æ–°æŒ‰é’®
        Button('åˆ·æ–°')
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007AFF')
          .onClick(() => {
            this.refreshData();
          })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 0 }) {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (this.isLoading && !this.isRefreshing && this.checkinRecords.length === 0) {
            this.buildLoadingView()
          }
          // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
          else if (this.isError && this.checkinRecords.length === 0) {
            this.buildErrorView()
          }
          // æ˜¾ç¤ºæ­£å¸¸å†…å®¹
          else {
            // æ‰“å¡å¡ç‰‡
            Column() {
              this.buildCheckinCard()
            }
            .padding({ left: 16, right: 16, top: 20, bottom: 16 })

            // æ‰“å¡è®°å½•åˆ—è¡¨
            this.buildRecordsList()

            // åº•éƒ¨å®‰å…¨åŒºåŸŸå ä½
            Row()
              .height(40)
              .width('100%')
          }
        }
        .width('100%')
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}