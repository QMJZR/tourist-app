// entry/src/main/ets/pages/ProfilePage.ets

import router from '@ohos.router';
// ç”¨æˆ·ä¿¡æ¯æ¥å£
import {getProfile} from "../api/user";

interface UserData {
  userId: number;
  username: string;
  nickname: string;
  avatar: string;
  points: number;
  checkinCount: number;
  isMerchant: string;
  checkinSpotIds: number[];  // æ•°ç»„ç±»å‹
  email: string;
}
interface UserInfo {
  nickname:string;
  avatar:string;
  email:string;
}
// åŠŸèƒ½é¡¹æ¥å£
interface FunctionItem {
  id: string;
  icon: string;
  title: string;
  subtitle?: string;
  showArrow: boolean;
  route?: string;
}

@Entry
@Component
export default struct ProfilePage {
  // ç”¨æˆ·ä¿¡æ¯ï¼ˆå†™æ­»å‡æ•°æ®ï¼‰
  @State userInfo: UserInfo = {
    nickname: 'æ—…è¡Œçˆ±å¥½è€…',
    avatar: 'https://avatars.githubusercontent.com/u/1?v=4',
    email: 'traveler@example.com'
  };

  // åŠŸèƒ½åˆ—è¡¨ï¼ˆå†™æ­»å‡æ•°æ®ï¼‰
  @State functionList: FunctionItem[] = [
    { id: 'checkin', icon: 'ğŸ“', title: 'æ‰“å¡è®°å½•', subtitle: 'æŸ¥çœ‹æ‚¨çš„æ‰“å¡å†å²', showArrow: true, route: 'checkin_history' },
    { id: 'points', icon: 'â­', title: 'ç§¯åˆ†', subtitle: 'å½“å‰ç§¯åˆ†ï¼š2560', showArrow: true, route: 'points' },
    { id: 'gifts', icon: 'ğŸ', title: 'æˆ‘çš„ç¤¼å“', subtitle: 'å·²å…‘æ¢3ä¸ªç¤¼å“', showArrow: true, route: 'gifts' },
    { id: 'edit', icon: 'âœï¸', title: 'ä¿®æ”¹ä¸ªäººä¿¡æ¯', showArrow: true, route: 'edit_profile' }
  ];

  // å…¶ä»–åŠŸèƒ½é¡¹
  @State otherFunctions: FunctionItem[] = [
    { id: 'settings', icon: 'âš™ï¸', title: 'è®¾ç½®', showArrow: true, route: 'settings' },
    { id: 'help', icon: 'â“', title: 'å¸®åŠ©', showArrow: true, route: 'assistant' }
  ];

  // ==================== æ„å»ºæ–¹æ³• ====================

  build() {
    Column() {
      // 1. é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
      this.buildUserCard()

      // 2. ä¸»è¦åŠŸèƒ½åˆ—è¡¨
      this.buildFunctionList()

      // 3. å…¶ä»–åŠŸèƒ½åˆ—è¡¨
      this.buildOtherFunctions()

      // 4. é€€å‡ºç™»å½•æŒ‰é’®
      this.buildLogoutButton()

      // ======== æ–°å¢çš„æµ‹è¯•æŒ‰é’® ========
      // 4. æµ‹è¯•è·å–ç”¨æˆ·èµ„æ–™æŒ‰é’®
      this.buildTestProfileButton()
      // ==============================

      // 5. åº•éƒ¨å®‰å…¨åŒºåŸŸå ä½
      Row()
        .height(60)
        .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // ==================== æ–°å¢çš„æ„å»ºå™¨æ–¹æ³• ====================

  @Builder
  buildTestProfileButton() {
    Column() {
      Text('æµ‹è¯•è·å–ç”¨æˆ·èµ„æ–™')
        .fontSize(16)
        .fontColor('#007AFF')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .width('100%')
        .height(50)
        .backgroundColor(Color.White)
        .borderRadius(10)
        .onClick(() => {
          this.onTestProfileClick();
        })
    }
    .margin({ left: 15, right: 15, top: 10, bottom: 10 })
  }

  // ==================== æ–°å¢çš„äº‹ä»¶å¤„ç†æ–¹æ³• ====================

  // æµ‹è¯•è·å–ç”¨æˆ·èµ„æ–™ç‚¹å‡»
  private onTestProfileClick() {
    console.log('ç‚¹å‡»æµ‹è¯•è·å–ç”¨æˆ·èµ„æ–™æŒ‰é’®');

    // è°ƒç”¨ getProfile æ–¹æ³•
    getProfile().then((response) => {
      console.log("you clicked getProfile btn!");
      console.log('è·å–ç”¨æˆ·èµ„æ–™æˆåŠŸ:', response);
      //   if (response) {
      //
      //
      //     // å¦‚æœè·å–æˆåŠŸï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
      //     if (response.code === 200 && response.data) {
      //       this.userInfo = {
      //         nickname: response.data.nickname || this.userInfo.nickname,
      //         avatar: response.data.avatar || this.userInfo.avatar,
      //         email: response.data.email || this.userInfo.email
      //       };
      //       console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°');
      //     } else {
      //       console.log('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', response.message);
      //     }
      //   } else {
      //     console.log('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥: è¿”å›ç©ºå“åº”');
      //   }
      // }).catch((error) => {
      //   console.error('è·å–ç”¨æˆ·èµ„æ–™å¼‚å¸¸:', error);
      // });
    });
  }
  // ==================== é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ ====================

  @Builder
  buildUserCard() {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ - ç®€æ´ç™½è‰²è®¾è®¡
      Column({ space: 20 }) {
        // å¤´åƒå’Œç”¨æˆ·ä¿¡æ¯è¡Œ
        Row({ space: 15 }) {
          // å·¦ä¾§å¤´åƒ
          Column() {
            // å¤´åƒå›¾ç‰‡
            Image($r('app.media.startIcon'))
              .width(80)
              .height(80)
              .objectFit(ImageFit.Cover)
              .borderRadius(40)
              .border({ width: 2, color: '#F0F0F0' })
              .shadow({ radius: 4, color: '#00000010' })
          }
          .width(80)
          .height(80)

          // å³ä¾§ç”¨æˆ·ä¿¡æ¯
          Column({ space: 8 }) {
            // ç”¨æˆ·æ˜µç§°
            Text(this.userInfo.nickname)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .textAlign(TextAlign.Start)
              .width('100%')

            // ç”¨æˆ·é‚®ç®±
            Text(this.userInfo.email)
              .fontSize(15)
              .fontColor('#666666')
              .textAlign(TextAlign.Start)
              .width('100%')
          }
          .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 25, bottom: 25 })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({ radius: 4, color: '#00000008' })
      .margin({ left: 15, right: 15, top: 15, bottom: 20 })
    }
    .width('100%')
  }

  // ==================== åŠŸèƒ½åˆ—è¡¨ ====================

  @Builder
  buildFunctionList() {
    Column() {
      ForEach(this.functionList, (item: FunctionItem) => {
        this.buildFunctionItem(item)
      })
    }
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 15, right: 15, bottom: 15 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  @Builder
  buildOtherFunctions() {
    Column() {
      ForEach(this.otherFunctions, (item: FunctionItem) => {
        this.buildFunctionItem(item)
      })
    }
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 15, right: 15, bottom: 15 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  @Builder
  buildFunctionItem(item: FunctionItem) {
    Column() {
      Row({ space: 12 }) {
        // å·¦ä¾§å›¾æ ‡
        Text(item.icon)
          .fontSize(20)
          .width(24)
          .textAlign(TextAlign.Center)

        // æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
        Column({ space: 2 }) {
          Text(item.title)
            .fontSize(16)
            .fontColor('#333333')
            .textAlign(TextAlign.Start)
            .width('100%')

          if (item.subtitle) {
            Text(item.subtitle)
              .fontSize(13)
              .fontColor('#666666')
              .textAlign(TextAlign.Start)
              .width('100%')
          }
        }
        .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´

        // å³ä¾§ç®­å¤´
        if (item.showArrow) {
          Text('â€º')
            .fontSize(20)
            .fontColor('#999999')
            .margin({ right: 5 })
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 12 })
      .backgroundColor(Color.White)
      .onClick(() => {
        this.onFunctionItemClick(item);
      })

      // åˆ†éš”çº¿ï¼ˆä¸æ˜¯æœ€åä¸€é¡¹æ—¶æ˜¾ç¤ºï¼‰
      if (item.id !== this.functionList[this.functionList.length - 1]?.id &&
        item.id !== this.otherFunctions[this.otherFunctions.length - 1]?.id) {
        Divider()
          .color('#F0F0F0')
          .margin({ left: 52, right: 0 })
          .strokeWidth(0.5)
      }
    }
  }

  // ==================== é€€å‡ºç™»å½•æŒ‰é’® ====================

  @Builder
  buildLogoutButton() {
    Column() {
      Text('é€€å‡ºç™»å½•')
        .fontSize(16)
        .fontColor('#FF3B30')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .width('100%')
        .height(50)
        .backgroundColor(Color.White)
        .borderRadius(10)
        .onClick(() => {
          this.onLogoutClick();
        })
    }
    .margin({ left: 15, right: 15, top: 10, bottom: 30 })
  }

  // ==================== ç‚¹å‡»äº‹ä»¶å¤„ç† ====================

  // åŠŸèƒ½é¡¹ç‚¹å‡»
  private onFunctionItemClick(item: FunctionItem) {
    console.log(`ç‚¹å‡»åŠŸèƒ½é¡¹: ${item.title} (ID: ${item.id})`);

    switch (item.id) {
      case 'checkin':
        this.onCheckinRecordClick();
        break;
      case 'points':
        this.onPointsClick();
        break;
      case 'gifts':
        this.onGiftsClick();
        break;
      case 'edit':
        this.onEditProfileClick();
        break;
      case 'settings':
        this.onSettingsClick();
        break;
      case 'help':  // æ–°å¢case
        this.onHelpClick();
        break;
    }
  }


  // ç¼–è¾‘ä¸ªäººä¿¡æ¯ç‚¹å‡» - ç‚¹å‡»"ä¿®æ”¹ä¸ªäººä¿¡æ¯"åŠŸèƒ½é¡¹æ—¶è°ƒç”¨
  private onEditProfileClick() {
    console.log('ç‚¹å‡»ä¿®æ”¹ä¸ªäººä¿¡æ¯ï¼Œè·³è½¬åˆ°ç¼–è¾‘é¡µé¢');
    // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°ä¿®æ”¹ä¸ªäººä¿¡æ¯é¡µé¢
    // æ‰€æœ‰ç¼–è¾‘æ“ä½œï¼ˆå¤´åƒã€æ˜µç§°ã€é‚®ç®±ï¼‰éƒ½åœ¨é‚£ä¸ªé¡µé¢å®Œæˆ
  }

  // æ‰“å¡è®°å½•ç‚¹å‡»
  private onCheckinRecordClick() {
    console.log('ç‚¹å‡»æ‰“å¡è®°å½•');
  }

  // ç§¯åˆ†ç‚¹å‡»
  private onPointsClick() {
    console.log('ç‚¹å‡»ç§¯åˆ†');
  }

  // æˆ‘çš„ç¤¼å“ç‚¹å‡»
  private onGiftsClick() {
    console.log('ç‚¹å‡»æˆ‘çš„ç¤¼å“');
  }

  // è®¾ç½®ç‚¹å‡»
  private onSettingsClick() {
    console.log('ç‚¹å‡»è®¾ç½®');
  }

  // å¸®åŠ©ç‚¹å‡»
  private onHelpClick(): void {
    console.log('ç‚¹å‡»å¸®åŠ©ï¼Œè·³è½¬åˆ°æ™ºèƒ½é—®ç­”ç•Œé¢');

    // æ˜ç¡®æŒ‡å®šç±»å‹
    const promise: Promise<void> = router.pushUrl({
      url: 'pages/AssistantPage',
      params: {
        from: 'profile',
        timestamp: new Date().getTime()
      }
    });

    promise.then((): void => {
      console.log('æˆåŠŸè·³è½¬åˆ°åŠ©æ‰‹é¡µé¢');
    }).catch((error: Error): void => {
      console.error('è·³è½¬å¤±è´¥:', error.message);
    });
  }

  // é€€å‡ºç™»å½•ç‚¹å‡»
  private onLogoutClick() {
    console.log('ç‚¹å‡»é€€å‡ºç™»å½•');
    setTimeout(() => {
      console.log('é€€å‡ºç™»å½•æˆåŠŸ');
    }, 1000);
  }

  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================

  aboutToAppear() {
    console.log('ä¸ªäººä¸­å¿ƒé¡µé¢æ˜¾ç¤º');
    this.loadUserInfo();
  }

  aboutToDisappear() {
    console.log('ä¸ªäººä¸­å¿ƒé¡µé¢éšè—');
  }

  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  private loadUserInfo() {
    console.log('åŠ è½½ç”¨æˆ·ä¿¡æ¯...');
    setTimeout(() => {
      console.log('ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆ');
    }, 500);
  }
}