// entry/src/main/ets/pages/ProfilePage.ets

import router from '@ohos.router';
// ç”¨æˆ·ä¿¡æ¯æ¥å£
import {getProfile} from "../api/user";

interface UserData {
  userId: number;
  username: string;
  nickname: string;
  avatar: string;
  points: number;
  checkinCount: number;
  isMerchant: string;
  checkinSpotIds: number[];  // æ•°ç»„ç±»å‹
  email: string;
}

interface UserInfo {
  nickname: string;
  avatar: string;
  email: string;
}

// åŠŸèƒ½é¡¹æ¥å£
interface FunctionItem {
  id: string;
  icon: string;
  title: string;
  subtitle?: string;
  showArrow: boolean;
  route?: string;
}

@Entry
@Component
export default struct ProfilePage {
  // ç”¨æˆ·ä¿¡æ¯ - åˆå§‹åŒ–ä¸ºå‡æ•°æ®
  @State userInfo: UserInfo = {
    nickname: 'æ—…è¡Œçˆ±å¥½è€…',
    avatar: 'https://avatars.githubusercontent.com/u/1?v=4',
    email: 'traveler@example.com'
  };

  // ç”¨æˆ·å - æ–°å¢çŠ¶æ€ï¼Œç”¨äºæ˜¾ç¤ºç”¨æˆ·å
  @State username: string = '';

  // ç”¨æˆ·ç§¯åˆ†å’Œæ‰“å¡æ•°æ®
  @State userPoints: number = 0;  // ä¿®æ”¹ï¼šé»˜è®¤ç§¯åˆ†è®¾ä¸º0
  @State userCheckinCount: number = 0;
  @State userId: number = 0;

  // æ•°æ®åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State isError: boolean = false;
  @State errorMessage: string = '';

  // åŠŸèƒ½åˆ—è¡¨ - ä¿®æ”¹ï¼šæˆ‘çš„ç¤¼å“å»æ‰å‰¯æ ‡é¢˜
  @State functionList: FunctionItem[] = [
    { id: 'checkin', icon: 'ğŸ“', title: 'æ‰“å¡è®°å½•', subtitle: 'æŸ¥çœ‹æ‚¨çš„æ‰“å¡å†å²', showArrow: true, route: 'checkin_history' },
    { id: 'points', icon: 'â­', title: 'ç§¯åˆ†', subtitle: 'å½“å‰ç§¯åˆ†ï¼š0', showArrow: true, route: 'points' },  // ä¿®æ”¹ï¼šç§¯åˆ†ä»0å¼€å§‹
    { id: 'gifts', icon: 'ğŸ', title: 'æˆ‘çš„ç¤¼å“', showArrow: true, route: 'gifts' },  // ä¿®æ”¹ï¼šç§»é™¤å‰¯æ ‡é¢˜
    { id: 'edit', icon: 'âœï¸', title: 'ä¿®æ”¹ä¸ªäººä¿¡æ¯', showArrow: true, route: 'edit_profile' }
  ];

  // å…¶ä»–åŠŸèƒ½é¡¹
  @State otherFunctions: FunctionItem[] = [
    { id: 'settings', icon: 'âš™ï¸', title: 'è®¾ç½®', showArrow: true, route: 'settings' },
    { id: 'help', icon: 'â“', title: 'å¸®åŠ©', showArrow: true, route: 'assistant' }
  ];

  // ==================== æ„å»ºæ–¹æ³• ====================

  build() {
    Column() {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      if (this.isLoading) {
        this.buildLoadingView()
      } else {
        // 1. é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
        this.buildUserCard()

        // 2. ä¸»è¦åŠŸèƒ½åˆ—è¡¨
        this.buildFunctionList()

        // 3. å…¶ä»–åŠŸèƒ½åˆ—è¡¨
        this.buildOtherFunctions()

        // 4. é€€å‡ºç™»å½•æŒ‰é’®
        this.buildLogoutButton()

        // 5. åº•éƒ¨å®‰å…¨åŒºåŸŸå ä½
        Row()
          .height(60)
          .width('100%')
      }

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      if (this.isError) {
        this.buildErrorView()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // ==================== æ–°å¢æ„å»ºå™¨æ–¹æ³• ====================

  // åŠ è½½è§†å›¾
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007AFF')

      Text('æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // é”™è¯¯è§†å›¾
  @Builder
  buildErrorView() {
    Column() {
      Text('åŠ è½½å¤±è´¥')
        .fontSize(16)
        .fontColor('#FF3B30')
        .margin({ bottom: 8 })

      Text(this.errorMessage)
        .fontSize(14)
        .fontColor('#666666')
        .margin({ bottom: 16 })

      Button('é‡è¯•')
        .backgroundColor('#007AFF')
        .fontColor(Color.White)
        .fontSize(14)
        .width(120)
        .height(36)
        .onClick(() => {
          this.loadUserInfo();
        })
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFF3F3')
    .borderRadius(12)
    .margin({ top: 10, bottom: 10, left: 15, right: 15 })
  }

  // ==================== é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ ====================

  @Builder
  buildUserCard() {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ - ç®€æ´ç™½è‰²è®¾è®¡
      Column({ space: 20 }) {
        // å¤´åƒå’Œç”¨æˆ·ä¿¡æ¯è¡Œ
        Row({ space: 15 }) {
          // å·¦ä¾§å¤´åƒ
          Column() {
            // å¦‚æœæœåŠ¡å™¨è¿”å›äº†å¤´åƒURLï¼Œä½¿ç”¨è¿œç¨‹å›¾ç‰‡ï¼Œå¦åˆ™ä½¿ç”¨æœ¬åœ°å›¾ç‰‡
            if (this.userInfo.avatar && this.userInfo.avatar !== 'https://avatars.githubusercontent.com/u/1?v=4') {
              // ä½¿ç”¨ç½‘ç»œå›¾ç‰‡
              Image(this.userInfo.avatar)
                .width(80)
                .height(80)
                .objectFit(ImageFit.Cover)
                .borderRadius(40)
                .border({ width: 2, color: '#F0F0F0' })
                .shadow({ radius: 4, color: '#00000010' })
            } else {
              // ä½¿ç”¨æœ¬åœ°é»˜è®¤å¤´åƒ
              Image($r('app.media.startIcon'))
                .width(80)
                .height(80)
                .objectFit(ImageFit.Cover)
                .borderRadius(40)
                .border({ width: 2, color: '#F0F0F0' })
                .shadow({ radius: 4, color: '#00000010' })
            }
          }
          .width(80)
          .height(80)

          // å³ä¾§ç”¨æˆ·ä¿¡æ¯
          Column({ space: 8 }) {
            // ç”¨æˆ·æ˜µç§°
            Text(this.userInfo.nickname)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .textAlign(TextAlign.Start)
              .width('100%')

            // ç”¨æˆ·åï¼ˆåªåœ¨ç”¨æˆ·åå’Œæ˜µç§°ä¸åŒæ—¶æ˜¾ç¤ºï¼‰
            if (this.username && this.username !== this.userInfo.nickname) {
              Text(`ç”¨æˆ·å: ${this.username}`)
                .fontSize(14)
                .fontColor('#999999')
                .textAlign(TextAlign.Start)
                .width('100%')
            }

            // ç”¨æˆ·é‚®ç®±
            Text(this.userInfo.email)
              .fontSize(15)
              .fontColor('#666666')
              .textAlign(TextAlign.Start)
              .width('100%')

            // ç”¨æˆ·IDå’Œç§¯åˆ†ä¿¡æ¯
            Row({ space: 12 }) {
              if (this.userId > 0) {
                Text(`ID: ${this.userId}`)
                  .fontSize(12)
                  .fontColor('#999999')
                  .backgroundColor('#F0F0F0')
                  .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                  .borderRadius(4)
              }

              Text(`ç§¯åˆ†: ${this.userPoints}`)
                .fontSize(12)
                .fontColor('#FF9500')
                .backgroundColor('#FFF4E6')
                .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                .borderRadius(4)

              if (this.userCheckinCount > 0) {
                Text(`æ‰“å¡: ${this.userCheckinCount}`)
                  .fontSize(12)
                  .fontColor('#34C759')
                  .backgroundColor('#E8F7E8')
                  .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                  .borderRadius(4)
              }
            }
            .margin({ top: 4 })
          }
          .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 25, bottom: 25 })
      }
      .width('100%')
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({ radius: 4, color: '#00000008' })
      .margin({ left: 15, right: 15, top: 15, bottom: 20 })
    }
    .width('100%')
  }

  // ==================== åŠŸèƒ½åˆ—è¡¨ ====================

  @Builder
  buildFunctionList() {
    Column() {
      ForEach(this.functionList, (item: FunctionItem) => {
        this.buildFunctionItem(item)
      })
    }
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 15, right: 15, bottom: 15 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  @Builder
  buildOtherFunctions() {
    Column() {
      ForEach(this.otherFunctions, (item: FunctionItem) => {
        this.buildFunctionItem(item)
      })
    }
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 15, right: 15, bottom: 15 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  @Builder
  buildFunctionItem(item: FunctionItem) {
    Column() {
      Row({ space: 12 }) {
        // å·¦ä¾§å›¾æ ‡
        Text(item.icon)
          .fontSize(20)
          .width(24)
          .textAlign(TextAlign.Center)

        // æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
        Column({ space: 2 }) {
          Text(item.title)
            .fontSize(16)
            .fontColor('#333333')
            .textAlign(TextAlign.Start)
            .width('100%')

          // åŠ¨æ€æ›´æ–°å‰¯æ ‡é¢˜ï¼ˆæˆ‘çš„ç¤¼å“ä¸æ˜¾ç¤ºå‰¯æ ‡é¢˜ï¼‰
          if (item.subtitle && item.id !== 'gifts') {
            if (item.id === 'points') {
              // ç§¯åˆ†åŠŸèƒ½é¡¹æ˜¾ç¤ºçœŸå®ç§¯åˆ†
              Text(`å½“å‰ç§¯åˆ†ï¼š${this.userPoints}`)
                .fontSize(13)
                .fontColor('#666666')
                .textAlign(TextAlign.Start)
                .width('100%')
            } else if (item.id === 'checkin') {
              // æ‰“å¡è®°å½•åŠŸèƒ½é¡¹æ˜¾ç¤ºçœŸå®æ‰“å¡æ¬¡æ•°
              Text(`æ‰“å¡æ¬¡æ•°ï¼š${this.userCheckinCount}`)
                .fontSize(13)
                .fontColor('#666666')
                .textAlign(TextAlign.Start)
                .width('100%')
            } else {
              Text(item.subtitle)
                .fontSize(13)
                .fontColor('#666666')
                .textAlign(TextAlign.Start)
                .width('100%')
            }
          }
        }
        .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´

        // å³ä¾§ç®­å¤´
        if (item.showArrow) {
          Text('â€º')
            .fontSize(20)
            .fontColor('#999999')
            .margin({ right: 5 })
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 12 })
      .backgroundColor(Color.White)
      .onClick(() => {
        this.onFunctionItemClick(item);
      })

      // åˆ†éš”çº¿ï¼ˆä¸æ˜¯æœ€åä¸€é¡¹æ—¶æ˜¾ç¤ºï¼‰
      if (item.id !== this.functionList[this.functionList.length - 1]?.id &&
        item.id !== this.otherFunctions[this.otherFunctions.length - 1]?.id) {
        Divider()
          .color('#F0F0F0')
          .margin({ left: 52, right: 0 })
          .strokeWidth(0.5)
      }
    }
  }

  // ==================== é€€å‡ºç™»å½•æŒ‰é’® ====================

  @Builder
  buildLogoutButton() {
    Column() {
      Text('é€€å‡ºç™»å½•')
        .fontSize(16)
        .fontColor('#FF3B30')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .width('100%')
        .height(50)
        .backgroundColor(Color.White)
        .borderRadius(10)
        .onClick(() => {
          this.onLogoutClick();
        })
    }
    .margin({ left: 15, right: 15, top: 10, bottom: 30 })
  }

  // ==================== äº‹ä»¶å¤„ç†æ–¹æ³• ====================

  // åŠŸèƒ½é¡¹ç‚¹å‡»
  private onFunctionItemClick(item: FunctionItem) {
    console.log(`ç‚¹å‡»åŠŸèƒ½é¡¹: ${item.title} (ID: ${item.id})`);

    switch (item.id) {
      case 'checkin':
        this.onCheckinRecordClick();
        break;
      case 'points':
        this.onPointsClick();
        break;
      case 'gifts':
        this.onGiftsClick();
        break;
      case 'edit':
        this.onEditProfileClick();  // ä¿®æ”¹ï¼šè·³è½¬åˆ°ä¿®æ”¹ä¸ªäººä¿¡æ¯é¡µé¢
        break;
      case 'settings':
        this.onSettingsClick();
        break;
      case 'help':
        this.onHelpClick();
        break;
    }
  }

  // ç¼–è¾‘ä¸ªäººä¿¡æ¯ç‚¹å‡»
  private onEditProfileClick() {
    console.log('ç‚¹å‡»ä¿®æ”¹ä¸ªäººä¿¡æ¯ï¼Œè·³è½¬åˆ°ç¼–è¾‘é¡µé¢');

    // ä½¿ç”¨routerè·³è½¬åˆ°ä¿®æ”¹ä¸ªäººä¿¡æ¯é¡µé¢
    const promise: Promise<void> = router.pushUrl({
      url: 'pages/EditProfilePage',
      params: {
        from: 'profile',
        timestamp: new Date().getTime()
      }
    });

    promise.then((): void => {
      console.log('æˆåŠŸè·³è½¬åˆ°ä¿®æ”¹ä¸ªäººä¿¡æ¯é¡µé¢');
    }).catch((error: Error): void => {
      console.error('è·³è½¬åˆ°ä¿®æ”¹ä¸ªäººä¿¡æ¯é¡µé¢å¤±è´¥:', error.message);
    });
  }

  // æ‰“å¡è®°å½•ç‚¹å‡»
  private onCheckinRecordClick() {
    console.log('ç‚¹å‡»æ‰“å¡è®°å½•');
  }

  // ç§¯åˆ†ç‚¹å‡»
  private onPointsClick() {
    console.log('ç‚¹å‡»ç§¯åˆ†');
  }

  // æˆ‘çš„ç¤¼å“ç‚¹å‡»
  private onGiftsClick() {
    console.log('ç‚¹å‡»æˆ‘çš„ç¤¼å“');
  }

  // è®¾ç½®ç‚¹å‡»
  private onSettingsClick() {
    console.log('ç‚¹å‡»è®¾ç½®');
  }

  // å¸®åŠ©ç‚¹å‡»
  private onHelpClick(): void {
    console.log('ç‚¹å‡»å¸®åŠ©ï¼Œè·³è½¬åˆ°æ™ºèƒ½é—®ç­”ç•Œé¢');

    const promise: Promise<void> = router.pushUrl({
      url: 'pages/AssistantPage',
      params: {
        from: 'profile',
        timestamp: new Date().getTime()
      }
    });

    promise.then((): void => {
      console.log('æˆåŠŸè·³è½¬åˆ°åŠ©æ‰‹é¡µé¢');
    }).catch((error: Error): void => {
      console.error('è·³è½¬å¤±è´¥:', error.message);
    });
  }

  // é€€å‡ºç™»å½•ç‚¹å‡»
  private onLogoutClick() {
    console.log('ç‚¹å‡»é€€å‡ºç™»å½•');
    setTimeout(() => {
      console.log('é€€å‡ºç™»å½•æˆåŠŸ');
    }, 1000);
  }

  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================

  aboutToAppear() {
    console.log('ä¸ªäººä¸­å¿ƒé¡µé¢æ˜¾ç¤º');
    this.loadUserInfo();
  }

  aboutToDisappear() {
    console.log('ä¸ªäººä¸­å¿ƒé¡µé¢éšè—');
  }

  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  private loadUserInfo() {
    console.log('å¼€å§‹åŠ è½½ç”¨æˆ·ä¿¡æ¯...');

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.isLoading = true;
    this.isError = false;
    this.errorMessage = '';

    // è°ƒç”¨ getProfile æ–¹æ³•
    getProfile().then((response) => {
      console.log('è·å–ç”¨æˆ·èµ„æ–™APIå“åº”:', response);

      if (response) {
        // å¦‚æœè·å–æˆåŠŸï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        if (response.code === 200 && response.data) {
          const userData = response.data;

          console.log('æœåŠ¡å™¨è¿”å›çš„ç”¨æˆ·æ•°æ®:', userData);

          // ä¿å­˜ç”¨æˆ·å
          this.username = userData.username || '';

          // ç¡®å®šæ˜¾ç¤ºæ˜µç§°ï¼šå¦‚æœæ˜µç§°ä¸ºç©ºï¼Œä½¿ç”¨ç”¨æˆ·å
          let displayNickname = userData.nickname;
          if (!displayNickname || displayNickname.trim() === '') {
            displayNickname = this.username || this.userInfo.nickname;
          }

          // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ•°æ®ä¸ºç©ºåˆ™ä¿ç•™åŸæœ‰æ•°æ®
          this.userInfo = {
            nickname: displayNickname || this.userInfo.nickname,
            avatar: userData.avatar || this.userInfo.avatar,
            email: userData.email || this.userInfo.email
          };

          // æ›´æ–°ç”¨æˆ·ID
          this.userId = userData.userId || this.userId;

          // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
          this.userPoints = userData.points || 0;  // ä¿®æ”¹ï¼šå¦‚æœè¿”å›ä¸ºç©ºï¼Œè®¾ä¸º0

          // æ›´æ–°æ‰“å¡æ¬¡æ•°
          this.userCheckinCount = userData.checkinCount || 0;

          // æ›´æ–°åŠŸèƒ½åˆ—è¡¨çš„å‰¯æ ‡é¢˜
          this.updateFunctionListSubtitles();

          console.log('ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°:', this.userInfo);
          console.log('ç”¨æˆ·å:', this.username);
          console.log('ç”¨æˆ·ç§¯åˆ†:', this.userPoints);
          console.log('æ‰“å¡æ¬¡æ•°:', this.userCheckinCount);
          console.log('ç”¨æˆ·ID:', this.userId);
        } else {
          console.log('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›é”™è¯¯:', response.msg || 'æœªçŸ¥é”™è¯¯');
          this.isError = true;
          this.errorMessage = response.msg || 'æœåŠ¡å™¨è¿”å›é”™è¯¯';
        }
      } else {
        console.log('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥: è¿”å›ç©ºå“åº”');
        this.isError = true;
        this.errorMessage = 'æœåŠ¡å™¨è¿”å›ç©ºå“åº”';
      }
    }).catch((error: Error) => {
      console.error('è·å–ç”¨æˆ·èµ„æ–™å¼‚å¸¸:', error);
      this.isError = true;
      this.errorMessage = error.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
    }).finally(() => {
      // éšè—åŠ è½½çŠ¶æ€
      this.isLoading = false;
      console.log('åŠ è½½ç”¨æˆ·ä¿¡æ¯å®Œæˆ');
    });
  }

  // æ›´æ–°åŠŸèƒ½åˆ—è¡¨å‰¯æ ‡é¢˜
  private updateFunctionListSubtitles() {
    // ä½¿ç”¨ map æ–¹æ³•åˆ›å»ºæ–°çš„æ•°ç»„
    this.functionList = this.functionList.map((item: FunctionItem) => {
      if (item.id === 'points') {
        return {
          id: item.id,
          icon: item.icon,
          title: item.title,
          subtitle: `å½“å‰ç§¯åˆ†ï¼š${this.userPoints}`,
          showArrow: item.showArrow,
          route: item.route
        };
      } else if (item.id === 'checkin') {
        return {
          id: item.id,
          icon: item.icon,
          title: item.title,
          subtitle: `æ‰“å¡æ¬¡æ•°ï¼š${this.userCheckinCount}`,
          showArrow: item.showArrow,
          route: item.route
        };
      } else if (item.id === 'gifts') {
        // æˆ‘çš„ç¤¼å“é¡¹ï¼šå»æ‰å‰¯æ ‡é¢˜
        return {
          id: item.id,
          icon: item.icon,
          title: item.title,
          showArrow: item.showArrow,  // è¿™é‡Œä¸è®¾ç½® subtitle
          route: item.route
        };
      } else {
        return item;
      }
    });

    console.log('åŠŸèƒ½åˆ—è¡¨å·²æ›´æ–°:', this.functionList);
  }
}