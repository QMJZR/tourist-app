// entry/src/main/ets/pages/CheckinSpotsPage.ets
import router from '@ohos.router';
import {getCheckInSpots, GetReq} from '../api/checkIn'
// å‡æ•°æ® - æ ¹æ®æ–‡æ¡£ä¸­çš„è¿”å›æ ¼å¼
const mockCheckinSpots: CheckinSpot[] =  [
  {
    spotId: 301,
    name: 'å±±é¡¶è§‚æ™¯å°',
    latitude: 23.112233,
    longitude: 113.332211,
    radius: 100,
    thumbnail: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300&auto=format&fit=crop',
    distance: 85
  },
  {
    spotId: 302,
    name: 'æ¹–ç•”æ ˆé“',
    latitude: 23.115566,
    longitude: 113.334455,
    radius: 120,
    thumbnail: 'https://images.unsplash.com/photo-1464207687429-7505649dae38?w=300&auto=format&fit=crop',
    distance: 320
  },
  {
    spotId: 303,
    name: 'ç€‘å¸ƒè§‚æ™¯å°',
    latitude: 23.118899,
    longitude: 113.336677,
    radius: 80,
    thumbnail: 'https://images.unsplash.com/photo-1551632811-561732d1e306?w=300&auto=format&fit=crop',
    distance: 560
  },
  {
    spotId: 304,
    name: 'èŠ±å›­å¹¿åœº',
    latitude: 23.122233,
    longitude: 113.338899,
    radius: 150,
    thumbnail: 'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=300&auto=format&fit=crop',
    distance: 1200
  },
  {
    spotId: 305,
    name: 'å±±é—´æ­¥é“',
    latitude: 23.125566,
    longitude: 113.341122,
    radius: 90,
    thumbnail: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=300&auto=format&fit=crop',
    distance: 1850
  }
];

// æ‰“å¡ç‚¹æ¥å£
interface CheckinSpot {
  spotId: number;
  name: string;
  latitude: number;
  longitude: number;
  radius: number;
  thumbnail?: string;
  distance?: number;
}

// è¯·æ±‚å‚æ•°æ¥å£
interface CheckinSpotsParams {
  lat?: number;
  lng?: number;
  sort?: string;
}

interface UserLocation {
  lat?:number;
  lng?:number;
}
@Entry
@Component
export default struct CheckinSpotsPage {
  // æ‰“å¡ç‚¹åˆ—è¡¨æ•°æ®
  @State checkinSpots: CheckinSpot[] = [];

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = true;

  // æ˜¯å¦æŒ‰è·ç¦»æ’åº
  @State sortByDistance: boolean = false;

  // å½“å‰ç”¨æˆ·ä½ç½®
  @State userLocation: UserLocation = {};

  // é¡µé¢æ„å»º
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildNavigationBar()

      // ç­›é€‰å·¥å…·æ 
      this.buildFilterToolbar()

      // æ‰“å¡ç‚¹åˆ—è¡¨
      if (this.isLoading) {
        this.buildLoadingView()
      } else if (this.checkinSpots.length === 0) {
        this.buildEmptyView()
      } else {
        this.buildSpotsList()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
    .padding({ bottom: 120 }) // â† å…³é”®ä¿®æ”¹ï¼šä¸ºåº•éƒ¨Tabsé¢„ç•™ç©ºé—´
  }

  // ==================== é¡¶éƒ¨å¯¼èˆªæ  ====================
  @Builder
  buildNavigationBar() {
    Column() {
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .fontColor('#1A1A1A')
          .backgroundColor(Color.Transparent)
          .width(40)
          .height(40)
          .onClick(() => {
            router.back();
          })

        // æ ‡é¢˜
        Text('æ‰“å¡ç‚¹ä½')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .layoutWeight(1)

        // åˆ·æ–°æŒ‰é’®
        Button('åˆ·æ–°')
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.loadCheckinSpots();
          })
      }
      .width('100%')
      .height(60)
      .padding({ left: 15, right: 15 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .shadow({ radius: 2, color: '#00000008' })
  }

  // ==================== ç­›é€‰å·¥å…·æ  ====================
  @Builder
  buildFilterToolbar() {
    Column() {
      // æ’åºé€‰é¡¹
      Row({ space: 15 }) {
        // æ’åºæŒ‰é’®
        Button(this.sortByDistance ? 'æŒ‰è·ç¦»æ’åº âœ“' : 'æŒ‰è·ç¦»æ’åº')
          .fontSize(14)
          .fontColor(this.sortByDistance ? '#007AFF' : '#666666')
          .backgroundColor(this.sortByDistance ? '#007AFF10' : '#F0F0F0')
          .height(32)
          .borderRadius(16)
          .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.toggleSortByDistance();
          })

        // çŠ¶æ€æ˜¾ç¤º
        Text(`å…± ${this.checkinSpots.length} ä¸ªæ‰“å¡ç‚¹`)
          .fontSize(14)
          .fontColor('#666666')
          .layoutWeight(1)
          .textAlign(TextAlign.End)
      }
      .width('100%')
      .padding({ left: 15, right: 15 })

      // é™„è¿‘æ‰“å¡ç‚¹æç¤º
      if (this.userLocation.lat && this.userLocation.lng) {
        Row() {
          // Image($r('app.media.ic_location'))
          //   .width(16)
          //   .height(16)
          //   .margin({ right: 5 })
          Text(`å½“å‰ä½ç½®é™„è¿‘ ${this.getNearbySpotsCount()} ä¸ªæ‰“å¡ç‚¹`)
            .fontSize(12)
            .fontColor('#007AFF')
        }
        .width('100%')
        .padding({ left: 15, right: 15, top: 5 })
        .justifyContent(FlexAlign.Start)
      }
    }
    .width('100%')
    .padding({ top: 10, bottom: 10 })
    .backgroundColor(Color.White)
    .margin({ top: 2 })
  }

  // ==================== åŠ è½½ä¸­è§†å›¾ ====================
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .color('#007AFF')
        .width(40)
        .height(40)
      Text('æ­£åœ¨åŠ è½½æ‰“å¡ç‚¹ä½...')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ top: 10 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // ==================== ç©ºçŠ¶æ€è§†å›¾ ====================
  @Builder
  buildEmptyView() {
    Column() {
      // Image($r('app.media.ic_empty'))
      //   .width(100)
      //   .height(100)
      //   .margin({ bottom: 20 })
      Text('æš‚æ— æ‰“å¡ç‚¹ä½')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ bottom: 10 })
      Text('è¯¥åŒºåŸŸæš‚æ—¶æ²¡æœ‰å¯æ‰“å¡çš„ç‚¹ä½')
        .fontSize(14)
        .fontColor('#999999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // ==================== æ‰“å¡ç‚¹åˆ—è¡¨ ====================
  @Builder
  buildSpotsList() {
    List({ space: 10 }) {
      ForEach(this.checkinSpots, (spot: CheckinSpot) => {
        ListItem() {
          this.buildSpotItem(spot)
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
    .padding({ left: 15, right: 15, top: 10 })
  }

  // ==================== æ‰“å¡ç‚¹é¡¹ç›® ====================
  @Builder
  buildSpotItem(spot: CheckinSpot) {
    Column({ space: 0 }) {
      // ä¸»ä¿¡æ¯è¡Œ
      Row({ space: 12 }) {
        // ç¼©ç•¥å›¾
        Column() {
          if (spot.thumbnail) {
            Image(spot.thumbnail)
              .width(60)
              .height(60)
              .objectFit(ImageFit.Cover)
              .borderRadius(8)
          } else {
            Column()
              .width(60)
              .height(60)
              .backgroundColor('#E0E0E0')
              .borderRadius(8)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            // Image($r('app.media.ic_spot'))
            //   .width(24)
            //   .height(24)
          }
        }

        // ä¿¡æ¯åŒºåŸŸ
        Column({ space: 6 }) {
          // åç§°å’Œè·ç¦»
          Row() {
            Text(spot.name)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1A1A1A')
              .layoutWeight(1)

            if (spot.distance !== undefined) {
              Text(this.formatDistance(spot.distance))
                .fontSize(14)
                .fontColor(spot.distance <= spot.radius ? '#34C759' : '#666666')
            }
          }
          .width('100%')

          // åæ ‡ä¿¡æ¯
          Row() {
            Text(`ğŸ“ ${spot.latitude.toFixed(6)}, ${spot.longitude.toFixed(6)}`)
              .fontSize(12)
              .fontColor('#999999')
          }
          .width('100%')

          // æ‰“å¡èŒƒå›´å’ŒçŠ¶æ€
          Row() {
            // æ‰“å¡èŒƒå›´
            Text(`æ‰“å¡èŒƒå›´: ${spot.radius}ç±³`)
              .fontSize(12)
              .fontColor('#666666')

            // çŠ¶æ€æŒ‡ç¤ºå™¨
            if (spot.distance !== undefined) {
              Row({ space: 5 }) {
                // è·ç¦»åœ†ç‚¹
                Column()
                  .width(8)
                  .height(8)
                  .backgroundColor(spot.distance <= spot.radius ? '#34C759' : '#FF9500')
                  .borderRadius(4)

                // çŠ¶æ€æ–‡æœ¬
                Text(spot.distance <= spot.radius ? 'å¯æ‰“å¡' : 'è·ç¦»è¿‡è¿œ')
                  .fontSize(12)
                  .fontColor(spot.distance <= spot.radius ? '#34C759' : '#FF9500')
              }
              .margin({ left: 10 })
            }
          }
          .width('100%')
        }
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ top: 12, bottom: 12, left: 12, right: 12 })

      // æ“ä½œæŒ‰é’®
      Row() {
        // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
        Button('æŸ¥çœ‹è¯¦æƒ…')
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor('#007AFF10')
          .height(36)
          .borderRadius(18)
          .layoutWeight(1)
          .onClick(() => {
            this.viewSpotDetail(spot.spotId);
          })

        // æ‰“å¡æŒ‰é’®
        Button(spot.distance && spot.distance <= spot.radius ? 'ç«‹å³æ‰“å¡' : 'æŸ¥çœ‹ä½ç½®')
          .fontSize(14)
          .fontColor(Color.White)
          .backgroundColor(spot.distance && spot.distance <= spot.radius ? '#007AFF' : '#666666')
          .height(36)
          .borderRadius(18)
          .layoutWeight(1)
          .margin({ left: 10 })
          .onClick(() => {
            if (spot.distance && spot.distance <= spot.radius) {
              this.checkIn(spot.spotId);
            } else {
              this.viewOnMap(spot);
            }
          })
      }
      .width('100%')
      .padding({ left: 12, right: 12, bottom: 12 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 10 })
    .shadow({ radius: 4, color: '#0000000A' })
  }

  // ==================== äº¤äº’æ–¹æ³• ====================

  // åˆ‡æ¢æŒ‰è·ç¦»æ’åº
  private toggleSortByDistance() {
    this.sortByDistance = !this.sortByDistance;

    if (this.sortByDistance) {
      // æŒ‰è·ç¦»å‡åºæ’åº
      this.checkinSpots = [...this.checkinSpots].sort((a, b) => {
        const distA = a.distance || Infinity;
        const distB = b.distance || Infinity;
        return distA - distB;
      });
    } else {
      // æ¢å¤åŸå§‹é¡ºåº
      this.loadCheckinSpots();
    }
  }

  // è·å–é™„è¿‘æ‰“å¡ç‚¹æ•°é‡
  private getNearbySpotsCount(): number {
    return this.checkinSpots.filter(spot =>
    spot.distance !== undefined && spot.distance <= spot.radius
    ).length;
  }

  // æ ¼å¼åŒ–è·ç¦»æ˜¾ç¤º
  private formatDistance(meters: number): string {
    if (meters < 1000) {
      return `${meters}ç±³`;
    } else {
      return `${(meters / 1000).toFixed(1)}å…¬é‡Œ`;
    }
  }

  // æŸ¥çœ‹ç‚¹ä½è¯¦æƒ…
  private viewSpotDetail(spotId: number) {

    spotId = 101 // for test
    console.log('æŸ¥çœ‹ç‚¹ä½è¯¦æƒ…:', spotId);
    // TODO: è·³è½¬åˆ°ç‚¹ä½è¯¦æƒ…é¡µé¢
    router.pushUrl({
      url:"pages/SpotDetailPage",
      params:{spotId}
    })
  }

  // æ‰“å¡
  private checkIn(spotId: number) {
    console.log('æ‰“å¡:', spotId);
    // TODO: è·³è½¬åˆ°æ‰“å¡é¡µé¢
    router.push({
      url: 'pages/SubmitCheckInPage',
      params: {
        spotId: spotId,
        spotName: 'æ‰“å¡ç‚¹åç§°', // å¯ä»¥ä»spotå¯¹è±¡è·å–
        latitude: 1, // for test
        longitude: 1
      }
    });

  }

  // åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹
  private viewOnMap(spot: CheckinSpot) {
    console.log('åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹ç‚¹ä½:', spot.name, spot.latitude, spot.longitude);
    // TODO: è·³è½¬åˆ°åœ°å›¾é¡µé¢
  }

  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================

  aboutToAppear() {
    console.log('æ‰“å¡ç‚¹ä½é¡µé¢æ˜¾ç¤º');

    // è·å–ç”¨æˆ·å½“å‰ä½ç½®ï¼ˆæ¨¡æ‹Ÿï¼‰
    this.getUserLocation();

    // åŠ è½½æ‰“å¡ç‚¹ä½æ•°æ®
    this.loadCheckinSpots();
  }

  // è·å–ç”¨æˆ·ä½ç½®
  private getUserLocation() {
    // TODO: è°ƒç”¨é¸¿è’™å®šä½APIè·å–å½“å‰ä½ç½®
    console.log('è·å–ç”¨æˆ·ä½ç½®...');

    // æ¨¡æ‹Ÿä½ç½®
    setTimeout(() => {
      this.userLocation = {
        lat: 23.11,
        lng: 113.33
      };
      console.log('ç”¨æˆ·ä½ç½®å·²è®¾ç½®:', this.userLocation);
    }, 100);
  }

  // åŠ è½½æ‰“å¡ç‚¹ä½
  private loadCheckinSpots() {
    console.log('å¼€å§‹åŠ è½½æ‰“å¡ç‚¹ä½...');
    this.isLoading = true;

    const data:GetReq = {
      lat:1,
      lng:1,
      sort:"distance"
    }
    getCheckInSpots(data)

    // æš‚æ—¶ä½¿ç”¨å‡æ•°æ®
    setTimeout(() => {
      console.log('åŠ è½½æ‰“å¡ç‚¹ä½å®Œæˆ');
      this.checkinSpots = [...mockCheckinSpots];
      this.isLoading = false;
    }, 1000);
  }

  aboutToDisappear() {
    console.log('æ‰“å¡ç‚¹ä½é¡µé¢å³å°†æ¶ˆå¤±');
    // æ¸…ç†èµ„æº
  }
}