// entry/src/main/ets/pages/RankingPage.ets

import { router } from '@kit.ArkUI';
import { getRankings, RankingsApiResponse, getDailyRankings, getWeeklyRankings, getMonthlyRankings } from '../api/ranking';

// æœ¬åœ°æ’è¡Œæ¦œé¡¹æ¥å£å®šä¹‰ï¼ˆé€‚é…APIæ¥å£ï¼‰
interface RankingItemLocal {
  rank: number;          // æ’å
  userId: number;       // ç”¨æˆ·ID
  username: string;     // ç”¨æˆ·å
  nickname: string;     // ç”¨æˆ·æ˜µç§°ï¼ˆæœ¬åœ°æ‰©å±•å­—æ®µï¼‰
  avatar: string;       // ç”¨æˆ·å¤´åƒ
  score: number;       // ç»¼åˆè¯„åˆ†
  checkinCount: number; // æ‰“å¡æ¬¡æ•°
  likeCount: number;    // ç‚¹èµæ•°é‡
  points: number;       // ç§¯åˆ†ï¼ˆæœ¬åœ°æ‰©å±•å­—æ®µï¼‰
  trend: 'up' | 'down' | 'stable' | 'new'; // æ’åè¶‹åŠ¿ï¼ˆæœ¬åœ°æ‰©å±•å­—æ®µï¼‰
}

// æ—¶é—´ç»´åº¦ç±»å‹ï¼ˆä¸APIä¸€è‡´ï¼‰
type TimeDimension = 'daily' | 'weekly' | 'monthly';

// æ—¶é—´ç»´åº¦é€‰é¡¹
interface TimeOption {
  label: string;
  value: TimeDimension;
}

@Entry
@Component
struct RankingPage {
  // æ’è¡Œæ¦œæ•°æ®
  @State rankingList: Array<RankingItemLocal> = [];

  // å½“å‰æ—¶é—´ç»´åº¦
  @State currentTimeDimension: TimeDimension = 'weekly'; // é»˜è®¤æœ¬å‘¨ï¼Œä¸APIä¸€è‡´

  // æ—¶é—´ç»´åº¦é€‰é¡¹
  private timeOptions: Array<TimeOption> = [
    { label: 'ä»Šæ—¥', value: 'daily' },
    { label: 'æœ¬å‘¨', value: 'weekly' },
    { label: 'æœ¬æœˆ', value: 'monthly' }
  ];

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;
  @State apiFailed: boolean = false; // APIè°ƒç”¨å¤±è´¥æ ‡è®°

  // ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    console.log('æ’è¡Œæ¦œé¡µé¢æ˜¾ç¤º');
    this.loadRankingData();
  }

  // åŠ è½½æ’è¡Œæ¦œæ•°æ®ï¼ˆä¼˜å…ˆè°ƒç”¨æ¥å£ï¼‰
  private async loadRankingData() {
    this.isLoading = true;
    this.apiFailed = false;

    console.log('å¼€å§‹åŠ è½½æ’è¡Œæ¦œæ•°æ®...');

    try {
      let response: RankingsApiResponse | void;

      // æ ¹æ®æ—¶é—´ç»´åº¦è°ƒç”¨ä¸åŒçš„æ¥å£
      switch (this.currentTimeDimension) {
        case 'daily':
          response = await getDailyRankings();
          break;
        case 'weekly':
          response = await getWeeklyRankings();
          break;
        case 'monthly':
          response = await getMonthlyRankings();
          break;
        default:
          response = await getWeeklyRankings();
      }

      // ä½¿ç”¨ç±»å‹æ–­è¨€
      const typedResponse = response as RankingsApiResponse;

      if (typedResponse && typedResponse.code === 200 && typedResponse.data) {
        console.log('âœ… æ’è¡Œæ¦œæ¥å£è°ƒç”¨æˆåŠŸï¼Œè·å–åˆ°', typedResponse.data.list.length, 'æ¡è®°å½•');
        this.processApiData(typedResponse);
        this.isLoading = false;
        this.isRefreshing = false;
        return;
      } else {
        console.warn('æ’è¡Œæ¦œæ¥å£è¿”å›æ•°æ®å¼‚å¸¸ï¼Œä½¿ç”¨å‡æ•°æ®');
        this.apiFailed = true;
      }
    } catch (error) {
      console.error('æ’è¡Œæ¦œæ¥å£è°ƒç”¨å¤±è´¥:', error);
      this.apiFailed = true;
    }

    // å¦‚æœæ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å‡æ•°æ®
    console.log('ä½¿ç”¨å‡æ•°æ®');
    this.useMockData();
  }

  // å¤„ç†APIè¿”å›çš„æ•°æ®
  private processApiData(response: RankingsApiResponse) {
    if (!response.data) {
      console.warn('APIè¿”å›æ•°æ®ä¸ºç©º');
      return;
    }

    console.log('å¤„ç†APIæ’è¡Œæ¦œæ•°æ®:', response.data);

    // è½¬æ¢æ’è¡Œæ¦œåˆ—è¡¨æ•°æ®
    const convertedList: RankingItemLocal[] = response.data.list.map((apiItem, index: number) => {
      // ç”Ÿæˆæ˜µç§°ï¼ˆAPIæ²¡æœ‰æä¾›ï¼Œæ ¹æ®ç”¨æˆ·åç”Ÿæˆï¼‰
      const nickname = this.generateNickname(apiItem.username);

      // è®¡ç®—ç§¯åˆ†ï¼ˆå‡è®¾æ¯æ‰“å¡ä¸€æ¬¡å¾—10åˆ†ï¼Œæ¯ç‚¹èµä¸€æ¬¡å¾—1åˆ†ï¼‰
      const points = (apiItem.totalCheckins * 10) + apiItem.totalLikes;

      const item: RankingItemLocal = {
        rank: apiItem.rank || index + 1,
        userId: apiItem.userId,
        username: apiItem.username || `ç”¨æˆ·${apiItem.userId}`,
        nickname: nickname,
        avatar: apiItem.avatar || this.getDefaultAvatar(apiItem.userId),
        score: apiItem.score || 0,
        checkinCount: apiItem.totalCheckins || 0,
        likeCount: apiItem.totalLikes || 0,
        points: points,
        trend: this.generateTrend(index + 1) // æ ¹æ®æ’åç”Ÿæˆè¶‹åŠ¿
      };
      return item;
    });

    this.rankingList = convertedList;

    console.log('æ•°æ®è½¬æ¢å®Œæˆï¼Œå…±', this.rankingList.length, 'æ¡è®°å½•');
  }

  // ç”Ÿæˆç”¨æˆ·æ˜µç§°
  private generateNickname(username: string): string {
    // ä»é¢„å®šä¹‰çš„æ˜µç§°åˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
    const nicknames = [
      'æ—…è¡Œè¾¾äºº', 'æ¢é™©å®¶', 'æ‘„å½±å¤§å¸ˆ', 'ç¾é£ŸçŒäºº', 'æ–‡åŒ–ä½¿è€…',
      'å¾’æ­¥çˆ±å¥½è€…', 'éª‘è¡Œä¾ ', 'èƒŒåŒ…å®¢', 'é£æ™¯æ”¶è—å®¶', 'è®°å½•è€…',
      'åŸå¸‚æ¢ç´¢è€…', 'è‡ªç„¶çˆ±å¥½è€…', 'å†å²è¿½å¯»è€…', 'ç¾é£Ÿå®¶', 'æ‘„å½±å¸ˆ'
    ];

    // ä½¿ç”¨ç”¨æˆ·åhashæ¥ç¡®ä¿åŒä¸€ä¸ªç”¨æˆ·æ€»æ˜¯å¾—åˆ°ç›¸åŒçš„æ˜µç§°
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
      hash = ((hash << 5) - hash) + username.charCodeAt(i);
      hash = hash & hash;
    }

    const index = Math.abs(hash) % nicknames.length;
    return nicknames[index];
  }

  // ç”Ÿæˆè¶‹åŠ¿
  private generateTrend(rank: number): 'up' | 'down' | 'stable' | 'new' {
    if (rank <= 3) return 'up';
    if (rank > 7) return 'new';

    const trends: Array<'up' | 'down' | 'stable'> = ['up', 'down', 'stable'];
    return trends[Math.floor(Math.random() * trends.length)];
  }

  // è·å–é»˜è®¤å¤´åƒ
  private getDefaultAvatar(userId: number): string {
    return `https://avatars.githubusercontent.com/u/${userId % 1000}?v=4`;
  }

  // ä½¿ç”¨å‡æ•°æ®
  private useMockData() {
    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      // ç”Ÿæˆå‡æ•°æ®
      this.generateMockData();
      this.isLoading = false;
      this.isRefreshing = false;
      console.log('âœ… ä½¿ç”¨å‡æ•°æ®åŠ è½½æˆåŠŸ');
    }, 800);
  }

  // ç”Ÿæˆå‡æ•°æ®ï¼ˆé€‚é…APIæ•°æ®ç»“æ„ï¼‰
  private generateMockData() {
    const mockData: Array<RankingItemLocal> = [];
    const baseCheckinCount = [45, 38, 32, 28, 25, 22, 20, 18, 16, 15];
    const baseLikeCount = [1200, 950, 780, 620, 520, 450, 380, 320, 280, 240];

    // æ ¹æ®æ—¶é—´ç»´åº¦è°ƒæ•´æ•°æ®
    let timeMultiplier = 1;
    if (this.currentTimeDimension === 'daily') {
      timeMultiplier = 1;
    } else if (this.currentTimeDimension === 'weekly') {
      timeMultiplier = 7;
    } else if (this.currentTimeDimension === 'monthly') {
      timeMultiplier = 30;
    }

    // ç”Ÿæˆ10ä¸ªå‡æ•°æ®
    for (let i = 0; i < 10; i++) {
      const checkinCount = baseCheckinCount[i] * timeMultiplier;
      const likeCount = baseLikeCount[i] * timeMultiplier;
      const score = Math.round((checkinCount * 3 + likeCount * 0.1) * 10) / 10;
      const points = (checkinCount * 10) + likeCount;
      const nickname = this.generateNickname(`user${1000 + i}`);

      // ç”Ÿæˆè¶‹åŠ¿
      const trend = this.generateTrend(i + 1);

      mockData.push({
        rank: i + 1,
        userId: 1000 + i,
        username: `user${1000 + i}`,
        nickname: nickname,
        avatar: `https://avatars.githubusercontent.com/u/${1000 + i}?v=4`,
        score: score,
        checkinCount: checkinCount,
        likeCount: likeCount,
        points: points,
        trend: trend
      });
    }

    this.rankingList = mockData;
  }

  // åˆ‡æ¢æ—¶é—´ç»´åº¦
  private async changeTimeDimension(dimension: TimeDimension) {
    if (this.currentTimeDimension === dimension) {
      return;
    }

    this.currentTimeDimension = dimension;
    this.isLoading = true;

    // å¦‚æœAPIä¹‹å‰å¤±è´¥äº†ï¼Œç›´æ¥ä½¿ç”¨å‡æ•°æ®
    if (this.apiFailed) {
      setTimeout(() => {
        this.generateMockData();
        this.isLoading = false;
        console.log(`âœ… åˆ‡æ¢${this.getTimeDimensionText()}ç»´åº¦ï¼Œä½¿ç”¨å‡æ•°æ®`);
      }, 500);
      return;
    }

    // å¦åˆ™å°è¯•é‡æ–°è°ƒç”¨API
    try {
      let response: RankingsApiResponse | void;

      // æ ¹æ®æ—¶é—´ç»´åº¦è°ƒç”¨ä¸åŒçš„æ¥å£
      switch (dimension) {
        case 'daily':
          response = await getDailyRankings();
          break;
        case 'weekly':
          response = await getWeeklyRankings();
          break;
        case 'monthly':
          response = await getMonthlyRankings();
          break;
        default:
          response = await getWeeklyRankings();
      }

      const typedResponse = response as RankingsApiResponse;

      if (typedResponse && typedResponse.code === 200 && typedResponse.data) {
        console.log('âœ… åˆ‡æ¢ç»´åº¦æ¥å£è°ƒç”¨æˆåŠŸ');
        this.processApiData(typedResponse);
      } else {
        console.warn('åˆ‡æ¢ç»´åº¦æ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
        this.generateMockData();
      }
    } catch (error) {
      console.error('åˆ‡æ¢ç»´åº¦æ¥å£è°ƒç”¨å¼‚å¸¸ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
      this.generateMockData();
    } finally {
      this.isLoading = false;
    }
  }

  // è·å–æ—¶é—´ç»´åº¦æ–‡æœ¬
  private getTimeDimensionText(): string {
    switch (this.currentTimeDimension) {
      case 'daily':
        return 'ä»Šæ—¥';
      case 'weekly':
        return 'æœ¬å‘¨';
      case 'monthly':
        return 'æœ¬æœˆ';
      default:
        return '';
    }
  }

  // åˆ·æ–°æ•°æ®
  private refreshData() {
    this.isRefreshing = true;
    this.loadRankingData();
  }

  // æ„å»ºAPIå¤±è´¥æç¤º
  @Builder
  buildApiFailNotice() {
    if (this.apiFailed && !this.isLoading) {
      Row({ space: 8 }) {
        Text('âš ï¸')
          .fontSize(14)
          .fontColor('#FF9500')

        Text('æ¥å£è°ƒç”¨å¤±è´¥ï¼Œå·²æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®')
          .fontSize(12)
          .fontColor('#666666')
          .layoutWeight(1)

        Button('é‡è¯•')
          .fontSize(12)
          .backgroundColor('#007AFF10')
          .borderRadius(8)
          .padding({ left: 8, right: 8 })
          .height(24)
          .onClick(() => {
            console.log('ç‚¹å‡»é‡è¯•æ¥å£');
            this.refreshData();
          })
      }
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor('#FFF8E6')
      .borderRadius(8)
      .margin({ left: 16, right: 16, top: 8 })
      .shadow({ radius: 2, color: '#00000004' })
    }
  }

  // è·å–æ’åè¶‹åŠ¿å›¾æ ‡
  private getTrendIcon(trend: 'up' | 'down' | 'stable' | 'new'): string {
    switch (trend) {
      case 'up':
        return 'â†‘';
      case 'down':
        return 'â†“';
      case 'stable':
        return 'â†’';
      case 'new':
        return 'âœ¨';
      default:
        return '';
    }
  }

  // è·å–æ’åè¶‹åŠ¿é¢œè‰²
  private getTrendColor(trend: 'up' | 'down' | 'stable' | 'new'): ResourceColor {
    switch (trend) {
      case 'up':
        return '#FF3B30';
      case 'down':
        return '#007AFF';
      case 'stable':
        return '#666666';
      case 'new':
        return '#FF9500';
      default:
        return '#666666';
    }
  }

  // è·å–æ’åå¾½ç« é¢œè‰²
  private getRankBadgeColor(rank: number): string {
    switch (rank) {
      case 1:
        return '#FFD700'; // é‡‘è‰²
      case 2:
        return '#C0C0C0'; // é“¶è‰²
      case 3:
        return '#CD7F32'; // é“œè‰²
      default:
        return '#34C759'; // ç»¿è‰²
    }
  }

  // æ„å»ºæ—¶é—´ç­›é€‰å™¨
  @Builder
  buildTimeFilter() {
    Column({ space: 12 }) {
      Text('æ’è¡Œæ¦œ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .textAlign(TextAlign.Start)
        .width('100%')

      Row({ space: 8 }) {
        ForEach(this.timeOptions, (option: TimeOption) => {
          Button(option.label) {
            Text(option.label)
              .fontSize(14)
              .fontColor(this.currentTimeDimension === option.value ? Color.White : '#666666')
          }
          .backgroundColor(this.currentTimeDimension === option.value ? '#007AFF' : '#F5F5F5')
          .borderRadius(20)
          .padding({ left: 20, right: 20 })
          .height(36)
          .onClick(() => {
            this.changeTimeDimension(option.value);
          })
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)

      // æ’è¡Œæ¦œè§„åˆ™è¯´æ˜
      Row({ space: 8 }) {
        Text('ğŸ“Š')
          .fontSize(14)
          .fontColor('#666666')

        Text('ç»¼åˆè¯„åˆ† = æ‰“å¡æ¬¡æ•° + ç‚¹èµæ•° Ã— 0.1')
          .fontSize(12)
          .fontColor('#999999')
          .lineHeight(16)
      }
      .width('100%')
      .padding({ top: 4, bottom: 4 })
    }
    .padding({ left: 16, right: 16, top: 16, bottom: 12 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 16 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  // æ„å»ºæ’è¡Œæ¦œé¡¹
  @Builder
  buildRankingItem(item: RankingItemLocal, index: number) {
    Column() {
      Row({ space: 16 }) {
        // æ’åå¾½ç« 
        Column({ space: 2 }) {
          Text(item.rank.toString())
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(item.rank <= 3 ? Color.White : '#333333')
        }
        .width(36)
        .height(36)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor(this.getRankBadgeColor(item.rank))
        .borderRadius(18)

        // ç”¨æˆ·ä¿¡æ¯
        Row({ space: 12 }) {
          // å¤´åƒ - ç¡®ä¿ avatar ä¸ä¸ºç©º
          if (item.avatar && item.avatar.trim() !== '') {
            Image(item.avatar)
              .width(40)
              .height(40)
              .objectFit(ImageFit.Cover)
              .borderRadius(20)
          } else {
            // é»˜è®¤å¤´åƒ
            Column() {
              Text('ğŸ‘¤')
                .fontSize(20)
                .fontColor('#666666')
            }
            .width(40)
            .height(40)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
            .backgroundColor('#F0F0F0')
            .borderRadius(20)
          }

          // ç”¨æˆ·è¯¦æƒ…
          Column({ space: 4 }) {
            Row({ space: 8 }) {
              Text(item.nickname || item.username || 'æœªçŸ¥ç”¨æˆ·')
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .layoutWeight(1)

              // è¶‹åŠ¿å›¾æ ‡
              if (item.trend !== 'stable') {
                Text(this.getTrendIcon(item.trend))
                  .fontSize(12)
                  .fontColor(this.getTrendColor(item.trend))
              }
            }

            Text(`@${item.username || 'unknown'}`)
              .fontSize(11)
              .fontColor('#999999')
          }
          .layoutWeight(1)
        }
        .layoutWeight(1)

        // ç»¼åˆè¯„åˆ†
        Column({ space: 2 }) {
          Text(item.score.toFixed(1))
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF3B30')

          Text('è¯„åˆ†')
            .fontSize(10)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })

      // åˆ†éš”çº¿ï¼ˆä¸æ˜¯æœ€åä¸€é¡¹æ—¶æ˜¾ç¤ºï¼‰
      if (index < this.rankingList.length - 1) {
        Divider()
          .color('#F0F0F0')
          .margin({ left: 68, right: 16 })
          .strokeWidth(0.5)
      }
    }
  }

  // æ„å»ºæ’è¡Œæ¦œåˆ—è¡¨
  @Builder
  buildRankingList() {
    Column() {
      // APIå¤±è´¥æç¤º
      this.buildApiFailNotice()

      // åˆ—è¡¨æ ‡é¢˜
      Row({ space: 8 }) {
        Text(`${this.getTimeDimensionText()}æ’è¡Œæ¦œ`)
          .fontSize(18)
          .fontColor('#333333')
          .fontWeight(FontWeight.Bold)

        Text(`å…±${this.rankingList.length}äºº`)
          .fontSize(12)
          .fontColor('#666666')
          .backgroundColor('#F0F0F0')
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .borderRadius(10)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 16 })

      // æ’è¡Œæ¦œåˆ—è¡¨
      if (this.rankingList.length > 0) {
        Column({ space: 0 }) {
          ForEach(this.rankingList, (item: RankingItemLocal, index: number) => {
            this.buildRankingItem(item, index)
          })
        }
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ left: 16, right: 16 })
        .shadow({ radius: 4, color: '#00000008' })

        // è¯¦ç»†æ•°æ®å±•ç¤º
        if (this.rankingList.length > 0) {
          Column({ space: 8 }) {
            Row({ space: 12 }) {
              Column({ space: 2 }) {
                Text(this.rankingList[0].checkinCount.toString())
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#34C759')

                Text('æœ€é«˜æ‰“å¡')
                  .fontSize(10)
                  .fontColor('#999999')
              }
              .alignItems(HorizontalAlign.Center)
              .layoutWeight(1)

              Column({ space: 2 }) {
                Text(this.rankingList[0].likeCount.toString())
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#007AFF')

                Text('æœ€é«˜ç‚¹èµ')
                  .fontSize(10)
                  .fontColor('#999999')
              }
              .alignItems(HorizontalAlign.Center)
              .layoutWeight(1)

              Column({ space: 2 }) {
                Text(this.rankingList[0].points.toString())
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#FF9500')

                Text('æœ€é«˜ç§¯åˆ†')
                  .fontSize(10)
                  .fontColor('#999999')
              }
              .alignItems(HorizontalAlign.Center)
              .layoutWeight(1)
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          }
          .backgroundColor('#F8F9FF')
          .borderRadius(12)
          .margin({ left: 16, right: 16, top: 12 })
          .shadow({ radius: 2, color: '#00000004' })
        }
      } else {
        // ç©ºçŠ¶æ€
        Column({ space: 16 }) {
          Text('ğŸ†')
            .fontSize(60)
            .fontColor('#FFD700')

          Text('æš‚æ— æ’è¡Œæ¦œæ•°æ®')
            .fontSize(16)
            .fontColor('#999999')

          Text('å¿«æ¥æ‰“å¡è·å–ç§¯åˆ†ï¼Œå†²ä¸Šæ’è¡Œæ¦œå§ï¼')
            .fontSize(14)
            .fontColor('#CCCCCC')
        }
        .width('100%')
        .padding(40)
        .alignItems(HorizontalAlign.Center)
      }

      // åº•éƒ¨è¯´æ˜
      Column({ space: 8 }) {
        Row({ space: 8 }) {
          Text('ğŸ“ˆ')
            .fontSize(12)
            .fontColor('#666666')

          Text('æ¦œå•æ¯15åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡')
            .fontSize(12)
            .fontColor('#999999')
        }

        Row({ space: 8 }) {
          Text('ğŸ’¡')
            .fontSize(12)
            .fontColor('#666666')

          Text('å¤šå‘ä¼˜è´¨å†…å®¹å¯ä»¥è·å¾—æ›´å¤šç‚¹èµå“¦ï¼')
            .fontSize(12)
            .fontColor('#999999')
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 20 })
      .alignItems(HorizontalAlign.Start)
    }
  }

  // æ„å»ºåŠ è½½çŠ¶æ€
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007AFF')

      Text('åŠ è½½æ’è¡Œæ¦œæ•°æ®ä¸­...')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .fontColor('#333333')
          .onClick(() => this.goBack())

        // æ ‡é¢˜
        Text('æ—…è¡Œæ’è¡Œæ¦œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // åˆ·æ–°æŒ‰é’®
        Button('åˆ·æ–°')
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007AFF')
          .onClick(() => {
            this.refreshData();
          })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 0 }) {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (this.isLoading && !this.isRefreshing) {
            this.buildLoadingView()
          } else {
            // æ—¶é—´ç­›é€‰å™¨
            this.buildTimeFilter()

            // æ’è¡Œæ¦œåˆ—è¡¨
            this.buildRankingList()

            // åº•éƒ¨å®‰å…¨åŒºåŸŸå ä½
            Row()
              .height(40)
              .width('100%')
          }
        }
        .width('100%')
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
      .onScrollEdge((side: Edge) => {
        if (side === Edge.Top) {
          this.refreshData();
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}