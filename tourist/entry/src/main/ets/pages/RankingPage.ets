// entry/src/main/ets/pages/RankingPage.ets

import { router } from '@kit.ArkUI';

// æ’è¡Œæ¦œé¡¹æ¥å£å®šä¹‰
interface RankingItem {
  rank: number;          // æ’å
  userId: number;       // ç”¨æˆ·ID
  username: string;     // ç”¨æˆ·å
  nickname: string;     // ç”¨æˆ·æ˜µç§°
  avatar: string;       // ç”¨æˆ·å¤´åƒ
  score: number;       // ç»¼åˆå¾—åˆ†
  checkinCount: number; // æ‰“å¡æ¬¡æ•°
  likeCount: number;    // ç‚¹èµæ•°é‡
  points: number;       // ç§¯åˆ†
  trend: 'up' | 'down' | 'stable' | 'new'; // æ’åè¶‹åŠ¿
}

// æ—¶é—´ç»´åº¦ç±»å‹
type TimeDimension = 'daily' | 'weekly' | 'monthly';

// æ—¶é—´ç»´åº¦é€‰é¡¹
interface TimeOption {
  label: string;
  value: TimeDimension;
}

@Entry
@Component
struct RankingPage {
  // æ’è¡Œæ¦œæ•°æ®
  @State rankingList: Array<RankingItem> = [];

  // å½“å‰æ—¶é—´ç»´åº¦
  @State currentTimeDimension: TimeDimension = 'daily';

  // æ—¶é—´ç»´åº¦é€‰é¡¹
  private timeOptions: Array<TimeOption> = [
    { label: 'ä»Šæ—¥', value: 'daily' },
    { label: 'æœ¬å‘¨', value: 'weekly' },
    { label: 'æœ¬æœˆ', value: 'monthly' }
  ];

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;

  // ç”¨æˆ·è‡ªå·±çš„æ’åä¿¡æ¯ - åˆå§‹åŒ–ä¸º null
  @State myRanking: RankingItem | null = null;
  @State showMyRanking: boolean = true;

  // ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    console.log('æ’è¡Œæ¦œé¡µé¢æ˜¾ç¤º');
    this.loadRankingData();
  }

  // åŠ è½½æ’è¡Œæ¦œæ•°æ®ï¼ˆä½¿ç”¨å‡æ•°æ®ï¼‰
  private loadRankingData() {
    this.isLoading = true;

    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      // ç”Ÿæˆå‡æ•°æ®
      this.generateMockData();
      this.isLoading = false;
      this.isRefreshing = false;
      console.log(`âœ… åŠ è½½${this.getTimeDimensionText()}æ’è¡Œæ¦œæ•°æ®æˆåŠŸ`);
    }, 800);
  }

  // ç”Ÿæˆå‡æ•°æ®
  private generateMockData() {
    const mockData: Array<RankingItem> = [];
    const baseCheckinCount = [45, 38, 32, 28, 25, 22, 20, 18, 16, 15];
    const baseLikeCount = [1200, 950, 780, 620, 520, 450, 380, 320, 280, 240];

    // æ ¹æ®æ—¶é—´ç»´åº¦è°ƒæ•´æ•°æ®
    let timeMultiplier = 1;
    if (this.currentTimeDimension === 'weekly') {
      timeMultiplier = 7;
    } else if (this.currentTimeDimension === 'monthly') {
      timeMultiplier = 30;
    }

    // ç”Ÿæˆ10ä¸ªå‡æ•°æ®
    for (let i = 0; i < 10; i++) {
      const checkinCount = baseCheckinCount[i] * timeMultiplier;
      const likeCount = baseLikeCount[i] * timeMultiplier;
      const score = Math.round((checkinCount * 3 + likeCount * 0.1) * 10) / 10; // ç»¼åˆå¾—åˆ†å…¬å¼

      // éšæœºè¶‹åŠ¿
      const trends: Array<'up' | 'down' | 'stable' | 'new'> = ['up', 'down', 'stable'];
      const trend = i < 3 ? 'up' : (i > 7 ? 'new' : trends[Math.floor(Math.random() * trends.length)]);

      mockData.push({
        rank: i + 1,
        userId: 1000 + i,
        username: `user${1000 + i}`,
        nickname: ['æ—…è¡Œè¾¾äºº', 'æ¢é™©å®¶', 'æ‘„å½±å¤§å¸ˆ', 'ç¾é£ŸçŒäºº', 'æ–‡åŒ–ä½¿è€…', 'å¾’æ­¥çˆ±å¥½è€…', 'éª‘è¡Œä¾ ', 'èƒŒåŒ…å®¢', 'é£æ™¯æ”¶è—å®¶', 'è®°å½•è€…'][i],
        avatar: `https://avatars.githubusercontent.com/u/${1000 + i}?v=4`,
        score: score,
        checkinCount: checkinCount,
        likeCount: likeCount,
        points: Math.floor(score * 10),
        trend: trend
      });
    }

    this.rankingList = mockData;

    // ç”Ÿæˆç”¨æˆ·è‡ªå·±çš„å‡æ•°æ®ï¼ˆæ¨¡æ‹Ÿå½“å‰ç”¨æˆ·ï¼‰
    this.myRanking = {
      rank: Math.floor(Math.random() * 50) + 25, // 25-75åä¹‹é—´
      userId: 9999,
      username: 'currentUser',
      nickname: 'æˆ‘',
      avatar: 'https://avatars.githubusercontent.com/u/9999?v=4',
      score: Math.round((baseCheckinCount[5] * timeMultiplier * 3 + baseLikeCount[5] * timeMultiplier * 0.1) * 10) / 10,
      checkinCount: baseCheckinCount[5] * timeMultiplier,
      likeCount: baseLikeCount[5] * timeMultiplier,
      points: Math.floor(baseCheckinCount[5] * timeMultiplier * 10),
      trend: Math.random() > 0.5 ? 'up' : 'stable'
    };
  }

  // åˆ‡æ¢æ—¶é—´ç»´åº¦
  private changeTimeDimension(dimension: TimeDimension) {
    if (this.currentTimeDimension === dimension) {
      return;
    }

    this.currentTimeDimension = dimension;
    this.isLoading = true;
    this.loadRankingData();
  }

  // è·å–æ—¶é—´ç»´åº¦æ–‡æœ¬
  private getTimeDimensionText(): string {
    switch (this.currentTimeDimension) {
      case 'daily':
        return 'ä»Šæ—¥';
      case 'weekly':
        return 'æœ¬å‘¨';
      case 'monthly':
        return 'æœ¬æœˆ';
      default:
        return '';
    }
  }

  // åˆ·æ–°æ•°æ®
  private refreshData() {
    this.isRefreshing = true;
    this.loadRankingData();
  }

  // è·å–æ’åè¶‹åŠ¿å›¾æ ‡
  private getTrendIcon(trend: 'up' | 'down' | 'stable' | 'new'): string {
    switch (trend) {
      case 'up':
        return 'â†‘';
      case 'down':
        return 'â†“';
      case 'stable':
        return 'â†’';
      case 'new':
        return 'âœ¨';
      default:
        return '';
    }
  }

  // è·å–æ’åè¶‹åŠ¿é¢œè‰²
  private getTrendColor(trend: 'up' | 'down' | 'stable' | 'new'): ResourceColor {
    switch (trend) {
      case 'up':
        return '#FF3B30';
      case 'down':
        return '#007AFF';
      case 'stable':
        return '#666666';
      case 'new':
        return '#FF9500';
      default:
        return '#666666';
    }
  }

  // è·å–æ’åå¾½ç« é¢œè‰²
  private getRankBadgeColor(rank: number): string {
    switch (rank) {
      case 1:
        return '#FFD700'; // é‡‘è‰²
      case 2:
        return '#C0C0C0'; // é“¶è‰²
      case 3:
        return '#CD7F32'; // é“œè‰²
      default:
        return '#34C759'; // ç»¿è‰²
    }
  }

  // æ„å»ºæ—¶é—´ç­›é€‰å™¨
  @Builder
  buildTimeFilter() {
    Column({ space: 12 }) {
      Text('æ’è¡Œæ¦œ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .textAlign(TextAlign.Start)
        .width('100%')

      Row({ space: 8 }) {
        ForEach(this.timeOptions, (option: TimeOption) => {
          Button(option.label) {
            Text(option.label)
              .fontSize(14)
              .fontColor(this.currentTimeDimension === option.value ? Color.White : '#666666')
          }
          .backgroundColor(this.currentTimeDimension === option.value ? '#007AFF' : '#F5F5F5')
          .borderRadius(20)
          .padding({ left: 20, right: 20 })
          .height(36)
          .onClick(() => {
            this.changeTimeDimension(option.value);
          })
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)

      // æ’è¡Œæ¦œè§„åˆ™è¯´æ˜
      Row({ space: 8 }) {
        Text('ğŸ“Š')
          .fontSize(14)
          .fontColor('#666666')

        Text('ç»¼åˆå¾—åˆ† = æ‰“å¡æ¬¡æ•°Ã—3 + ç‚¹èµæ•°Ã—0.1')
          .fontSize(12)
          .fontColor('#999999')
          .lineHeight(16)
      }
      .width('100%')
      .padding({ top: 4, bottom: 4 })
    }
    .padding({ left: 16, right: 16, top: 16, bottom: 12 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 16 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  // æ„å»ºç”¨æˆ·è‡ªå·±çš„æ’åå¡ç‰‡
  @Builder
  buildMyRankingCard() {
    // æ£€æŸ¥ myRanking æ˜¯å¦ä¸º null
    if (!this.myRanking || !this.showMyRanking) {

    }

    // ä½¿ç”¨ myRanking! è¡¨ç¤ºæˆ‘ä»¬çŸ¥é“å®ƒä¸ä¸º null
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('æˆ‘çš„æ’å')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333333')

        // åˆ‡æ¢æ˜¾ç¤º/éšè—æŒ‰é’®
        Button(this.showMyRanking ? 'éšè—' : 'æ˜¾ç¤º') {
          Text(this.showMyRanking ? 'éšè—' : 'æ˜¾ç¤º')
            .fontSize(12)
            .fontColor('#007AFF')
        }
        .backgroundColor(Color.Transparent)
        .borderRadius(12)
        .padding({ left: 8, right: 8 })
        .height(24)
        .onClick(() => {
          this.showMyRanking = !this.showMyRanking;
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)

      // æˆ‘çš„æ’åä¿¡æ¯
      Column({ space: 0 }) {
        Row({ space: 16 }) {
          // æ’å
          Column({ space: 2 }) {
            Text(`#${this.myRanking!.rank}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9500')

            // è¶‹åŠ¿
            Row({ space: 2 }) {
              Text(this.getTrendIcon(this.myRanking!.trend))
                .fontSize(12)
                .fontColor(this.getTrendColor(this.myRanking!.trend))

              Text(this.myRanking!.trend === 'up' ? 'ä¸Šå‡' : this.myRanking!.trend === 'down' ? 'ä¸‹é™' : 'ç¨³å®š')
                .fontSize(10)
                .fontColor('#999999')
            }
          }
          .alignItems(HorizontalAlign.Center)
          .width(60)

          // ç”¨æˆ·ä¿¡æ¯
          Row({ space: 12 }) {
            // å¤´åƒ - ç¡®ä¿ avatar ä¸ä¸ºç©º
            if (this.myRanking!.avatar && this.myRanking!.avatar.trim() !== '') {
              Image(this.myRanking!.avatar)
                .width(48)
                .height(48)
                .objectFit(ImageFit.Cover)
                .borderRadius(24)
            } else {
              // é»˜è®¤å¤´åƒ
              Column() {
                Text('ğŸ‘¤')
                  .fontSize(24)
                  .fontColor('#666666')
              }
              .width(48)
              .height(48)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .backgroundColor('#F0F0F0')
              .borderRadius(24)
            }

            // ç”¨æˆ·è¯¦æƒ…
            Column({ space: 4 }) {
              Row({ space: 8 }) {
                Text(this.myRanking!.nickname || 'æœªçŸ¥ç”¨æˆ·')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')

                // è¶‹åŠ¿å›¾æ ‡
                if (this.myRanking!.trend === 'new') {
                  Text('âœ¨')
                    .fontSize(12)
                    .fontColor('#FF9500')
                }
              }

              Text(`@${this.myRanking!.username || 'unknown'}`)
                .fontSize(12)
                .fontColor('#999999')
            }
          }
          .layoutWeight(1)

          // ç»¼åˆå¾—åˆ†
          Column({ space: 2 }) {
            Text(`${this.myRanking!.score}`)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF3B30')

            Text('ç»¼åˆå¾—åˆ†')
              .fontSize(10)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.End)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })

        // ç»Ÿè®¡æ•°æ®
        Row({ space: 16 }) {
          Column({ space: 2 }) {
            Text(this.myRanking!.checkinCount.toString())
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#34C759')

            Text('æ‰“å¡')
              .fontSize(10)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Center)
          .layoutWeight(1)

          Column({ space: 2 }) {
            Text(this.myRanking!.likeCount.toString())
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#007AFF')

            Text('ç‚¹èµ')
              .fontSize(10)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Center)
          .layoutWeight(1)

          Column({ space: 2 }) {
            Text(this.myRanking!.points.toString())
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FF9500')

            Text('ç§¯åˆ†')
              .fontSize(10)
              .fontColor('#999999')
          }
          .alignItems(HorizontalAlign.Center)
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 16 })
      }
      .backgroundColor('#F8F9FF')
      .borderRadius(12)
    }
    .padding({ left: 16, right: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  // æ„å»ºæ’è¡Œæ¦œé¡¹
  @Builder
  buildRankingItem(item: RankingItem, index: number) {
    Column() {
      Row({ space: 16 }) {
        // æ’åå¾½ç« 
        Column({ space: 2 }) {
          Text(item.rank.toString())
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(item.rank <= 3 ? Color.White : '#333333')
        }
        .width(36)
        .height(36)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor(this.getRankBadgeColor(item.rank))
        .borderRadius(18)

        // ç”¨æˆ·ä¿¡æ¯
        Row({ space: 12 }) {
          // å¤´åƒ - ç¡®ä¿ avatar ä¸ä¸ºç©º
          if (item.avatar && item.avatar.trim() !== '') {
            Image(item.avatar)
              .width(40)
              .height(40)
              .objectFit(ImageFit.Cover)
              .borderRadius(20)
          } else {
            // é»˜è®¤å¤´åƒ
            Column() {
              Text('ğŸ‘¤')
                .fontSize(20)
                .fontColor('#666666')
            }
            .width(40)
            .height(40)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
            .backgroundColor('#F0F0F0')
            .borderRadius(20)
          }

          // ç”¨æˆ·è¯¦æƒ…
          Column({ space: 4 }) {
            Row({ space: 8 }) {
              Text(item.nickname || 'æœªçŸ¥ç”¨æˆ·')
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .layoutWeight(1)

              // è¶‹åŠ¿å›¾æ ‡
              if (item.trend !== 'stable') {
                Text(this.getTrendIcon(item.trend))
                  .fontSize(12)
                  .fontColor(this.getTrendColor(item.trend))
              }
            }

            Text(`@${item.username || 'unknown'}`)
              .fontSize(11)
              .fontColor('#999999')
          }
          .layoutWeight(1)
        }
        .layoutWeight(1)

        // ç»¼åˆå¾—åˆ†
        Column({ space: 2 }) {
          Text(item.score.toString())
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF3B30')

          Text('å¾—åˆ†')
            .fontSize(10)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.End)
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })

      // åˆ†éš”çº¿ï¼ˆä¸æ˜¯æœ€åä¸€é¡¹æ—¶æ˜¾ç¤ºï¼‰
      if (index < this.rankingList.length - 1) {
        Divider()
          .color('#F0F0F0')
          .margin({ left: 68, right: 16 })
          .strokeWidth(0.5)
      }
    }
  }

  // æ„å»ºæ’è¡Œæ¦œåˆ—è¡¨
  @Builder
  buildRankingList() {
    Column() {
      // åˆ—è¡¨æ ‡é¢˜
      Row({ space: 8 }) {
        Text(`${this.getTimeDimensionText()}æ’è¡Œæ¦œ`)
          .fontSize(18)
          .fontColor('#333333')
          .fontWeight(FontWeight.Bold)

        Text(`å…±${this.rankingList.length}äºº`)
          .fontSize(12)
          .fontColor('#666666')
          .backgroundColor('#F0F0F0')
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .borderRadius(10)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 16 })

      // æ’è¡Œæ¦œåˆ—è¡¨
      if (this.rankingList.length > 0) {
        Column({ space: 0 }) {
          ForEach(this.rankingList, (item: RankingItem, index: number) => {
            this.buildRankingItem(item, index)
          })
        }
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ left: 16, right: 16 })
        .shadow({ radius: 4, color: '#00000008' })
      } else {
        // ç©ºçŠ¶æ€
        Column({ space: 16 }) {
          Text('ğŸ†')
            .fontSize(60)
            .fontColor('#FFD700')

          Text('æš‚æ— æ’è¡Œæ¦œæ•°æ®')
            .fontSize(16)
            .fontColor('#999999')

          Text('å¿«æ¥æ‰“å¡è·å–ç§¯åˆ†ï¼Œå†²ä¸Šæ’è¡Œæ¦œå§ï¼')
            .fontSize(14)
            .fontColor('#CCCCCC')
        }
        .width('100%')
        .padding(40)
        .alignItems(HorizontalAlign.Center)
      }

      // åº•éƒ¨è¯´æ˜
      Column({ space: 8 }) {
        Row({ space: 8 }) {
          Text('ğŸ“ˆ')
            .fontSize(12)
            .fontColor('#666666')

          Text('æ¦œå•æ¯15åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡')
            .fontSize(12)
            .fontColor('#999999')
        }

        Row({ space: 8 }) {
          Text('ğŸ’¡')
            .fontSize(12)
            .fontColor('#666666')

          Text('å¤šå‘ä¼˜è´¨å†…å®¹å¯ä»¥è·å¾—æ›´å¤šç‚¹èµå“¦ï¼')
            .fontSize(12)
            .fontColor('#999999')
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 20 })
      .alignItems(HorizontalAlign.Start)
    }
  }

  // æ„å»ºåŠ è½½çŠ¶æ€
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007AFF')

      Text('åŠ è½½æ’è¡Œæ¦œæ•°æ®ä¸­...')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .fontColor('#333333')
          .onClick(() => this.goBack())

        // æ ‡é¢˜
        Text('æ—…è¡Œæ’è¡Œæ¦œ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // åˆ·æ–°æŒ‰é’®
        Button('åˆ·æ–°')
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007AFF')
          .onClick(() => {
            this.refreshData();
          })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 0 }) {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (this.isLoading && !this.isRefreshing) {
            this.buildLoadingView()
          } else {
            // æ—¶é—´ç­›é€‰å™¨
            this.buildTimeFilter()

            // æˆ‘çš„æ’åå¡ç‰‡
            this.buildMyRankingCard()

            // æ’è¡Œæ¦œåˆ—è¡¨
            this.buildRankingList()

            // åº•éƒ¨å®‰å…¨åŒºåŸŸå ä½
            Row()
              .height(40)
              .width('100%')
          }
        }
        .width('100%')
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
      .onScrollEdge((side: Edge) => {
        if (side === Edge.Top) {
          this.refreshData();
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}