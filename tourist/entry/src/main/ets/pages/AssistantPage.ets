// entry/src/main/ets/pages/AssistantPage.ets

import { router } from '@kit.ArkUI';
import { askSimple, AskAssistantApiResponse } from '../api/assistant';

// æ¶ˆæ¯ç±»å‹å®šä¹‰
interface GeneratedTypeLiteralInterface_1 {
  type: string;
  id: number;
  name: string;
  latitude: number;
  longitude: number;
  distance: number;
}

interface Message {
  id: number;
  content: string;
  isUser: boolean;  // true: ç”¨æˆ·æ¶ˆæ¯, false: åŠ©æ‰‹æ¶ˆæ¯
  timestamp: number;
  recommendations?: GeneratedTypeLiteralInterface_1[];  // åŠ©æ‰‹æ¶ˆæ¯çš„æ¨èåˆ—è¡¨ - å†…è”å®šä¹‰
}

interface GeneratedTypeLiteralInterface_2 {
  type: string;
  id: number;
  name: string;
  latitude: number;
  longitude: number;
  distance: number;
}

interface GeneratedTypeLiteralInterface_3 {
  type: string;
  id: number;
  name: string;
  latitude: number;
  longitude: number;
  distance: number;
}

@Entry
@Component
struct AssistantPage {
  @State messages: Message[] = [];
  @State inputText: string = '';
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State showError: boolean = false;

  // ç”¨äºç”Ÿæˆæ¶ˆæ¯ID
  private messageIdCounter: number = 0;

  // ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    console.log('æ™ºèƒ½é—®ç­”é¡µé¢æ˜¾ç¤º');
    // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
    this.addWelcomeMessage();
  }

  // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
  private addWelcomeMessage() {
    const welcomeMessage: Message = {
      id: this.getMessageId(),
      content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ—…è¡Œæ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥ä¸ºæ‚¨æ¨èæ™¯ç‚¹ã€é¤å…ï¼Œè§£ç­”æ—…è¡Œç›¸å…³é—®é¢˜ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
      isUser: false,
      timestamp: Date.now()
    };
    this.messages = [welcomeMessage];
  }

  // ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID
  private getMessageId(): number {
    return ++this.messageIdCounter;
  }

  // å‘é€æ¶ˆæ¯
  private async sendMessage() {
    if (!this.inputText.trim() || this.isLoading) {
      return;
    }

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage: Message = {
      id: this.getMessageId(),
      content: this.inputText.trim(),
      isUser: true,
      timestamp: Date.now()
    };

    this.messages = [...this.messages, userMessage];
    const userInput = this.inputText;
    this.inputText = '';
    this.isLoading = true;
    this.showError = false;

    // å‘é€åˆ°æ™ºèƒ½åŠ©æ‰‹
    try {
      const result = await askSimple(userInput);

      if (result && result.code === 200 && result.data) {
        // æ·»åŠ åŠ©æ‰‹å›å¤
        const assistantMessage: Message = {
          id: this.getMessageId(),
          content: result.data.answer,
          isUser: false,
          timestamp: Date.now(),
          recommendations: result.data.recommendations || []
        };

        this.messages = [...this.messages, assistantMessage];
        console.log('âœ… åŠ©æ‰‹å›å¤æˆåŠŸï¼ŒåŒ…å«æ¨è:', result.data.recommendations?.length || 0);
      } else {
        // å¤„ç†é”™è¯¯å“åº” - ä½¿ç”¨msgå­—æ®µ
        let errorMsg = 'æ™ºèƒ½åŠ©æ‰‹æš‚æ—¶æ— æ³•å“åº”ï¼Œè¯·ç¨åå†è¯•';
        if (result && result.msg) {
          errorMsg = result.msg;
          console.log('âŒ æ™ºèƒ½åŠ©æ‰‹è¿”å›é”™è¯¯:', result.msg);
        } else if (result && result.code === 1201) {
          errorMsg = 'è¯·å…ˆç™»å½•åå†ä½¿ç”¨æ™ºèƒ½åŠ©æ‰‹åŠŸèƒ½';
          console.log('âŒ ç”¨æˆ·æœªç™»å½•æˆ–Tokenæ— æ•ˆ');
        }
        this.showErrorToast(errorMsg);
      }
    } catch (error) {
      console.error('è¯·æ±‚æ™ºèƒ½åŠ©æ‰‹å¼‚å¸¸:', error);
      this.showErrorToast('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    } finally {
      this.isLoading = false;
    }
  }

  // æ˜¾ç¤ºé”™è¯¯æç¤º
  private showErrorToast(message: string) {
    this.errorMessage = message;
    this.showError = true;

    // 3ç§’åè‡ªåŠ¨éšè—é”™è¯¯æç¤º
    setTimeout(() => {
      this.showError = false;
    }, 3000);
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }

  // æ„å»ºæ¨èå†…å®¹
  @Builder
  buildRecommendations(recommendations: GeneratedTypeLiteralInterface_2[]) {
    if (!recommendations || recommendations.length === 0) {

    }

    Column({ space: 10 }) {
      Text('âœ¨ ç›¸å…³æ¨è')
        .fontSize(14)
        .fontColor('#666666')
        .fontWeight(FontWeight.Medium)
        .margin({ top: 8 })

      ForEach(recommendations, (item: GeneratedTypeLiteralInterface_3) => {
        Column({ space: 4 }) {
          Row({ space: 8 }) {
            // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
            if (item.type === 'restaurant') {
              Text('ğŸ½ï¸')
                .fontSize(16)
            } else if (item.type === 'spot') {
              Text('ğŸ“')
                .fontSize(16)
            } else {
              Text('â­')
                .fontSize(16)
            }

            Column({ space: 2 }) {
              Text(item.name)
                .fontSize(15)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start)
                .width('100%')

              Row({ space: 12 }) {
                if (item.distance > 0) {
                  Text(`è·ç¦»${item.distance}ç±³`)
                    .fontSize(12)
                    .fontColor('#666666')
                }

                if (item.type) {
                  Text(item.type === 'restaurant' ? 'é¤å…' : 'æ™¯ç‚¹')
                    .fontSize(12)
                    .fontColor('#007AFF')
                    .backgroundColor('#E6F2FF')
                    .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                    .borderRadius(4)
                }
              }
              .margin({ top: 2 })
            }
            .layoutWeight(1)
          }
          .width('100%')
          .padding({ left: 12, right: 12, top: 10, bottom: 10 })
          .backgroundColor('#F9F9F9')
          .borderRadius(8)
          .border({ width: 1, color: '#EEEEEE' })

          // åˆ†éš”çº¿
          if (item.id !== recommendations[recommendations.length - 1].id) {
            Divider()
              .color('#F0F0F0')
              .margin({ left: 20, right: 20 })
              .strokeWidth(0.5)
          }
        }
        .width('100%')
      })
    }
    .width('100%')
    .margin({ top: 12, bottom: 8 })
  }

  // æ„å»ºç”¨æˆ·æ¶ˆæ¯ï¼ˆå³å¯¹é½ï¼‰
  @Builder
  buildUserMessage(message: Message) {
    Row() {
      // å ä½ç©ºé—´
      Blank()
        .layoutWeight(1)

      // æ¶ˆæ¯å†…å®¹
      Column({ space: 4 }) {
        Text(message.content)
          .fontSize(16)
          .fontColor(Color.White)
          .textAlign(TextAlign.Start)
          .width('100%')

        Text(this.formatTime(message.timestamp))
          .fontSize(11)
          .fontColor('#999999')
          .margin({ top: 2 })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#007AFF')
      .borderRadius(12)
      .border({ width: 1, color: '#007AFF' })
      .width('80%')
    }
    .width('100%')
    .margin({ top: 8, bottom: 8 })
  }

  // æ„å»ºåŠ©æ‰‹æ¶ˆæ¯ï¼ˆå·¦å¯¹é½ï¼‰
  @Builder
  buildAssistantMessage(message: Message) {
    Row() {
      // æ¶ˆæ¯å†…å®¹
      Column({ space: 4 }) {
        Text(message.content)
          .fontSize(16)
          .fontColor('#333333')
          .textAlign(TextAlign.Start)
          .width('100%')

        Text(this.formatTime(message.timestamp))
          .fontSize(11)
          .fontColor('#999999')
          .margin({ top: 2 })

        // æ¨èå†…å®¹
        if (message.recommendations && message.recommendations.length > 0) {
          this.buildRecommendations(message.recommendations)
        }
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor('#F0F0F0')
      .borderRadius(12)
      .border({ width: 1, color: '#E0E0E0' })
      .width('80%')

      // å ä½ç©ºé—´
      Blank()
        .layoutWeight(1)
    }
    .width('100%')
    .margin({ top: 8, bottom: 8 })
  }

  // æ„å»ºæ¶ˆæ¯æ°”æ³¡
  @Builder
  buildMessageBubble(message: Message) {
    if (message.isUser) {
      this.buildUserMessage(message)
    } else {
      this.buildAssistantMessage(message)
    }
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .fontColor('#333333')
          .onClick(() => this.goBack())

        // æ ‡é¢˜
        Column({ space: 2 }) {
          Text('æ™ºèƒ½åŠ©æ‰‹')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')

          Text('æ—…è¡Œé—®ç­”ä¸æ¨è')
            .fontSize(12)
            .fontColor('#666666')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)

        // å ä½
        Text('')
          .width(32)
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ
      Stack() {
        Scroll() {
          Column({ space: 0 }) {
            // æ¶ˆæ¯åˆ—è¡¨
            ForEach(this.messages, (message: Message) => {
              this.buildMessageBubble(message)
            })

            // åŠ è½½æŒ‡ç¤ºå™¨
            if (this.isLoading) {
              Column({ space: 8 }) {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .color('#007AFF')

                Text('æ€è€ƒä¸­...')
                  .fontSize(14)
                  .fontColor('#666666')
              }
              .width('100%')
              .padding(20)
              .alignItems(HorizontalAlign.Center)
              .margin({ top: 20, bottom: 20 })
            }
          }
          .padding({ left: 16, right: 16, top: 16, bottom: 16 })
          .width('100%')
        }
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Auto)
        .edgeEffect(EdgeEffect.Spring)

        // é”™è¯¯æç¤º
        if (this.showError) {
          Text(this.errorMessage)
            .fontSize(14)
            .fontColor(Color.White)
            .padding({ left: 16, right: 16, top: 10, bottom: 10 })
            .backgroundColor('#FF3B30')
            .borderRadius(20)
            .margin({ top: 16 })
            .alignSelf(ItemAlign.Center)
        }
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('#F9F9F9')

      // è¾“å…¥åŒºåŸŸ
      Row({ space: 12 }) {
        // è¾“å…¥æ¡†
        TextInput({ text: this.inputText, placeholder: 'è¾“å…¥æ‚¨çš„é—®é¢˜...' })
          .layoutWeight(1)
          .height(44)
          .fontSize(16)
          .fontColor('#333333')
          .backgroundColor(Color.White)
          .border({ width: 1, color: '#E0E0E0' })
          .borderRadius(22)
          .padding({ left: 16, right: 16 })
          .onChange((value: string) => {
            this.inputText = value;
          })
          .onSubmit(() => {
            this.sendMessage();
          })

        // å‘é€æŒ‰é’® - ä½¿ç”¨ä¸Šç®­å¤´
        Button() {
          if (this.isLoading) {
            LoadingProgress()
              .width(20)
              .height(20)
              .color(Color.White)
          } else {
            Text('â†‘')
              .fontSize(20)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
        }
        .width(44)
        .height(44)
        .backgroundColor(this.inputText.trim() && !this.isLoading ? '#007AFF' : '#CCCCCC')
        .borderRadius(22)
        .enabled(!!this.inputText.trim() && !this.isLoading)
        .onClick(() => {
          this.sendMessage();
        })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { top: 1 }, color: '#F0F0F0' })

      // å®‰å…¨åŒºåŸŸå ä½
      Row()
        .height(24)
        .width('100%')
        .backgroundColor(Color.White)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F9F9F9')
  }
}