// entry/src/main/ets/pages/NearbyPage.ets

import { router } from '@kit.ArkUI';
import { getNearbyRecommendations, NearbyItem, NearbyApiResponse } from '../api/recommend';

// é™„è¿‘æ™¯ç‚¹é¡¹æ¥å£å®šä¹‰
interface NearbySpotItem {
  spotId: number;
  name: string;
  description: string;
  images: Array<string>;
  zoneId: number;
  zoneName: string;
  coverImage: string;
  distance: number;  // è·ç¦»ï¼ˆå…¬é‡Œï¼‰
  distanceText: string; // è·ç¦»æ–‡æœ¬ï¼ˆå¦‚ï¼š"500m"ã€"1.2km"ï¼‰
  isRecommended: boolean;
  visitedCount: number;
  rating: number;
  category: string; // æ™¯ç‚¹ç±»åˆ«
  openTime: string; // å¼€æ”¾æ—¶é—´
  price: string;    // ä»·æ ¼ä¿¡æ¯ï¼ˆå¦‚ï¼š"å…è´¹"ã€"Â¥50"")
}

// æ’åºæ–¹å¼ç±»å‹
type SortType = 'distance' | 'rating' | 'popular' | 'recommended';

// æ’åºé€‰é¡¹
interface SortOption {
  label: string;
  value: SortType;
}

// ç­›é€‰é€‰é¡¹
interface FilterOption {
  label: string;
  value: string;
}

@Entry
@Component
struct NearbyPage {
  // é™„è¿‘æ™¯ç‚¹åˆ—è¡¨
  @State nearbySpots: Array<NearbySpotItem> = [];

  // å½“å‰æ’åºæ–¹å¼
  @State currentSort: SortType = 'distance';

  // å½“å‰ç­›é€‰ç±»åˆ«
  @State currentFilter: string = 'å…¨éƒ¨';

  // æ’åºé€‰é¡¹ - æ·»åŠ æ˜ç¡®çš„ç±»å‹å£°æ˜
  private sortOptions: Array<SortOption> = [
    { label: 'è·ç¦»æœ€è¿‘', value: 'distance' },
    { label: 'è¯„åˆ†æœ€é«˜', value: 'rating' },
    { label: 'äººæ°”æœ€æ—º', value: 'popular' },
    { label: 'ç¼–è¾‘æ¨è', value: 'recommended' }
  ];

  // ç­›é€‰ç±»åˆ«é€‰é¡¹ - æ·»åŠ æ˜ç¡®çš„ç±»å‹å£°æ˜
  private filterOptions: Array<FilterOption> = [
    { label: 'å…¨éƒ¨', value: 'å…¨éƒ¨' },
    { label: 'è‡ªç„¶é£å…‰', value: 'è‡ªç„¶é£å…‰' },
    { label: 'å†å²æ–‡åŒ–', value: 'å†å²æ–‡åŒ–' },
    { label: 'ä¼‘é—²å¨±ä¹', value: 'ä¼‘é—²å¨±ä¹' },
    { label: 'ç¾é£Ÿè´­ç‰©', value: 'ç¾é£Ÿè´­ç‰©' },
    { label: 'äº²å­å®¶åº­', value: 'äº²å­å®¶åº­' }
  ];

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;
  @State apiFailed: boolean = false; // APIè°ƒç”¨å¤±è´¥æ ‡è®°

  // å½“å‰ä½ç½®ï¼ˆå‡æ•°æ®ï¼‰
  @State currentLocation: string = 'å½“å‰ä½ç½®';
  @State currentAddress: string = 'XXå¸‚XXåŒºXXè·¯123å·';

  // ç»çº¬åº¦å¸¸é‡
  private latitude: number = 23.112233;
  private longitude: number = 113.332211;

  // ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    console.log('é™„è¿‘æ¨èé¡µé¢æ˜¾ç¤º');
    this.loadNearbyData();
  }

  // åŠ è½½é™„è¿‘æ™¯ç‚¹æ•°æ®ï¼ˆä¼˜å…ˆè°ƒç”¨æ¥å£ï¼‰
  private async loadNearbyData() {
    this.isLoading = true;
    this.apiFailed = false;

    console.log('å¼€å§‹åŠ è½½é™„è¿‘æ¨èæ•°æ®...');

    try {
      // å…ˆå°è¯•è°ƒç”¨æ¥å£è·å–æ•°æ®
      const response = await getNearbyRecommendations({
        latitude: this.latitude,
        longitude: this.longitude,
        sort: this.mapSortTypeToApi(this.currentSort),
        type: 'spot'
      });

      if (response && response.code === 200 && response.data && response.data.list) {
        console.log('âœ… æ¥å£è°ƒç”¨æˆåŠŸï¼Œè·å–åˆ°', response.data.list.length, 'ä¸ªæ¨èé¡¹');
        this.processApiData(response.data.list);
        this.isLoading = false;
        this.isRefreshing = false;
        return;
      } else {
        console.warn('æ¥å£è¿”å›æ•°æ®å¼‚å¸¸ï¼Œä½¿ç”¨å‡æ•°æ®');
        this.apiFailed = true;
      }
    } catch (error) {
      console.error('æ¥å£è°ƒç”¨å¤±è´¥:', error);
      this.apiFailed = true;
    }

    // å¦‚æœæ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å‡æ•°æ®
    console.log('ä½¿ç”¨å‡æ•°æ®');
    this.useMockData();
  }

  // å¤„ç†APIè¿”å›çš„æ•°æ®
  // å¤„ç†APIè¿”å›çš„æ•°æ®
  private processApiData(apiItems: NearbyItem[]) {
    console.log('å¤„ç†APIæ•°æ®:', apiItems);

    // å°†APIæ•°æ®è½¬æ¢ä¸ºé¡µé¢éœ€è¦çš„æ•°æ®æ ¼å¼
    const convertedSpots: NearbySpotItem[] = apiItems.map((item, index) => {
      // è¿™é‡Œéœ€è¦æ ¹æ®APIè¿”å›çš„æ•°æ®ç»“æ„è¿›è¡Œæ˜ å°„
      // ç”±äºAPIè¿”å›çš„å­—æ®µå¯èƒ½ä¸é¡µé¢éœ€è¦çš„ä¸å®Œå…¨ä¸€è‡´ï¼Œè¿™é‡Œåšé€‚é…è½¬æ¢

      // ç”Ÿæˆä¸€äº›æ¨¡æ‹Ÿæ•°æ®æ¥å¡«å……APIå¯èƒ½ç¼ºå°‘çš„å­—æ®µ
      const categories = ['è‡ªç„¶é£å…‰', 'å†å²æ–‡åŒ–', 'ä¼‘é—²å¨±ä¹', 'ç¾é£Ÿè´­ç‰©', 'äº²å­å®¶åº­'];
      const category = categories[index % categories.length];

      const isRecommended = index % 3 === 0; // æ¯3ä¸ªæœ‰ä¸€ä¸ªæ¨è

      // å°†ç±³è½¬æ¢ä¸ºå…¬é‡Œ
      const distanceInKm = item.distance / 1000;

      // æ˜ç¡®åˆ›å»ºç¬¦åˆ NearbySpotItem æ¥å£çš„å¯¹è±¡
      const spotItem: NearbySpotItem = {
        spotId: item.id || index + 1,
        name: item.name || `æ™¯ç‚¹${index + 1}`,
        description: this.generateDescription(category),
        images: item.thumbnail ? [item.thumbnail] : [],
        zoneId: index + 1,
        zoneName: this.getZoneName(category),
        coverImage: item.thumbnail || this.getDefaultImage(category),
        distance: distanceInKm,
        distanceText: this.formatDistance(distanceInKm),
        isRecommended: isRecommended,
        visitedCount: Math.floor(item.popularity * 100) || 500 + index * 100,
        rating: 4.0 + (item.popularity * 0.5) || 4.0 + (index * 0.1),
        category: category,
        openTime: '09:00-17:00',
        price: index % 2 === 0 ? 'å…è´¹' : 'Â¥' + (20 + index * 10)
      };

      return spotItem;
    });

    // æ ¹æ®å½“å‰æ’åºæ–¹å¼æ’åº
    const sortedSpots = this.sortSpots(convertedSpots, this.currentSort);

    // æ ¹æ®å½“å‰ç­›é€‰ç±»åˆ«ç­›é€‰
    if (this.currentFilter !== 'å…¨éƒ¨') {
      this.nearbySpots = sortedSpots.filter(spot => spot.category === this.currentFilter);
    } else {
      this.nearbySpots = sortedSpots;
    }

    console.log('æ•°æ®è½¬æ¢å®Œæˆï¼Œå…±', this.nearbySpots.length, 'ä¸ªæ™¯ç‚¹');
  }

  // ä½¿ç”¨å‡æ•°æ®
  private useMockData() {
    // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
    setTimeout(() => {
      // ç”Ÿæˆå‡æ•°æ®
      this.generateMockData();
      this.isLoading = false;
      this.isRefreshing = false;
      console.log('âœ… ä½¿ç”¨å‡æ•°æ®åŠ è½½æˆåŠŸ');
    }, 800);
  }

  // ç”Ÿæˆæè¿°
  private generateDescription(category: string): string {
    const descriptions: Record<string, string> = {
      'è‡ªç„¶é£å…‰': 'ä¼˜ç¾çš„è‡ªç„¶æ™¯è§‚ï¼Œè®©äººå¿ƒæ—·ç¥æ€¡ï¼Œæµè¿å¿˜è¿”ã€‚',
      'å†å²æ–‡åŒ–': 'å…·æœ‰æ·±åšå†å²æ–‡åŒ–åº•è•´çš„æ™¯ç‚¹ï¼Œå€¼å¾—ç»†ç»†å“å‘³ã€‚',
      'ä¼‘é—²å¨±ä¹': 'é€‚åˆæ”¾æ¾èº«å¿ƒï¼Œäº«å—ä¼‘é—²æ—¶å…‰çš„å¥½å»å¤„ã€‚',
      'ç¾é£Ÿè´­ç‰©': 'ç¾é£Ÿä¸è´­ç‰©çš„å¤©å ‚ï¼Œæ»¡è¶³æ‚¨çš„å‘³è•¾å’Œè´­ç‰©æ¬²ã€‚',
      'äº²å­å®¶åº­': 'é€‚åˆå…¨å®¶å‡ºæ¸¸ï¼Œè®©å­©å­åœ¨ç©è€ä¸­å­¦ä¹ æˆé•¿ã€‚'
    };
    return descriptions[category] || 'ä¸€ä¸ªå€¼å¾—ä¸€æ¸¸çš„æ™¯ç‚¹ã€‚';
  }

  // è·å–åŒºåŸŸåç§°
  private getZoneName(category: string): string {
    const zoneNames: Record<string, string> = {
      'è‡ªç„¶é£å…‰': 'ç”Ÿæ€ä½“éªŒåŒº',
      'å†å²æ–‡åŒ–': 'å†å²æ–‡åŒ–åŒº',
      'ä¼‘é—²å¨±ä¹': 'ä¼‘é—²å¨±ä¹åŒº',
      'ç¾é£Ÿè´­ç‰©': 'ç¾é£Ÿè´­ç‰©åŒº',
      'äº²å­å®¶åº­': 'äº²å­ä¹å›­åŒº'
    };
    return zoneNames[category] || 'ç»¼åˆä½“éªŒåŒº';
  }

  // è·å–é»˜è®¤å›¾ç‰‡
  private getDefaultImage(category: string): string {
    const defaultImages: Record<string, string> = {
      'è‡ªç„¶é£å…‰': 'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=400&auto=format&fit=crop',
      'å†å²æ–‡åŒ–': 'https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w-400&auto=format&fit=crop',
      'ä¼‘é—²å¨±ä¹': 'https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=400&auto=format&fit=crop',
      'ç¾é£Ÿè´­ç‰©': 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&auto=format&fit=crop',
      'äº²å­å®¶åº­': 'https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=400&auto=format&fit=crop'
    };
    return defaultImages[category] || 'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=400&auto=format&fit=crop';
  }

  // æ ¼å¼åŒ–è·ç¦»
  private formatDistance(distanceInKm: number): string {
    if (distanceInKm < 1) {
      return Math.round(distanceInKm * 1000) + 'm';
    } else {
      return distanceInKm.toFixed(1) + 'km';
    }
  }

  // æ˜ å°„æ’åºç±»å‹åˆ°APIå‚æ•°
  private mapSortTypeToApi(sortType: SortType): string {
    const mapping: Record<SortType, string> = {
      'distance': 'distance',
      'rating': 'popularity', // å‡è®¾è¯„åˆ†å¯¹åº”çƒ­åº¦
      'popular': 'popularity',
      'recommended': 'popularity' // æ¨èä¹Ÿä½¿ç”¨çƒ­åº¦
    };
    return mapping[sortType] || 'popularity';
  }

  // ç”Ÿæˆå‡æ•°æ®ï¼ˆä¿ç•™åŸæœ‰çš„å‡æ•°æ®ç”Ÿæˆé€»è¾‘ï¼‰
  private generateMockData() {
    // æ˜ç¡®å£°æ˜æ•°ç»„ç±»å‹
    const baseSpots: Array<NearbySpotItem> = [
      {
        spotId: 1,
        name: 'å¤å»ºç­‘ç¾¤',
        description: 'ä¿å­˜å®Œå¥½çš„æ˜æ¸…æ—¶æœŸå¤å»ºç­‘ç¾¤ï¼Œå±•ç¤ºäº†å¤ä»£å»ºç­‘è‰ºæœ¯çš„ç²¾é«“ã€‚',
        images: ['https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w=800&auto=format&fit=crop'],
        zoneId: 5,
        zoneName: 'å†å²æ–‡åŒ–åŒº',
        coverImage: 'https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w=400&auto=format&fit=crop',
        distance: 0.5,
        distanceText: '500m',
        isRecommended: true,
        visitedCount: 1250,
        rating: 4.7,
        category: 'å†å²æ–‡åŒ–',
        openTime: '09:00-17:00',
        price: 'Â¥40'
      },
      {
        spotId: 2,
        name: 'ç‰¹è‰²ç¾é£Ÿè¡—',
        description: 'æ±‡èšå„åœ°ç‰¹è‰²å°åƒå’Œä¼ ç»Ÿç¾é£Ÿï¼Œä½“éªŒåœ°é“é£å‘³ã€‚',
        images: ['https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&auto=format&fit=crop'],
        zoneId: 6,
        zoneName: 'ä¼‘é—²å¨±ä¹åŒº',
        coverImage: 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&auto=format&fit=crop',
        distance: 0.8,
        distanceText: '800m',
        isRecommended: true,
        visitedCount: 1800,
        rating: 4.9,
        category: 'ç¾é£Ÿè´­ç‰©',
        openTime: '10:00-22:00',
        price: 'å…è´¹'
      },
      {
        spotId: 3,
        name: 'ç”Ÿæ€æ¹¿åœ°å…¬å›­',
        description: 'åŸç”Ÿæ¹¿åœ°ç”Ÿæ€ç³»ç»Ÿï¼Œè§‚é¸Ÿã€å¾’æ­¥ã€è‡ªç„¶æ•™è‚²çš„å¥½å»å¤„ã€‚',
        images: ['https://images.unsplash.com/photo-1501854140801-50d01698950b?w=800&auto=format&fit=crop'],
        zoneId: 2,
        zoneName: 'ç”Ÿæ€ä½“éªŒåŒº',
        coverImage: 'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=400&auto=format&fit=crop',
        distance: 1.2,
        distanceText: '1.2km',
        isRecommended: false,
        visitedCount: 750,
        rating: 4.5,
        category: 'è‡ªç„¶é£å…‰',
        openTime: '06:00-20:00',
        price: 'å…è´¹'
      },
      {
        spotId: 4,
        name: 'è‰ºæœ¯ç”»å»Š',
        description: 'å½“ä»£è‰ºæœ¯å±•è§ˆç©ºé—´ï¼Œå®šæœŸä¸¾åŠå›½å†…å¤–è‰ºæœ¯å®¶ä½œå“å±•ã€‚',
        images: ['https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=800&auto=format&fit=crop'],
        zoneId: 3,
        zoneName: 'è‰ºæœ¯åˆ›æ„åŒº',
        coverImage: 'https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=400&auto=format&fit=crop',
        distance: 1.5,
        distanceText: '1.5km',
        isRecommended: true,
        visitedCount: 890,
        rating: 4.6,
        category: 'å†å²æ–‡åŒ–',
        openTime: '10:00-18:00',
        price: 'Â¥30'
      },
      {
        spotId: 5,
        name: 'å„¿ç«¥æ¸¸ä¹åœº',
        description: 'é€‚åˆå®¶åº­æ¸¸ç©çš„äº²å­æ¸¸ä¹è®¾æ–½ï¼Œå®‰å…¨æœ‰è¶£çš„å„¿ç«¥æ´»åŠ¨ç©ºé—´ã€‚',
        images: ['https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=800&auto=format&fit=crop'],
        zoneId: 6,
        zoneName: 'ä¼‘é—²å¨±ä¹åŒº',
        coverImage: 'https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=400&auto=format&fit=crop',
        distance: 2.0,
        distanceText: '2.0km',
        isRecommended: false,
        visitedCount: 1200,
        rating: 4.4,
        category: 'äº²å­å®¶åº­',
        openTime: '09:00-21:00',
        price: 'Â¥25'
      },
      {
        spotId: 6,
        name: 'ç§‘æŠ€ä½“éªŒé¦†',
        description: 'å‰æ²¿ç§‘æŠ€å±•ç¤ºä¸äº’åŠ¨ä½“éªŒï¼ŒVRã€ARç­‰æ²‰æµ¸å¼ä½“éªŒé¡¹ç›®ã€‚',
        images: ['https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&auto=format&fit=crop'],
        zoneId: 4,
        zoneName: 'ç§‘æŠ€æ¢ç´¢åŒº',
        coverImage: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=400&auto=format&fit=crop',
        distance: 2.5,
        distanceText: '2.5km',
        isRecommended: true,
        visitedCount: 980,
        rating: 4.8,
        category: 'ä¼‘é—²å¨±ä¹',
        openTime: '10:00-19:00',
        price: 'Â¥80'
      },
      {
        spotId: 7,
        name: 'åŸå¸‚å…¬å›­',
        description: 'åŸå¸‚ä¸­çš„ç»¿è‰²æ°§å§ï¼Œé€‚åˆæ•£æ­¥ã€è·‘æ­¥ã€æ”¾æ¾èº«å¿ƒã€‚',
        images: ['https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&auto=format&fit=crop'],
        zoneId: 2,
        zoneName: 'ç”Ÿæ€ä½“éªŒåŒº',
        coverImage: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&auto=format&fit=crop',
        distance: 0.3,
        distanceText: '300m',
        isRecommended: true,
        visitedCount: 2200,
        rating: 4.6,
        category: 'è‡ªç„¶é£å…‰',
        openTime: 'å…¨å¤©å¼€æ”¾',
        price: 'å…è´¹'
      },
      {
        spotId: 8,
        name: 'è´­ç‰©ä¸­å¿ƒ',
        description: 'é›†è´­ç‰©ã€é¤é¥®ã€å¨±ä¹äºä¸€ä½“çš„å¤§å‹å•†ä¸šç»¼åˆä½“ã€‚',
        images: ['https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800&auto=format&fit=crop'],
        zoneId: 6,
        zoneName: 'ä¼‘é—²å¨±ä¹åŒº',
        coverImage: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=400&auto=format&fit=crop',
        distance: 0.9,
        distanceText: '900m',
        isRecommended: false,
        visitedCount: 1500,
        rating: 4.3,
        category: 'ç¾é£Ÿè´­ç‰©',
        openTime: '10:00-22:00',
        price: 'å…è´¹è¿›å…¥'
      }
    ];

    // æ ¹æ®å½“å‰æ’åºæ–¹å¼æ’åº
    const sortedSpots = this.sortSpots(baseSpots, this.currentSort);

    // æ ¹æ®å½“å‰ç­›é€‰ç±»åˆ«ç­›é€‰
    if (this.currentFilter !== 'å…¨éƒ¨') {
      this.nearbySpots = sortedSpots.filter(spot => spot.category === this.currentFilter);
    } else {
      this.nearbySpots = sortedSpots;
    }
  }

  // æ’åºæ™¯ç‚¹
  private sortSpots(spots: Array<NearbySpotItem>, sortType: SortType): Array<NearbySpotItem> {
    const spotsCopy = [...spots];

    switch (sortType) {
      case 'distance':
        return spotsCopy.sort((a, b) => a.distance - b.distance);
      case 'rating':
        return spotsCopy.sort((a, b) => b.rating - a.rating);
      case 'popular':
        return spotsCopy.sort((a, b) => b.visitedCount - a.visitedCount);
      case 'recommended':
        return spotsCopy.sort((a, b) => {
          if (a.isRecommended && !b.isRecommended) return -1;
          if (!a.isRecommended && b.isRecommended) return 1;
          return b.rating - a.rating;
        });
      default:
        return spotsCopy;
    }
  }

  // åˆ‡æ¢æ’åºæ–¹å¼
  private async changeSortType(sortType: SortType) {
    if (this.currentSort === sortType) {
      return;
    }

    this.currentSort = sortType;
    this.isLoading = true;

    // å¦‚æœAPIä¹‹å‰å¤±è´¥äº†ï¼Œç›´æ¥ä½¿ç”¨å‡æ•°æ®
    if (this.apiFailed) {
      setTimeout(() => {
        this.nearbySpots = this.sortSpots(this.nearbySpots, sortType);
        this.isLoading = false;
        console.log(`âœ… æŒ‰${this.getSortLabel(sortType)}æ’åºå®Œæˆ`);
      }, 500);
      return;
    }

    // å¦åˆ™å°è¯•é‡æ–°è°ƒç”¨API
    try {
      const response = await getNearbyRecommendations({
        latitude: this.latitude,
        longitude: this.longitude,
        sort: this.mapSortTypeToApi(sortType),
        type: 'spot'
      });

      if (response && response.code === 200 && response.data && response.data.list) {
        console.log('âœ… æ’åºæ¥å£è°ƒç”¨æˆåŠŸ');
        this.processApiData(response.data.list);
      } else {
        console.warn('æ’åºæ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ’åº');
        this.nearbySpots = this.sortSpots(this.nearbySpots, sortType);
      }
    } catch (error) {
      console.error('æ’åºæ¥å£è°ƒç”¨å¼‚å¸¸ï¼Œä½¿ç”¨æœ¬åœ°æ’åº:', error);
      this.nearbySpots = this.sortSpots(this.nearbySpots, sortType);
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ‡æ¢ç­›é€‰ç±»åˆ«
  private async changeFilterCategory(category: string) {
    if (this.currentFilter === category) {
      return;
    }

    this.currentFilter = category;
    this.isLoading = true;

    // å¦‚æœAPIä¹‹å‰å¤±è´¥äº†ï¼Œç›´æ¥ä½¿ç”¨å‡æ•°æ®
    if (this.apiFailed) {
      setTimeout(() => {
        this.generateMockData(); // é‡æ–°ç”Ÿæˆæ•°æ®åº”ç”¨ç­›é€‰
        this.isLoading = false;
        console.log(`âœ… ç­›é€‰ç±»åˆ«: ${category}`);
      }, 500);
      return;
    }

    // å¦åˆ™å°è¯•é‡æ–°è°ƒç”¨API
    try {
      const response = await getNearbyRecommendations({
        latitude: this.latitude,
        longitude: this.longitude,
        sort: this.mapSortTypeToApi(this.currentSort),
        type: 'spot'
      });

      if (response && response.code === 200 && response.data && response.data.list) {
        console.log('âœ… ç­›é€‰æ¥å£è°ƒç”¨æˆåŠŸ');
        this.processApiData(response.data.list);
      } else {
        console.warn('ç­›é€‰æ¥å£è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
        this.generateMockData();
      }
    } catch (error) {
      console.error('ç­›é€‰æ¥å£è°ƒç”¨å¼‚å¸¸ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
      this.generateMockData();
    } finally {
      this.isLoading = false;
    }
  }

  // è·å–æ’åºæ–¹å¼æ ‡ç­¾
  private getSortLabel(sortType: SortType): string {
    const option = this.sortOptions.find(opt => opt.value === sortType);
    return option ? option.label : '';
  }

  // åˆ·æ–°æ•°æ®
  private refreshData() {
    this.isRefreshing = true;
    this.loadNearbyData();
  }

  // è·å–è·ç¦»é¢œè‰²ï¼ˆæ ¹æ®è·ç¦»è¿œè¿‘æ˜¾ç¤ºä¸åŒé¢œè‰²ï¼‰
  private getDistanceColor(distance: number): string {
    if (distance < 1) return '#34C759';      // ç»¿è‰²ï¼š1kmä»¥å†…
    if (distance < 3) return '#FF9500';      // æ©™è‰²ï¼š1-3km
    return '#FF3B30';                        // çº¢è‰²ï¼š3kmä»¥ä¸Š
  }

  // æ„å»ºAPIå¤±è´¥æç¤º
  @Builder
  buildApiFailNotice() {
    if (this.apiFailed && !this.isLoading) {
      Row({ space: 8 }) {
        Text('âš ï¸')
          .fontSize(14)
          .fontColor('#FF9500')

        Text('æ¥å£è°ƒç”¨å¤±è´¥ï¼Œå·²æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®')
          .fontSize(12)
          .fontColor('#666666')
          .layoutWeight(1)

        Button('é‡è¯•')
          .fontSize(12)
          .backgroundColor('#007AFF10')
          .borderRadius(8)
          .padding({ left: 8, right: 8 })
          .height(24)
          .onClick(() => {
            console.log('ç‚¹å‡»é‡è¯•æ¥å£');
            this.loadNearbyData();
          })
      }
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor('#FFF8E6')
      .borderRadius(8)
      .margin({ left: 16, right: 16, top: 8 })
      .shadow({ radius: 2, color: '#00000004' })
    }
  }

  // æ„å»ºé¡¶éƒ¨ä½ç½®ä¿¡æ¯å¡ç‰‡
  @Builder
  buildLocationCard() {
    Column({ space: 12 }) {
      Row({ space: 8 }) {
        Text('ğŸ“')
          .fontSize(18)
          .fontColor('#007AFF')

        Text('é™„è¿‘æ¨è')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)

      Row({ space: 8 }) {
        Text(this.currentLocation)
          .fontSize(14)
          .fontColor('#666666')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)

        Button('åˆ·æ–°ä½ç½®')
          .backgroundColor('#007AFF10')
          .borderRadius(12)
          .padding({ left: 12, right: 12 })
          .height(28)
          .onClick(() => {
            console.log('ç‚¹å‡»åˆ·æ–°ä½ç½®');
            this.refreshData();
          })
      }
      .width('100%')

      Text(this.currentAddress)
        .fontSize(12)
        .fontColor('#999999')
        .textAlign(TextAlign.Start)
        .width('100%')
    }
    .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 16 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  // æ„å»ºç­›é€‰å’Œæ’åºæ 
  @Builder
  buildFilterSortBar() {
    Column({ space: 12 }) {
      // ç­›é€‰æ ‡ç­¾
      Scroll() {
        Row({ space: 8 }) {
          ForEach(this.filterOptions, (option: FilterOption) => {
            Button(option.label) {
              Text(option.label)
                .fontSize(12)
                .fontColor(this.currentFilter === option.value ? Color.White : '#666666')
            }
            .backgroundColor(this.currentFilter === option.value ? '#007AFF' : '#F5F5F5')
            .borderRadius(16)
            .padding({ left: 16, right: 16 })
            .height(32)
            .onClick(() => {
              this.changeFilterCategory(option.value);
            })
          })
        }
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .width('100%')

      // æ’åºé€‰é¡¹
      Row({ space: 8 }) {
        Text('æ’åºï¼š')
          .fontSize(14)
          .fontColor('#666666')

        ForEach(this.sortOptions, (option: SortOption) => {
          Button(option.label) {
            Text(option.label)
              .fontSize(12)
              .fontColor(this.currentSort === option.value ? '#007AFF' : '#666666')
          }
          .backgroundColor(this.currentSort === option.value ? '#007AFF10' : '#F5F5F5')
          .borderRadius(16)
          .padding({ left: 12, right: 12 })
          .height(28)
          .onClick(() => {
            this.changeSortType(option.value);
          })
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 4, bottom: 8 })
    }
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ left: 16, right: 16, top: 12 })
    .shadow({ radius: 4, color: '#00000008' })
  }

  // æ„å»ºé™„è¿‘æ™¯ç‚¹å¡ç‰‡
  @Builder
  buildSpotCard(spot: NearbySpotItem, index: number) {
    Column({ space: 0 }) {
      Row({ space: 12 }) {
        // å·¦ä¾§ï¼šå›¾ç‰‡åŒºåŸŸ
        Column() {
          Stack() {
            if (spot.coverImage && spot.coverImage.trim() !== '') {
              Image(spot.coverImage)
                .width(100)
                .height(100)
                .objectFit(ImageFit.Cover)
                .borderRadius(8)
            } else {
              Column() {
                Text('ğŸï¸')
                  .fontSize(30)
                  .fontColor('#999999')
              }
              .width(100)
              .height(100)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .backgroundColor('#F0F0F0')
              .borderRadius(8)
            }

            // æ¨èæ ‡ç­¾
            if (spot.isRecommended) {
              Text('ğŸ”¥')
                .fontSize(12)
                .fontColor(Color.White)
                .backgroundColor('#FF3B30')
                .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                .borderRadius(4)
                .position({ x: 5, y: 5 })
            }
          }
          .width(100)
          .height(100)
        }

        // å³ä¾§ï¼šä¿¡æ¯åŒºåŸŸ
        Column({ space: 6 }) {
          // æ™¯ç‚¹åç§°å’Œè·ç¦»
          Row({ space: 8 }) {
            Text(spot.name)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            // è·ç¦»æ ‡ç­¾
            Column() {
              Text(spot.distanceText)
                .fontSize(12)
                .fontColor(Color.White)
                .fontWeight(FontWeight.Medium)
            }
            .backgroundColor(this.getDistanceColor(spot.distance))
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(4)
          }
          .width('100%')

          // æ™¯ç‚¹æè¿°
          Text(spot.description)
            .fontSize(13)
            .fontColor('#666666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .width('100%')

          // åˆ†ç±»å’Œè¯„åˆ†ä¿¡æ¯
          Row({ space: 12 }) {
            // åˆ†ç±»æ ‡ç­¾
            Text(spot.category)
              .fontSize(11)
              .fontColor('#007AFF')
              .backgroundColor('#007AFF10')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)

            // è¯„åˆ†
            Row({ space: 2 }) {
              Text('â­')
                .fontSize(10)
              Text(spot.rating.toFixed(1))
                .fontSize(11)
                .fontColor('#FF9500')
            }

            // æ‰“å¡äººæ•°
            Row({ space: 2 }) {
              Text('ğŸ‘¥')
                .fontSize(10)
              Text(`${spot.visitedCount}`)
                .fontSize(11)
                .fontColor('#999999')
            }
            .layoutWeight(1)

            // ä»·æ ¼ä¿¡æ¯
            if (spot.price && spot.price !== 'å…è´¹') {
              Text(spot.price)
                .fontSize(11)
                .fontColor('#FF3B30')
                .fontWeight(FontWeight.Medium)
            }
          }
          .width('100%')
          .margin({ top: 4 })
        }
        .layoutWeight(1)
      }
      .width('100%')
      .height(120)
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })

      // åˆ†éš”çº¿
      if (index < this.nearbySpots.length - 1) {
        Divider()
          .color('#F0F0F0')
          .margin({ left: 128, right: 16 })
          .strokeWidth(0.5)
      }
    }
  }

  // æ„å»ºæ™¯ç‚¹åˆ—è¡¨
  @Builder
  buildSpotsList() {
    Column() {
      // APIå¤±è´¥æç¤º
      this.buildApiFailNotice()

      // åˆ—è¡¨æ ‡é¢˜
      Row({ space: 8 }) {
        Text('é™„è¿‘æ™¯ç‚¹')
          .fontSize(18)
          .fontColor('#333333')
          .fontWeight(FontWeight.Bold)

        Text(`å…±${this.nearbySpots.length}ä¸ª`)
          .fontSize(12)
          .fontColor('#666666')
          .backgroundColor('#F0F0F0')
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .borderRadius(10)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 12 })

      // æ™¯ç‚¹åˆ—è¡¨
      if (this.nearbySpots.length > 0) {
        Column({ space: 0 }) {
          ForEach(this.nearbySpots, (spot: NearbySpotItem, index: number) => {
            this.buildSpotCard(spot, index)
          })
        }
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ left: 16, right: 16 })
        .shadow({ radius: 4, color: '#00000008' })
      } else {
        // ç©ºçŠ¶æ€
        Column({ space: 16 }) {
          Text('ğŸ“')
            .fontSize(60)
            .fontColor('#007AFF')

          Text('é™„è¿‘æš‚æ— æ¨èæ™¯ç‚¹')
            .fontSize(16)
            .fontColor('#999999')

          Text('æ¢ä¸ªä½ç½®è¯•è¯•çœ‹ï¼Ÿ')
            .fontSize(14)
            .fontColor('#CCCCCC')

          Button('åˆ·æ–°ä½ç½®')
            .backgroundColor('#007AFF')
            .borderRadius(8)
            .width(120)
            .height(36)
            .margin({ top: 8 })
            .onClick(() => {
              this.refreshData();
            })
        }
        .width('100%')
        .padding(40)
        .alignItems(HorizontalAlign.Center)
      }
    }
  }

  // æ„å»ºåŠ è½½çŠ¶æ€
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007AFF')

      Text('åŠ è½½é™„è¿‘æ™¯ç‚¹æ•°æ®ä¸­...')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .fontColor('#333333')
          .onClick(() => this.goBack())

        // æ ‡é¢˜
        Text('é™„è¿‘æ¨è')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // åˆ·æ–°æŒ‰é’®
        Button('åˆ·æ–°')
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007AFF')
          .onClick(() => {
            this.refreshData();
          })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 0 }) {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (this.isLoading && !this.isRefreshing) {
            this.buildLoadingView()
          } else {
            // ä½ç½®ä¿¡æ¯å¡ç‰‡
            this.buildLocationCard()

            // ç­›é€‰æ’åºæ 
            this.buildFilterSortBar()

            // æ™¯ç‚¹åˆ—è¡¨
            this.buildSpotsList()

            // åº•éƒ¨å®‰å…¨åŒºåŸŸå ä½
            Row()
              .height(40)
              .width('100%')
          }
        }
        .width('100%')
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
      .onScrollEdge((side: Edge) => {
        if (side === Edge.Top) {
          this.refreshData();
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}