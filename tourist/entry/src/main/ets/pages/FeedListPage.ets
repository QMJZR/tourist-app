// entry/src/main/ets/pages/FeedsPage.ets
import router from '@ohos.router';
import { getFeeds, likeFeed, unlikeFeed, FeedItem, FeedsParams } from '../api/feeds';

// å‡æ•°æ®
const mockFeeds: FeedItem[] = [
  {
    feedId: 1001,
    userId: 2001,
    username: 'æ¸¸å®¢å°æ˜',
    avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&auto=format&fit=crop',
    spotId: 301,
    spotName: 'å±±é¡¶è§‚æ™¯å°',
    content: 'ä»Šå¤©æ‰“å¡äº†å±±é¡¶è§‚æ™¯å°ï¼Œé£æ™¯å¤ªç¾äº†ï¼ç«™åœ¨å±±é¡¶ä¿¯ç°æ•´ä¸ªå›­åŒºï¼Œå¿ƒæ—·ç¥æ€¡ã€‚',
    likes: 12,
    liked: false,
    createdAt: '2025-01-11 14:20:33'
  },
  {
    feedId: 1002,
    userId: 2002,
    username: 'æ—…è¡Œè¾¾äºº',
    avatar: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100&auto=format&fit=crop',
    spotId: 302,
    spotName: 'æ¹–ç•”æ ˆé“',
    content: 'æ¹–ç•”æ ˆé“çš„å‚æ™šå¤ªç¾äº†ï¼Œå¤•é˜³æ´’åœ¨æ¹–é¢ä¸Šï¼Œé‡‘è‰²çš„æ³¢å…‰ç²¼ç²¼ã€‚',
    likes: 25,
    liked: true,
    createdAt: '2025-01-10 18:15:22'
  },
  {
    feedId: 1003,
    userId: 2003,
    username: 'æ‘„å½±çˆ±å¥½è€…',
    avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&auto=format&fit=crop',
    spotId: 303,
    spotName: 'ç€‘å¸ƒè§‚æ™¯å°',
    content: 'ç€‘å¸ƒçš„æ°´é›¾ä¸­çœ‹åˆ°äº†å½©è™¹ï¼å¤ªå¹¸è¿äº†ï¼Œåˆ†äº«å‡ å¼ ç…§ç‰‡ç»™å¤§å®¶çœ‹çœ‹ã€‚',
    likes: 42,
    liked: false,
    createdAt: '2025-01-09 10:05:18'
  },
  {
    feedId: 1004,
    userId: 2004,
    username: 'æˆ·å¤–çˆ±å¥½è€…',
    avatar: 'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=100&auto=format&fit=crop',
    spotId: 304,
    spotName: 'èŠ±å›­å¹¿åœº',
    content: 'èŠ±å›­å¹¿åœºçš„èŠ±éƒ½å¼€äº†ï¼Œé¦™æ°”æ‰‘é¼»ï¼Œå¾ˆé€‚åˆæ”¾æ¾å¿ƒæƒ…ã€‚',
    likes: 8,
    liked: false,
    createdAt: '2025-01-08 16:30:45'
  }
];

@Entry
@Component
export default struct FeedsPage {
  // åŠ¨æ€åˆ—è¡¨æ•°æ®
  @State feeds: FeedItem[] = [];

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = true;

  // å½“å‰é¡µç 
  @State currentPage: number = 1;

  // æ’åºæ–¹å¼
  @State sortBy: string = 'latest';

  // é¡µé¢æ„å»º
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildNavigationBar()

      // ç­›é€‰å·¥å…·æ 
      this.buildFilterToolbar()

      // åŠ¨æ€åˆ—è¡¨
      if (this.isLoading) {
        this.buildLoadingView()
      } else if (this.feeds.length === 0) {
        this.buildEmptyView()
      } else {
        this.buildFeedsList()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
    .padding({ bottom: 60 }) // ä¸ºåº•éƒ¨Tabsé¢„ç•™ç©ºé—´
  }

  // ==================== é¡¶éƒ¨å¯¼èˆªæ  ====================
  @Builder
  buildNavigationBar() {
    Column() {
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .fontColor('#1A1A1A')
          .backgroundColor(Color.Transparent)
          .width(40)
          .height(40)
          .onClick(() => {
            router.back();
          })

        // æ ‡é¢˜
        Text('åŠ¨æ€å¹¿åœº')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#1A1A1A')
          .layoutWeight(1)

        // å‘å¸ƒæŒ‰é’®
        Button('å‘å¸ƒ')
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.onPublish();
          })
      }
      .width('100%')
      .height(60)
      .padding({ left: 15, right: 15 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .shadow({ radius: 2, color: '#00000008' })
  }

  // ==================== ç­›é€‰å·¥å…·æ  ====================
  @Builder
  buildFilterToolbar() {
    Column() {
      // æ’åºé€‰é¡¹
      Row({ space: 10 }) {
        Button(this.sortBy === 'latest' ? 'æœ€æ–° âœ“' : 'æœ€æ–°')
          .fontSize(14)
          .fontColor(this.sortBy === 'latest' ? '#007AFF' : '#666666')
          .backgroundColor(this.sortBy === 'latest' ? '#007AFF10' : '#F0F0F0')
          .height(32)
          .borderRadius(16)
          .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.changeSort('latest');
          })

        Button(this.sortBy === 'popular' ? 'çƒ­é—¨ âœ“' : 'çƒ­é—¨')
          .fontSize(14)
          .fontColor(this.sortBy === 'popular' ? '#007AFF' : '#666666')
          .backgroundColor(this.sortBy === 'popular' ? '#007AFF10' : '#F0F0F0')
          .height(32)
          .borderRadius(16)
          .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.changeSort('popular');
          })

        // çŠ¶æ€æ˜¾ç¤º
        Text(`å…± ${this.feeds.length} æ¡åŠ¨æ€`)
          .fontSize(14)
          .fontColor('#666666')
          .layoutWeight(1)
          .textAlign(TextAlign.End)
      }
      .width('100%')
      .padding({ left: 15, right: 15 })
    }
    .width('100%')
    .padding({ top: 10, bottom: 10 })
    .backgroundColor(Color.White)
    .margin({ top: 2 })
  }

  // ==================== åŠ è½½ä¸­è§†å›¾ ====================
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .color('#007AFF')
        .width(40)
        .height(40)
      Text('æ­£åœ¨åŠ è½½åŠ¨æ€...')
        .fontSize(14)
        .fontColor('#666666')
        .margin({ top: 10 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // ==================== ç©ºçŠ¶æ€è§†å›¾ ====================
  @Builder
  buildEmptyView() {
    Column() {
      Text('æš‚æ— åŠ¨æ€')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ bottom: 10 })
      Text('å¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€å§ï¼')
        .fontSize(14)
        .fontColor('#999999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  // ==================== åŠ¨æ€åˆ—è¡¨ ====================
  @Builder
  buildFeedsList() {
    List({ space: 10 }) {
      ForEach(this.feeds, (feed: FeedItem) => {
        ListItem() {
          this.buildFeedCard(feed)
        }
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
    .padding({ left: 15, right: 15, top: 10 })
  }

  // ==================== åŠ¨æ€å¡ç‰‡ ====================
  @Builder
  buildFeedCard(feed: FeedItem) {
    Column({ space: 0 }) {
      // ç”¨æˆ·ä¿¡æ¯è¡Œ
      Row({ space: 10 }) {
        // ç”¨æˆ·å¤´åƒ
        Image(feed.avatar)
          .width(40)
          .height(40)
          .borderRadius(20)
          .objectFit(ImageFit.Cover)

        // ç”¨æˆ·ä¿¡æ¯
        Column({ space: 4 }) {
          Text(feed.username)
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')

          Row({ space: 8 }) {
            Text(feed.spotName)
              .fontSize(12)
              .fontColor('#007AFF')

            Text('â€¢')
              .fontSize(12)
              .fontColor('#999999')

            Text(this.formatTime(feed.createdAt))
              .fontSize(12)
              .fontColor('#999999')
          }
        }
        .layoutWeight(1)
      }
      .width('100%')
      .padding({ top: 12, left: 12, right: 12 })

      // åŠ¨æ€å†…å®¹
      Column() {
        Text(feed.content)
          .fontSize(15)
          .fontColor('#333333')
          .lineHeight(22)
          .textAlign(TextAlign.Start)
          .width('100%')
      }
      .width('100%')
      .padding({ top: 12, left: 12, right: 12 })

      // äº’åŠ¨æ“ä½œæ 
      Row() {
        // ç‚¹èµæŒ‰é’®
        Row({ space: 5 }) {
          Button(feed.liked ? 'â™¥' : 'ğŸ‘')
            .fontSize(8)
            .fontColor(feed.liked ? '#FF3B30' : '#666666')
            .backgroundColor(Color.Transparent)
            .width(40)
            .height(40)
            .onClick(() => {
              this.toggleLike(feed);
            })

          Text(feed.likes.toString())
            .fontSize(14)
            .fontColor(feed.liked ? '#FF3B30' : '#666666')
        }

        // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®  ä¸å¯ä»¥æŸ¥çœ‹
        // Button('æŸ¥çœ‹è¯¦æƒ… â†’')
        //   .fontSize(14)
        //   .fontColor('#007AFF')
        //   .backgroundColor(Color.Transparent)
        //   .layoutWeight(1)
        //   .onClick(() => {
        //     this.viewFeedDetail(feed.feedId);
        //   })
      }
      .width('100%')
      .padding({ top: 12, bottom: 12, left: 12, right: 12 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 10 })
    .shadow({ radius: 4, color: '#0000000A' })
  }

  // ==================== äº¤äº’æ–¹æ³• ====================

  // åˆ‡æ¢æ’åºæ–¹å¼
  private changeSort(sortType: string) {
    this.sortBy = sortType;
    this.loadFeeds();
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  private formatTime(dateString: string): string {
    try {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now.getTime() - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'åˆšåˆš';
      if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
      if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
      if (diffDays < 7) return `${diffDays}å¤©å‰`;

      return dateString.substring(0, 10);
    } catch (e) {
      return dateString;
    }
  }

  // åˆ‡æ¢ç‚¹èµçŠ¶æ€
  private async toggleLike(feed: FeedItem) {
    const originalLiked = feed.liked;
    const originalLikes = feed.likes;

    // ç«‹å³æ›´æ–°UI
    feed.liked = !feed.liked;
    feed.likes = feed.liked ? feed.likes + 1 : Math.max(0, feed.likes - 1);
    this.feeds = [...this.feeds]; // è§¦å‘é‡æ–°æ¸²æŸ“

    try {
      if (feed.liked) {
        // ç‚¹èµ
        const result = await likeFeed(feed.feedId);
        if (result) {
          console.log('ç‚¹èµæˆåŠŸ:', result);
        } else {
          // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæ¢å¤åŸçŠ¶æ€
          feed.liked = originalLiked;
          feed.likes = originalLikes;
          this.feeds = [...this.feeds];
        }
      } else {
        // å–æ¶ˆç‚¹èµ
        const result = await unlikeFeed(feed.feedId);
        if (result) {
          console.log('å–æ¶ˆç‚¹èµæˆåŠŸ:', result);
        } else {
          // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæ¢å¤åŸçŠ¶æ€
          feed.liked = originalLiked;
          feed.likes = originalLikes;
          this.feeds = [...this.feeds];
        }
      }
    } catch (error) {
      console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
      // æ¢å¤åŸçŠ¶æ€
      feed.liked = originalLiked;
      feed.likes = originalLikes;
      this.feeds = [...this.feeds];
    }
  }

  // æŸ¥çœ‹åŠ¨æ€è¯¦æƒ…
  private viewFeedDetail(feedId: number) {
    console.log('æŸ¥çœ‹åŠ¨æ€è¯¦æƒ…:', feedId);
    // TODO: è·³è½¬åˆ°åŠ¨æ€è¯¦æƒ…é¡µé¢
  }

  // å‘å¸ƒåŠ¨æ€
  private onPublish() {
    console.log('å‘å¸ƒåŠ¨æ€');
    // TODO: è·³è½¬åˆ°å‘å¸ƒé¡µé¢
  }

  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================

  aboutToAppear() {
    console.log('åŠ¨æ€é¡µé¢æ˜¾ç¤º');
    this.loadFeeds();
  }

  // åŠ è½½åŠ¨æ€æ•°æ®
  private async loadFeeds() {
    console.log('å¼€å§‹åŠ è½½åŠ¨æ€æ•°æ®...');
    this.isLoading = true;

    this.feeds = [...mockFeeds];

    this.isLoading = false;
    // è°ƒç”¨APIè·å–åŠ¨æ€åˆ—è¡¨
    // const params: FeedsParams = {
    //   page: this.currentPage,
    //   pageSize: 10,
    //   sort: this.sortBy
    // };
    //
    // try {
    //   const result = await getFeeds(params);
    //   if (result && result.length > 0) {
    //     this.feeds = result;
    //     console.log('åŠ¨æ€æ•°æ®åŠ è½½æˆåŠŸï¼Œå…±', result.length, 'æ¡');
    //   } else {
    //     // å¦‚æœAPIè¿”å›ç©ºï¼Œä½¿ç”¨å‡æ•°æ®
    //     console.log('APIè¿”å›ç©ºæ•°æ®ï¼Œä½¿ç”¨å‡æ•°æ®');
    //     this.feeds = [...mockFeeds];
    //   }
    // } catch (error) {
    //   console.error('åŠ è½½åŠ¨æ€æ•°æ®å¤±è´¥:', error);
    //   // ä½¿ç”¨å‡æ•°æ®
    //   this.feeds = [...mockFeeds];
    // } finally {
    //   this.isLoading = false;
    // }
  }

  aboutToDisappear() {
    console.log('åŠ¨æ€é¡µé¢å³å°†æ¶ˆå¤±');
  }
}