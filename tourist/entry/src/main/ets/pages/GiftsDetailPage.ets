// entry/src/main/ets/pages/GiftsDetailPage.ets

import { router } from '@kit.ArkUI';
import { getGifts, getAvailableGifts, getRedeemedGifts, GiftsApiResponse } from '../api/profile';

// ç¤¼å“è®°å½•ç±»å‹å®šä¹‰
interface GiftRecordLocal {
  giftId: number;
  name: string;
  pointsRequired: number;
  status: string;  // "available" | "redeemed" | "expired"
  redeemedAt: string | null;
}

// ç¤¼å“ç±»å‹å®šä¹‰
type GiftStatus = 'all' | 'available' | 'redeemed' | 'expired';

// ç­›é€‰æŒ‰é’®ç±»å‹
interface FilterButton {
  label: string;
  value: GiftStatus;
}

@Entry
@Component
struct GiftsDetailPage {
  @State totalGifts: number = 0;  // ç¤¼å“æ€»æ•°
  @State totalAvailable: number = 0;  // å¯å…‘æ¢ç¤¼å“æ•°
  @State totalRedeemed: number = 0;  // å·²å…‘æ¢ç¤¼å“æ•°
  @State giftsRecords: Array<GiftRecordLocal> = [];  // ç¤¼å“è®°å½•åˆ—è¡¨
  @State currentPage: number = 1;  // å½“å‰é¡µç 
  @State totalPages: number = 1;  // æ€»é¡µæ•°

  // ç¤¼å“ç­›é€‰çŠ¶æ€
  @State currentFilter: GiftStatus = 'all';  // å½“å‰ç­›é€‰çŠ¶æ€

  // ä½¿ç”¨æ˜ç¡®çš„ç±»å‹å£°æ˜ç­›é€‰æŒ‰é’®æ•°ç»„
  private filterButtons: Array<FilterButton> = [
    {label: 'å…¨éƒ¨', value: 'all'},
    {label: 'å¯å…‘æ¢', value: 'available'},
    {label: 'å·²å…‘æ¢', value: 'redeemed'}
  ];

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;
  @State isRefreshing: boolean = false;
  @State isError: boolean = false;
  @State errorMessage: string = '';

  // ç”Ÿå‘½å‘¨æœŸï¼šé¡µé¢æ˜¾ç¤ºæ—¶
  aboutToAppear() {
    console.log('ç¤¼å“è¯¦æƒ…é¡µé¢æ˜¾ç¤º');
    this.loadGiftsData();
  }

  // åŠ è½½ç¤¼å“æ•°æ®
  private async loadGiftsData() {
    if (this.isLoading) {
      return;
    }

    this.isLoading = true;
    this.isError = false;

    try {
      // ä½¿ç”¨æ˜¾å¼ç±»å‹å£°æ˜apiResultå˜é‡
      let apiResult: GiftsApiResponse | void | undefined;

      // æ ¹æ®ç­›é€‰çŠ¶æ€è°ƒç”¨ä¸åŒçš„APIå‡½æ•°
      if (this.currentFilter === 'available') {
        apiResult = await getAvailableGifts(this.currentPage);
      } else if (this.currentFilter === 'redeemed') {
        apiResult = await getRedeemedGifts(this.currentPage);
      } else {
        apiResult = await getGifts(this.currentPage, this.currentFilter);
      }

      // ç®€åŒ–ç±»å‹æ£€æŸ¥ï¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰ç»“æœ
      if (!apiResult) {
        this.isError = true;
        this.errorMessage = 'è·å–ç¤¼å“æ•°æ®å¤±è´¥ï¼šæ— è¿”å›ç»“æœ';
        console.log('âŒ è·å–ç¤¼å“æ•°æ®å¤±è´¥ï¼šæ— è¿”å›ç»“æœ');
        return;
      }

      // ç°åœ¨apiResultè‚¯å®šä¸æ˜¯voidç±»å‹ï¼Œè¿›è¡Œç±»å‹æ–­è¨€
      const result = apiResult as GiftsApiResponse;

      if (result.code === 200 && result.data) {
        // ç¡®ä¿è·å–åˆ°çš„æ˜¯æ•°ç»„ç±»å‹
        const list: Array<GiftRecordLocal> = (result.data.list || []) as Array<GiftRecordLocal>;
        const total: number = result.data.total || 0;

        // ä½¿ç”¨ concat ä»£æ›¿å±•å¼€è¿ç®—ç¬¦
        if (this.currentPage === 1) {
          this.giftsRecords = list;
        } else {
          this.giftsRecords = this.giftsRecords.concat(list);
        }

        this.totalGifts = total;

        // è®¡ç®—æ€»é¡µæ•°
        const pageSize = 10;  // é»˜è®¤æ¯é¡µ10æ¡
        this.totalPages = Math.ceil(total / pageSize);

        // ç»Ÿè®¡ä¸åŒçŠ¶æ€çš„ç¤¼å“æ•°é‡
        this.updateGiftCounts();

        console.log(`âœ… åŠ è½½ç¤¼å“æ•°æ®æˆåŠŸï¼Œå…±${this.totalGifts}æ¡è®°å½•ï¼Œå½“å‰ç¬¬${this.currentPage}é¡µ`);
      } else {
        this.isError = true;
        // ä½¿ç”¨å®‰å…¨çš„æ–¹å¼è®¿é—®msgå±æ€§
        const errorMsg = result.msg || 'è·å–ç¤¼å“æ•°æ®å¤±è´¥';
        this.errorMessage = `é”™è¯¯ï¼š${errorMsg}`;
        console.log('âŒ è·å–ç¤¼å“æ•°æ®å¤±è´¥:', errorMsg);
      }
    } catch (error) {
      this.isError = true;
      this.errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
      console.error('è·å–ç¤¼å“æ•°æ®å¼‚å¸¸:', error);
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }

  // æ›´æ–°ç¤¼å“æ•°é‡ç»Ÿè®¡
  private updateGiftCounts() {
    // ä½¿ç”¨æ˜¾å¼ç±»å‹è½¬æ¢å’Œè¿‡æ»¤
    const availableCount = this.giftsRecords.filter((gift: GiftRecordLocal) =>
    gift.status === 'available'
    ).length;

    const redeemedCount = this.giftsRecords.filter((gift: GiftRecordLocal) =>
    gift.status === 'redeemed'
    ).length;

    this.totalAvailable = availableCount;
    this.totalRedeemed = redeemedCount;
  }

  // åˆ·æ–°æ•°æ®
  private async refreshData() {
    this.currentPage = 1;
    this.isRefreshing = true;
    await this.loadGiftsData();
  }

  // åŠ è½½æ›´å¤š
  private async loadMore() {
    if (this.isLoading || this.currentPage >= this.totalPages) {
      return;
    }

    this.currentPage += 1;
    this.isLoading = true;

    try {
      // ä½¿ç”¨æ˜¾å¼ç±»å‹å£°æ˜apiResultå˜é‡
      let apiResult: GiftsApiResponse | void | undefined;

      if (this.currentFilter === 'available') {
        apiResult = await getAvailableGifts(this.currentPage);
      } else if (this.currentFilter === 'redeemed') {
        apiResult = await getRedeemedGifts(this.currentPage);
      } else {
        apiResult = await getGifts(this.currentPage, this.currentFilter);
      }

      // ç®€åŒ–ç±»å‹æ£€æŸ¥
      if (!apiResult) {
        console.log('åŠ è½½æ›´å¤šå¤±è´¥ï¼šæ— è¿”å›ç»“æœ');
        this.currentPage -= 1;
        return;
      }

      const result = apiResult as GiftsApiResponse;

      if (result.code === 200 && result.data) {
        // è¿½åŠ æ•°æ® - ä½¿ç”¨ concat ä»£æ›¿å±•å¼€è¿ç®—ç¬¦
        const newRecords: Array<GiftRecordLocal> = (result.data.list || []) as Array<GiftRecordLocal>;
        this.giftsRecords = this.giftsRecords.concat(newRecords);

        // æ›´æ–°ç»Ÿè®¡
        this.updateGiftCounts();

        console.log(`âœ… åŠ è½½æ›´å¤šæˆåŠŸï¼Œå½“å‰å…±${this.giftsRecords.length}æ¡è®°å½•`);
      }
    } catch (error) {
      console.error('åŠ è½½æ›´å¤šå¼‚å¸¸:', error);
      // å›é€€é¡µç 
      this.currentPage -= 1;
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ‡æ¢ç­›é€‰çŠ¶æ€
  private changeFilter(filter: GiftStatus) {
    if (this.currentFilter === filter || this.isLoading) {
      return;
    }

    this.currentFilter = filter;
    this.currentPage = 1;
    this.giftsRecords = [];
    this.loadGiftsData();
  }

  // æ ¼å¼åŒ–æ—¶é—´ï¼ˆå»æ‰ç§’ï¼‰
  private formatTime(timeString: string | null): string {
    if (!timeString) return '';
    // å°† "2025-01-11 14:20:33" æ ¼å¼åŒ–ä¸º "2025-01-11 14:20"
    return timeString.substring(0, 16);
  }

  // è·å–ç¤¼å“çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
  private getStatusText(status: string): string {
    switch (status) {
      case 'available':
        return 'å¯å…‘æ¢';
      case 'redeemed':
        return 'å·²å…‘æ¢';
      case 'expired':
        return 'å·²è¿‡æœŸ';
      default:
        return status;
    }
  }

  // è·å–ç¤¼å“çŠ¶æ€é¢œè‰²
  private getStatusColor(status: string): ResourceColor {
    switch (status) {
      case 'available':
        return '#34C759';  // ç»¿è‰²
      case 'redeemed':
        return '#007AFF';  // è“è‰²
      case 'expired':
        return '#999999';  // ç°è‰²
      default:
        return '#666666';
    }
  }

  // è·å–çŠ¶æ€èƒŒæ™¯è‰²
  private getStatusBgColor(status: string): ResourceColor {
    switch (status) {
      case 'available':
        return '#E8F5E9';  // æµ…ç»¿è‰²
      case 'redeemed':
        return '#E3F2FD';  // æµ…è“è‰²
      case 'expired':
        return '#F5F5F5';  // æµ…ç°è‰²
      default:
        return '#F5F5F5';
    }
  }

  // æ„å»ºç¤¼å“å¡ç‰‡
  @Builder
  buildGiftsCard() {
    Column({ space: 16 }) {
      // ç¤¼å“æ ‡é¢˜
      Text('æˆ‘çš„ç¤¼å“')
        .fontSize(16)
        .fontColor('#666666')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Start)
        .width('100%')

      // ç¤¼å“ç»Ÿè®¡
      Row({ space: 12 }) {
        // å¯å…‘æ¢ç¤¼å“
        Column({ space: 4 }) {
          Text(this.totalAvailable.toString())
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#34C759')

          Text('å¯å…‘æ¢')
            .fontSize(12)
            .fontColor('#999999')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)

        // åˆ†éš”çº¿
        Divider()
          .vertical(true)
          .height(40)
          .color('#F0F0F0')

        // å·²å…‘æ¢ç¤¼å“
        Column({ space: 4 }) {
          Text(this.totalRedeemed.toString())
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007AFF')

          Text('å·²å…‘æ¢')
            .fontSize(12)
            .fontColor('#999999')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)

        // åˆ†éš”çº¿
        Divider()
          .vertical(true)
          .height(40)
          .color('#F0F0F0')

        // ç¤¼å“æ€»æ•°
        Column({ space: 4 }) {
          Text(this.totalGifts.toString())
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9500')

          Text('æ€»è®¡')
            .fontSize(12)
            .fontColor('#999999')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .padding({ top: 8, bottom: 8 })

      // ç¤¼å“è¯´æ˜
      Text('ä½¿ç”¨ç§¯åˆ†å…‘æ¢å¿ƒä»ªç¤¼å“ï¼Œè®©æ—…è¡Œæ›´æœ‰è¶£')
        .fontSize(14)
        .fontColor('#999999')
        .textAlign(TextAlign.Start)
        .width('100%')
        .margin({ top: 4 })
    }
    .padding({ left: 24, right: 24, top: 24, bottom: 24 })
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({ radius: 8, color: '#FF950010' })
  }

  // æ„å»ºç­›é€‰æ 
  @Builder
  buildFilterBar() {
    Row({ space: 12 }) {
      // ä½¿ç”¨æ˜¾å¼ç±»å‹éå†æ•°ç»„
      ForEach(this.filterButtons, (button: FilterButton) => {
        Button(button.label) {
          Text(button.label)
            .fontSize(14)
            .fontColor(this.currentFilter === button.value ? Color.White : '#666666')
        }
        .backgroundColor(this.currentFilter === button.value ? '#007AFF' : '#F5F5F5')
        .borderRadius(20)
        .padding({ left: 16, right: 16 })
        .height(36)
        .onClick(() => {
          this.changeFilter(button.value);
        })
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 16, bottom: 12 })
    .justifyContent(FlexAlign.Start)
  }

  // æ„å»ºç¤¼å“è®°å½•é¡¹
  @Builder
  buildGiftRecordItem(record: GiftRecordLocal, index: number) {
    Column() {
      Row({ space: 16 }) {
        // å·¦ä¾§ï¼šç¤¼å“å›¾æ ‡
        Column() {
          Text('ğŸ')
            .fontSize(20)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
        }
        .width(40)
        .height(40)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor(this.getStatusColor(record.status))
        .borderRadius(20)

        // ä¸­é—´ï¼šè¯¦æƒ…
        Column({ space: 4 }) {
          // ç¤¼å“åç§°
          Row({ space: 8 }) {
            Text(record.name)
              .fontSize(16)
              .fontColor('#333333')
              .fontWeight(FontWeight.Medium)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)

            // çŠ¶æ€æ ‡ç­¾
            Text(this.getStatusText(record.status))
              .fontSize(11)
              .fontColor(this.getStatusColor(record.status))
              .backgroundColor(this.getStatusBgColor(record.status))
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)
          }
          .width('100%')

          // ç§¯åˆ†å’Œå…‘æ¢æ—¶é—´
          Row({ space: 12 }) {
            Text(`${record.pointsRequired}ç§¯åˆ†`)
              .fontSize(13)
              .fontColor('#FF9500')
              .backgroundColor('#FFF4E6')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(4)

            if (record.status === 'redeemed' && record.redeemedAt) {
              Text(`å…‘æ¢æ—¶é—´: ${this.formatTime(record.redeemedAt)}`)
                .fontSize(11)
                .fontColor('#999999')
            }
          }
          .width('100%')
          .margin({ top: 4 })
        }
        .layoutWeight(1)
      }
      .width('100%')
      .height(68)
      .padding({ left: 16, right: 16 })

      // åˆ†éš”çº¿ï¼ˆä¸æ˜¯æœ€åä¸€é¡¹æ—¶æ˜¾ç¤ºï¼‰
      if (index < this.giftsRecords.length - 1) {
        Divider()
          .color('#F0F0F0')
          .margin({ left: 72, right: 16 })
          .strokeWidth(0.5)
      }
    }
  }

  // æ„å»ºå…‘æ¢æŒ‰é’®
  @Builder
  buildRedeemButton(gift: GiftRecordLocal) {
    Button('ç«‹å³å…‘æ¢')
      .backgroundColor('#FF9500')
    .borderRadius(8)
    .height(32)
    .padding({ left: 12, right: 12 })
    .enabled(gift.status === 'available')
    .onClick(() => {
      console.log('å…‘æ¢ç¤¼å“:', gift.name);
      // è¿™é‡Œå¯ä»¥æ·»åŠ å…‘æ¢é€»è¾‘
    })
  }

  // æ„å»ºè®°å½•åˆ—è¡¨
  @Builder
  buildRecordsList() {
    Column() {
      // åˆ—è¡¨æ ‡é¢˜
      Row({ space: 8 }) {
        Text('ç¤¼å“åˆ—è¡¨')
          .fontSize(18)
          .fontColor('#333333')
          .fontWeight(FontWeight.Bold)

        if (this.totalGifts > 0) {
          Text(`å…±${this.totalGifts}ä¸ª`)
            .fontSize(12)
            .fontColor('#666666')
            .backgroundColor('#F0F0F0')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(10)
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })

      // ç­›é€‰æ 
      this.buildFilterBar()

      // ç¤¼å“åˆ—è¡¨
      if (this.giftsRecords.length > 0) {
        Column({ space: 0 }) {
          ForEach(this.giftsRecords, (record: GiftRecordLocal, index: number) => {
            Column() {
              this.buildGiftRecordItem(record, index)

              // å¯å…‘æ¢ç¤¼å“æ˜¾ç¤ºå…‘æ¢æŒ‰é’®
              if (record.status === 'available') {
                Row() {
                  Row()
                    .width(56)  // å·¦ä¾§å ä½ï¼Œå¯¹é½å›¾æ ‡åŒºåŸŸ

                  this.buildRedeemButton(record)
                }
                .width('100%')
                .padding({ left: 16, right: 16, bottom: 12 })
              }
            }
          })
        }
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ left: 16, right: 16 })
        .shadow({ radius: 4, color: '#00000008' })

        // åŠ è½½æ›´å¤šæç¤º
        if (this.currentPage < this.totalPages) {
          Column() {
            if (this.isLoading) {
              LoadingProgress()
                .width(24)
                .height(24)
                .color('#007AFF')
                .margin({ bottom: 8 })

              Text('åŠ è½½ä¸­...')
                .fontSize(14)
                .fontColor('#666666')
            } else {
              Text('ç‚¹å‡»åŠ è½½æ›´å¤š')
                .fontSize(14)
                .fontColor('#007AFF')
                .padding({ top: 16, bottom: 16 })
                .onClick(() => {
                  this.loadMore();
                })
            }
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .margin({ top: 20, bottom: 20 })
        }
      } else {
        // ç©ºçŠ¶æ€
        Column({ space: 16 }) {
          Text('ğŸ')
            .fontSize(60)
            .fontColor('#FF9500')

          Text('æš‚æ— ç¤¼å“è®°å½•')
            .fontSize(16)
            .fontColor('#999999')

          if (this.currentFilter === 'available') {
            Text('å¿«å»èµšå–ç§¯åˆ†å…‘æ¢ç¤¼å“å§ï¼')
              .fontSize(14)
              .fontColor('#CCCCCC')
          } else if (this.currentFilter === 'redeemed') {
            Text('è¿˜æ²¡æœ‰å…‘æ¢è¿‡ç¤¼å“å“¦')
              .fontSize(14)
              .fontColor('#CCCCCC')
          } else {
            Text('æš‚æ— ç¤¼å“')
              .fontSize(14)
              .fontColor('#CCCCCC')
          }
        }
        .width('100%')
        .padding(40)
        .alignItems(HorizontalAlign.Center)
      }
    }
  }

  // æ„å»ºåŠ è½½çŠ¶æ€
  @Builder
  buildLoadingView() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#007AFF')

      Text('åŠ è½½ç¤¼å“æ•°æ®ä¸­...')
        .fontSize(16)
        .fontColor('#666666')
        .margin({ top: 16 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // æ„å»ºé”™è¯¯çŠ¶æ€
  @Builder
  buildErrorView() {
    Column({ space: 16 }) {
      Text('åŠ è½½å¤±è´¥')
        .fontSize(18)
        .fontColor('#FF3B30')
        .fontWeight(FontWeight.Medium)

      Text(this.errorMessage)
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .width('80%')

      Button('é‡æ–°åŠ è½½')
        .backgroundColor('#007AFF')
        .fontColor(Color.White)
        .fontSize(14)
        .width(120)
        .height(36)
        .onClick(() => {
          this.refreshData();
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row({ space: 10 }) {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .fontSize(20)
          .backgroundColor(Color.Transparent)
          .fontColor('#333333')
          .onClick(() => this.goBack())

        // æ ‡é¢˜
        Text('ç¤¼å“è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // åˆ·æ–°æŒ‰é’®
        Button('åˆ·æ–°')
          .fontSize(14)
          .backgroundColor(Color.Transparent)
          .fontColor('#007AFF')
          .onClick(() => {
            this.refreshData();
          })
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .width('100%')
      .backgroundColor(Color.White)
      .border({ width: { bottom: 1 }, color: '#F0F0F0' })

      // å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 0 }) {
          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          if (this.isLoading && !this.isRefreshing && this.giftsRecords.length === 0) {
            this.buildLoadingView()
          }
          // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
          else if (this.isError && this.giftsRecords.length === 0) {
            this.buildErrorView()
          }
          // æ˜¾ç¤ºæ­£å¸¸å†…å®¹
          else {
            // ç¤¼å“å¡ç‰‡
            Column() {
              this.buildGiftsCard()
            }
            .padding({ left: 16, right: 16, top: 20, bottom: 16 })

            // ç¤¼å“è®°å½•åˆ—è¡¨
            this.buildRecordsList()

            // åº•éƒ¨å®‰å…¨åŒºåŸŸå ä½
            Row()
              .height(40)
              .width('100%')
          }
        }
        .width('100%')
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}