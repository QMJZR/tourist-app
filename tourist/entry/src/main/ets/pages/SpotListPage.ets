// entry/src/main/ets/pages/SpotsPage.ets
import { SpotCard, SpotRequest, SpotResponse, SpotDetail, getSpots, getSpotDetail } from '../api/zone';
import { SpotListResponse } from '../models/Spot';
import router from "@ohos.router"

@Entry
@Component
export default struct SpotsPage {
  // æ™¯ç‚¹åˆ—è¡¨æ•°æ®
  @State spots: SpotCard[] = [
  // ä¸´æ—¶å‡æ•°æ®ï¼ŒAPIå®ç°åç§»é™¤
    {
      spotId: 1,
      name: 'å¤å»ºç­‘ç¾¤',
      description: 'ä¿å­˜å®Œå¥½çš„æ˜æ¸…æ—¶æœŸå¤å»ºç­‘ç¾¤ï¼Œå±•ç¤ºäº†å¤ä»£å»ºç­‘è‰ºæœ¯çš„ç²¾é«“ã€‚',
      images: [
        'https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w=800&auto=format&fit=crop'
      ],
      zoneId: 5,
      zoneName: 'å†å²æ–‡åŒ–åŒº',
      coverImage: 'https://images.unsplash.com/photo-1542728928-0013d5f8d5b5?w=400&auto=format&fit=crop',
      distance: 1.2,
      isRecommended: true,
      visitedCount: 1250,
      rating: 4.7
    },
    {
      spotId: 2,
      name: 'ç§‘æŠ€ä½“éªŒé¦†',
      description: 'å‰æ²¿ç§‘æŠ€å±•ç¤ºä¸äº’åŠ¨ä½“éªŒï¼ŒVRã€ARç­‰æ²‰æµ¸å¼ä½“éªŒé¡¹ç›®ã€‚',
      images: [
        'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&auto=format&fit=crop'
      ],
      zoneId: 4,
      zoneName: 'ç§‘æŠ€æ¢ç´¢åŒº',
      coverImage: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=400&auto=format&fit=crop',
      distance: 2.5,
      isRecommended: true,
      visitedCount: 980,
      rating: 4.8
    },
    {
      spotId: 3,
      name: 'ç”Ÿæ€æ¹¿åœ°å…¬å›­',
      description: 'åŸç”Ÿæ¹¿åœ°ç”Ÿæ€ç³»ç»Ÿï¼Œè§‚é¸Ÿã€å¾’æ­¥ã€è‡ªç„¶æ•™è‚²çš„å¥½å»å¤„ã€‚',
      images: [
        'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=800&auto=format&fit=crop'
      ],
      zoneId: 2,
      zoneName: 'ç”Ÿæ€ä½“éªŒåŒº',
      coverImage: 'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=400&auto=format&fit=crop',
      distance: 3.8,
      isRecommended: false,
      visitedCount: 750,
      rating: 4.5
    },
    {
      spotId: 4,
      name: 'è‰ºæœ¯ç”»å»Š',
      description: 'å½“ä»£è‰ºæœ¯å±•è§ˆç©ºé—´ï¼Œå®šæœŸä¸¾åŠå›½å†…å¤–è‰ºæœ¯å®¶ä½œå“å±•ã€‚',
      images: [
        'https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=800&auto=format&fit=crop'
      ],
      zoneId: 3,
      zoneName: 'è‰ºæœ¯åˆ›æ„åŒº',
      coverImage: 'https://images.unsplash.com/photo-1544725176-7c40e5a71c5e?w=400&auto=format&fit=crop',
      distance: 0.8,
      isRecommended: true,
      visitedCount: 890,
      rating: 4.6
    },
    {
      spotId: 5,
      name: 'å„¿ç«¥æ¸¸ä¹åœº',
      description: 'é€‚åˆå®¶åº­æ¸¸ç©çš„äº²å­æ¸¸ä¹è®¾æ–½ï¼Œå®‰å…¨æœ‰è¶£çš„å„¿ç«¥æ´»åŠ¨ç©ºé—´ã€‚',
      images: [
        'https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=800&auto=format&fit=crop'
      ],
      zoneId: 6,
      zoneName: 'ä¼‘é—²å¨±ä¹åŒº',
      coverImage: 'https://images.unsplash.com/photo-1516937941344-00b4e0337589?w=400&auto=format&fit=crop',
      distance: 1.5,
      isRecommended: false,
      visitedCount: 1200,
      rating: 4.4
    },
    {
      spotId: 6,
      name: 'ç‰¹è‰²ç¾é£Ÿè¡—',
      description: 'æ±‡èšå„åœ°ç‰¹è‰²å°åƒå’Œä¼ ç»Ÿç¾é£Ÿï¼Œä½“éªŒåœ°é“é£å‘³ã€‚',
      images: [
        'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&auto=format&fit=crop'
      ],
      zoneId: 6,
      zoneName: 'ä¼‘é—²å¨±ä¹åŒº',
      coverImage: 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&auto=format&fit=crop',
      distance: 1.0,
      isRecommended: true,
      visitedCount: 1800,
      rating: 4.9
    }
  ];

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;

  // é”™è¯¯ä¿¡æ¯
  @State errorMessage: string = '';

  // æœç´¢å…³é”®è¯
  @State searchText: string = '';

  // å½“å‰é€‰ä¸­çš„ç­›é€‰æ ‡ç­¾
  @State selectedTag: string = 'å…¨éƒ¨';

  // ç­›é€‰æ ‡ç­¾åˆ—è¡¨
  @State tags: string[] = ['å…¨éƒ¨', 'æ¨è', 'é™„è¿‘', 'çƒ­é—¨', 'å…è´¹', 'äº²å­', 'æ‹ç…§'];

  // æ’åºæ–¹å¼
  @State sortBy: string = 'æ¨è';

  build() {
    Column() {
      // 1. é¡¶éƒ¨æ ‡é¢˜å’Œæœç´¢æ 
      this.buildHeader()

      // 2. ç­›é€‰å’Œæ’åºæ 
      this.buildFilterSortBar()

      // 3. å†…å®¹åŒºåŸŸ
      Column() {
        this.buildSpotsList()
      }
      .width('100%')
      .flexGrow(1)
      .margin({ bottom: 60 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
  }

  // ==================== é¡¶éƒ¨æ ‡é¢˜å’Œæœç´¢æ  ====================

  @Builder
  buildHeader() {
    Column({ space: 15 }) {
      // æ ‡é¢˜
      Row() {
        Text('æ™¯ç‚¹æ¢ç´¢')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .layoutWeight(1)

        // ç­›é€‰æŒ‰é’®
        Button('ç­›é€‰', { type: ButtonType.Normal })
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor('#007AFF10')
          .height(36)
          .borderRadius(18)
          .padding({ left: 16, right: 16 })
          .onClick(() => {
            console.log('ç‚¹å‡»ç­›é€‰æŒ‰é’®');
            // TODO: æ‰“å¼€ç­›é€‰é¢æ¿
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 15 })

      // æœç´¢æ¡†
      Row({ space: 10 }) {
        // æœç´¢å›¾æ ‡
        Text('ğŸ”')
          .fontSize(18)
          .margin({ left: 15 })

        // æœç´¢è¾“å…¥æ¡†
        TextInput({ placeholder: 'æœç´¢æ™¯ç‚¹ã€å…³é”®è¯...' })
          .placeholderColor('#999999')
          .fontSize(16)
          .width('100%')
          .height(48)
          .backgroundColor(Color.White)
          .caretColor('#007AFF')
          .onChange((value: string) => {
            this.searchText = value;
            console.log('æœç´¢å…³é”®è¯:', value);
          })

        // æ¸…é™¤æŒ‰é’®
        if (this.searchText.length > 0) {
          Button('å–æ¶ˆ')
            .fontSize(14)
            .fontColor('#666666')
            .backgroundColor(Color.Transparent)
            .height(36)
            .margin({ right: 10 })
            .onClick(() => {
              this.searchText = '';
            })
        }
      }
      .width('90%')
      .height(52)
      .backgroundColor(Color.White)
      .borderRadius(26)
      .shadow({ radius: 6, color: '#00000010' })
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .padding({ bottom: 15 })
    .shadow({ radius: 2, color: '#00000008' })
  }

  // ==================== ç­›é€‰å’Œæ’åºæ  ====================

  @Builder
  buildFilterSortBar() {
    Column() {
      // ç­›é€‰æ ‡ç­¾
      Scroll() {
        Row({ space: 10 }) {
          ForEach(this.tags, (tag: string) => {
            this.buildTagItem(tag)
          })
        }
        .padding({ left: 20, right: 20, top: 12, bottom: 12 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .backgroundColor(Color.White)
      .width('100%')
      .height(50)

      // æ’åºæ 
      Row({ space: 15 }) {
        Text('æ’åºï¼š')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ left: 20 })

        ForEach(['æ¨è', 'è·ç¦»', 'çƒ­åº¦', 'è¯„åˆ†'], (sortOption: string) => {
          Button(sortOption)
            .fontSize(14)
            .fontColor(this.sortBy === sortOption ? '#007AFF' : '#666666')
            .backgroundColor(this.sortBy === sortOption ? '#007AFF10' : '#F5F7FA')
            .height(32)
            .borderRadius(16)
            .padding({ left: 16, right: 16 })
            .onClick(() => {
              this.sortBy = sortOption;
              console.log('é€‰æ‹©æ’åºæ–¹å¼:', sortOption);
              this.sortSpots();
            })
        })
          //.layoutWeight(1)
      }
      .width('100%')
      .height(44)
      .backgroundColor(Color.White)
      .alignItems(VerticalAlign.Center)
    }
    .width('100%')
    .backgroundColor(Color.White)
  }

  // æ„å»ºæ ‡ç­¾é¡¹ç›®
  @Builder
  buildTagItem(tag: string) {
    Button(tag)
      .fontSize(14)
      .fontColor(this.selectedTag === tag ? Color.White : '#666666')
      .backgroundColor(this.selectedTag === tag ? '#007AFF' : '#F5F7FA')
      .height(32)
      .borderRadius(16)
      .padding({ left: 16, right: 16 })
      .onClick(() => {
        this.selectedTag = tag;
        console.log('é€‰æ‹©æ ‡ç­¾:', tag);
        this.filterSpots();
      })
  }

  // ==================== æ™¯ç‚¹åˆ—è¡¨ ====================

  @Builder
  buildSpotsList() {
    Scroll() {
      Column({ space: 15 }) {
        ForEach(this.spots, (spot: SpotCard) => {
          this.buildSpotCard(spot)
        })
      }
      .width('100%')
      .padding({ left: 15, right: 15, top: 15, bottom: 180 })
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
  }

  @Builder
  buildSpotCard(spot: SpotCard) {
    Column({ space: 0 }) {
      // å¡ç‰‡é¡¶éƒ¨ - å›¾ç‰‡åŒºåŸŸ
      Stack() {
        // èƒŒæ™¯å›¾ç‰‡
        Image(spot.coverImage || spot.images[0] || '')
          .width('100%')
          .height(180)
          .objectFit(ImageFit.Cover)
          .borderRadius({ topLeft: 12, topRight: 12 })

        // å›¾ç‰‡é®ç½©æ¸å˜
        Column()
          .width('100%')
          .height(60)
          //.backgroundImage($r('app.media.image_gradient'), ImageRepeat.NoRepeat)
          .backgroundImageSize(ImageSize.Cover)
          .position({ x: 0, y: 120 })

        // æ¨èæ ‡ç­¾
        if (spot.isRecommended) {
          Row({ space: 3 }) {
            Text('ğŸ”¥')
              .fontSize(12)
            Text('æ¨è')
              .fontSize(12)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Medium)
          }
          .padding({ left: 8, right: 8 })
          .height(24)
          .backgroundColor('#FF3B30')
          .borderRadius(12)
          .position({ x: 15, y: 15 })
        }

        // æ‰€å±åŒºåŸŸæ ‡ç­¾
        Row({ space: 3 }) {
          Text('ğŸ“')
            .fontSize(12)
          Text(spot.zoneName || 'æœªåˆ†ç±»')
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .padding({ left: 8, right: 8 })
        .height(24)
        .backgroundColor('#00000080')
        .borderRadius(12)
        .position({ x: 15, y: 145 })

        // å³ä¸Šè§’è¯„åˆ†
        Row({ space: 3 }) {
          Text('â­')
            .fontSize(12)
          Text(spot.rating?.toFixed(1) || '4.5')
            .fontSize(12)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Medium)
        }
        .padding({ left: 8, right: 8 })
        .height(24)
        .backgroundColor('#00000080')
        .borderRadius(12)
        .position({ x: '85%', y: 15 })
      }
      .width('100%')
      .height(180)

      // å¡ç‰‡å†…å®¹åŒºåŸŸ
      Column({ space: 8 }) {
        // æ™¯ç‚¹åç§°å’Œè·ç¦»
        Row() {
          Text(spot.name)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .layoutWeight(1)

          if (spot.distance) {
            Row({ space: 2 }) {
              Text('ğŸ“')
                .fontSize(12)
              Text(`${spot.distance}km`)
                .fontSize(12)
                .fontColor('#666666')
            }
            .padding({ left: 8, right: 8 })
            .height(24)
            .backgroundColor('#F5F7FA')
            .borderRadius(12)
          }
        }
        .width('100%')

        // æ™¯ç‚¹æè¿°
        Text(spot.description)
          .fontSize(14)
          .fontColor('#666666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')

        // åº•éƒ¨ä¿¡æ¯æ 
        Row() {
          // æ‰“å¡äººæ•°
          Row({ space: 3 }) {
            Text('ğŸ‘¥')
              .fontSize(12)
            Text(`${spot.visitedCount || 0}äººæ‰“å¡`)
              .fontSize(12)
              .fontColor('#666666')
          }
          .layoutWeight(1)

          // æ“ä½œæŒ‰é’®ç»„
          Row({ space: 10 }) {
            // æ”¶è—æŒ‰é’®
            Button('â¤ï¸ æ”¶è—')
              .fontSize(12)
              .fontColor('#FF3B30')
              .backgroundColor('#FF3B3010')
              .height(28)
              .borderRadius(14)
              .padding({ left: 10, right: 10 })
              .onClick(() => {
                this.onCollectSpot(spot);
              })

            // æ‰“å¡æŒ‰é’®
            Button('ğŸ“ æ‰“å¡')
              .fontSize(12)
              .fontColor(Color.White)
              .backgroundColor('#007AFF')
              .height(28)
              .borderRadius(14)
              .padding({ left: 10, right: 10 })
              .onClick(() => {
                this.onCheckInSpot(spot);
              })
          }
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .padding({ left: 15, right: 15, top: 15, bottom: 15 })
      .backgroundColor(Color.White)
      .borderRadius({ bottomLeft: 12, bottomRight: 12 })
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 6, color: '#0000000D' })
    .onClick(() => {
      this.onSpotCardClick(spot);
    })
  }

  // ==================== äº¤äº’æ–¹æ³• ====================

  // ç‚¹å‡»æ™¯ç‚¹å¡ç‰‡
  private onSpotCardClick(spot: SpotCard) {
    console.log('ç‚¹å‡»æ™¯ç‚¹:', spot.name);
    // TODO: è·³è½¬åˆ°æ™¯ç‚¹è¯¦æƒ…é¡µ
    router.pushUrl({
      url: 'pages/SpotDetailPage',
      params: { spotId: spot.spotId }
    }).then(() => {
      console.log('è·³è½¬æˆåŠŸ');
    }).catch(() => {
      console.error('è·³è½¬å¤±è´¥');
    });
  }

  // æ”¶è—æ™¯ç‚¹
  private onCollectSpot(spot: SpotCard) {
    console.log('æ”¶è—æ™¯ç‚¹:', spot.spotId, spot.name);
    // TODO: è°ƒç”¨æ”¶è—API
  }

  // æ‰“å¡æ™¯ç‚¹
  private onCheckInSpot(spot: SpotCard) {
    console.log('æ‰“å¡æ™¯ç‚¹:', spot.spotId, spot.name);
    // TODO: è·³è½¬åˆ°æ‰“å¡é¡µé¢æˆ–è°ƒç”¨æ‰“å¡API
  }

  // ç­›é€‰æ™¯ç‚¹
  private filterSpots() {
    console.log('ç­›é€‰æ™¯ç‚¹ï¼Œæ ‡ç­¾:', this.selectedTag);
    // TODO: æ ¹æ®æ ‡ç­¾ç­›é€‰æ™¯ç‚¹
  }

  // æ’åºæ™¯ç‚¹
  private sortSpots() {
    console.log('æ’åºæ™¯ç‚¹ï¼Œæ–¹å¼:', this.sortBy);
    // TODO: æ ¹æ®æ’åºæ–¹å¼æ’åºæ™¯ç‚¹
  }

  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================

  // ç›¸å½“äºVueçš„onMounted
  aboutToAppear() {
    console.log('æ™¯ç‚¹é¡µé¢æ˜¾ç¤ºï¼Œå¼€å§‹åŠ è½½æ•°æ®...');

    // è¿™é‡Œè°ƒç”¨APIè·å–æ™¯ç‚¹æ•°æ®
    this.loadSpotsData();
  }

  // åŠ è½½æ™¯ç‚¹æ•°æ®
  private loadSpotsData() {
    console.log('å¼€å§‹åŠ è½½æ™¯ç‚¹æ•°æ®...');

    // TODO: è°ƒç”¨APIè·å–æ™¯ç‚¹æ•°æ®
    // ç¤ºä¾‹ä»£ç ï¼š
    // try {
    //   this.isLoading = true;
    //   const spots = await fetchSpots(); // ä½ çš„APIæ–¹æ³•
    //   this.spots = spots;
    // } catch (error) {
    //   console.error('åŠ è½½æ™¯ç‚¹æ•°æ®å¤±è´¥:', error);
    //   this.errorMessage = 'åŠ è½½æ•°æ®å¤±è´¥';
    // } finally {
    //   this.isLoading = false;
    // }
    const data:SpotRequest = {

    }
    getSpots(data);
    // æš‚æ—¶ä½¿ç”¨å‡æ•°æ®
    this.isLoading = false;
  }

  // ==================== çŠ¶æ€è§†å›¾ ====================

  // å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ åŠ è½½ä¸­ã€é”™è¯¯ã€ç©ºçŠ¶æ€è§†å›¾
  // å‚è€ƒZonesPageçš„å®ç°
}