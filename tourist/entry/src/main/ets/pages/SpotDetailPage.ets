import { getSpotDetail, SpotDetail} from '../api/zone';

// entry/src/main/ets/pages/SpotDetailPage.ets
import router from '@ohos.router';

// å‡æ•°æ® - æ ¹æ®ä½ çš„æ–‡æ¡£å­—æ®µ
const mockSpotDetail : SpotDetail = {
  spotId: 101,
  name: 'ç€‘å¸ƒè§‚æ™¯å°',
  images: [
    'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&auto=format&fit=crop',
    'https://images.unsplash.com/photo-1551632811-561732d1e306?w=800&auto=format&fit=crop',
    'https://images.unsplash.com/photo-1464207687429-7505649dae38?w=800&auto=format&fit=crop',
    'https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=800&auto=format&fit=crop'
  ],
  video: 'https://example.com/spot101_video.mp4',
  description: 'ç€‘å¸ƒè§‚æ™¯å°æ˜¯å›­åŒºæœ€å£®è§‚çš„è‡ªç„¶æ™¯ç‚¹ä¹‹ä¸€ï¼Œç€‘å¸ƒä»ç™¾ç±³é«˜ç©ºå€¾æ³»è€Œä¸‹ï¼Œæ°”åŠ¿ç£…ç¤´ã€‚æ¸…æ™¨æ—¶åˆ†ï¼Œé˜³å…‰é€è¿‡æ°´é›¾å½¢æˆç¾ä¸½çš„å½©è™¹ï¼Œæ˜¯æ‘„å½±çˆ±å¥½è€…çš„ç»ä½³å–æ™¯åœ°ã€‚è§‚æ™¯å°è®¾æœ‰å®‰å…¨æŠ¤æ å’Œå¤šå¤„è§‚æ™¯å¹³å°ï¼Œæ¸¸å®¢å¯ä»¥è¿‘è·ç¦»æ„Ÿå—ç€‘å¸ƒçš„éœ‡æ’¼åŠ›ã€‚',
  zoneId: 1,
  latitude: 23.334450,
  longitude: 113.334001,
  openTime: '08:00-18:00',
};

interface RouterParam {
  spotId: number;
}

@Entry
@Component
export default struct SpotDetailPage {
  // è·¯ç”±å‚æ•°
  @State spotId: number = 0;

  // æ™¯ç‚¹è¯¦æƒ…æ•°æ®
  @State spotDetail: SpotDetail = mockSpotDetail;

  // åŠ è½½çŠ¶æ€
  @State isLoading: boolean = false;

  // è½®æ’­å›¾å½“å‰ç´¢å¼•
  @State currentImageIndex: number = 0;

  // æ˜¯å¦å±•å¼€è¯¦æƒ…
  @State isDescriptionExpanded: boolean = false;

  // æ˜¯å¦æ”¶è—
  @State isCollected: boolean = false;

  // é¡µé¢æ„å»º
  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      this.buildNavigationBar()

      // 2. å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ - ä½¿ç”¨flexGrowå æ®å‰©ä½™ç©ºé—´
      Scroll() {
        Column() {
          // æ‰€æœ‰å†…å®¹å¡ç‰‡
          this.buildImageCarousel()
          this.buildBasicInfoCard()
          this.buildDescriptionCard()
          this.buildPracticalInfoCard()
          this.buildLocationCard()
          this.buildTipsCard()

          // åº•éƒ¨é—´è·ï¼Œä¸ºå›ºå®šæŒ‰é’®ç•™å‡ºç©ºé—´
          Row()
            .height(80) // è¿™ä¸ªé«˜åº¦è¦å¤§äºåº•éƒ¨æŒ‰é’®çš„é«˜åº¦
            .width('100%')
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1) // å…³é”®ï¼šä½¿ç”¨layoutWeightè€Œä¸æ˜¯flexGrow
      .scrollBar(BarState.Off)

      // 3. åº•éƒ¨æ“ä½œæ  - å›ºå®šé«˜åº¦ï¼Œä¸ä¼šè¢«æŒ¤å‹
      //this.buildBottomActionBar()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
  }
  // ==================== é¡¶éƒ¨å¯¼èˆªæ  ====================
  @Builder
  buildNavigationBar() {
    Row({ space: 10 }) {
      // è¿”å›æŒ‰é’®
      Button('â†')
        .fontSize(20)
        .fontColor('#1A1A1A')
        .backgroundColor(Color.Transparent)
        .width(40)
        .height(40)
        .onClick(() => {
          router.back();
        })

      // æ ‡é¢˜
      Text('æ™¯ç‚¹è¯¦æƒ…')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#1A1A1A')
        .layoutWeight(1)

      // åˆ†äº«æŒ‰é’®
      Button('åˆ†äº«')
        .fontSize(14)
        .fontColor('#007AFF')
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          this.onShare();
        })
    }
    .width('100%')
    .height(60)
    .backgroundColor(Color.White)
    .padding({ left: 15, right: 15 })
    .shadow({ radius: 2, color: '#00000008' })
  }

  // ==================== è½®æ’­å›¾ ====================
  @Builder
  buildImageCarousel() {
    Stack() {
      // å›¾ç‰‡è½®æ’­ - ä½¿ç”¨Swiperç»„ä»¶
      Swiper() {
        // ç›´æ¥ä½¿ç”¨å¤šä¸ªImageä½œä¸ºSwiperItem
        Image(this.spotDetail.images[0] || '')
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)

        Image(this.spotDetail.images[1] || '')
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)

        Image(this.spotDetail.images[2] || '')
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
      }
      .loop(true)
      .autoPlay(true)
      .interval(3000)
      .duration(500)
      .width('100%')
      .height(300)
      .onChange((index: number) => {
        this.currentImageIndex = index;
      })


    }
    .width('100%')
    .height(300)
  }
  // è½®æ’­å›¾æŒ‡ç¤ºå™¨
  @Builder
  buildCarouselIndicator() {
    // ä½¿ç”¨é»˜è®¤æŒ‡ç¤ºå™¨
  }

  // ==================== åŸºæœ¬ä¿¡æ¯å¡ç‰‡ ====================
  @Builder
  buildBasicInfoCard() {
    Column({ space: 12 }) {
      // æ™¯ç‚¹åç§°å’Œæ”¶è—æŒ‰é’®
      Row() {
        Text(this.spotDetail.name)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .layoutWeight(1)

        // æ”¶è—æŒ‰é’®
        Button(this.isCollected ? 'â¤ï¸ å·²æ”¶è—' : 'ğŸ¤ æ”¶è—')
          .fontSize(14)
          .fontColor(this.isCollected ? '#FF3B30' : '#666666')
          .backgroundColor(this.isCollected ? '#FF3B3010' : '#F5F7FA')
          .height(32)
          .borderRadius(16)
          .padding({ left: 12, right: 12 })
          .onClick(() => {
            this.onToggleCollect();
          })
      }
      .width('100%')

      // è¯„åˆ†å’Œå¼€æ”¾æ—¶é—´
      Row({ space: 15 }) {
        // è¯„åˆ†
        Row({ space: 5 }) {
          Text('â­')
            .fontSize(16)
          Text('4.8')
            .fontSize(16)
            .fontColor('#1A1A1A')
            .fontWeight(FontWeight.Medium)
        }

        // åˆ†å‰²çº¿
        Text('|')
          .fontSize(16)
          .fontColor('#E0E0E0')

        // å¼€æ”¾æ—¶é—´
        Row({ space: 5 }) {
          Text('ğŸ•')
            .fontSize(16)
          Text(this.spotDetail.openTime)
            .fontSize(16)
            .fontColor('#1A1A1A')
        }

        // åˆ†å‰²çº¿
        Text('|')
          .fontSize(16)
          .fontColor('#E0E0E0')


      }
      .width('100%')
    }
    .width('90%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .padding({ left: 20, right: 20, top: 20, bottom: 20 })
    .margin({ top: -20 })
    .alignSelf(ItemAlign.Center)
    .shadow({ radius: 8, color: '#0000000D' })
  }

  // ==================== è¯¦æƒ…æè¿°å¡ç‰‡ ====================
  @Builder
  buildDescriptionCard() {
    Column({ space: 15 }) {
      // æ ‡é¢˜
      Row() {
        Text('æ™¯ç‚¹ä»‹ç»')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')

        if (this.spotDetail.video) {
          Button('è§‚çœ‹è§†é¢‘ â†’')
            .fontSize(14)
            .fontColor('#007AFF')
            .backgroundColor(Color.Transparent)
            .onClick(() => {
              this.onPlayVideo();
            })
            .margin({ left: 10 })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)

      // æè¿°å†…å®¹
      Text(this.spotDetail.description)
        .fontSize(15)
        .fontColor('#666666')
        .lineHeight(22)
        .textAlign(TextAlign.Start)
        .maxLines(this.isDescriptionExpanded ? undefined : 4)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')

      // å±•å¼€/æ”¶èµ·æŒ‰é’®
      if (this.spotDetail.description.length > 200) {
        Button(this.isDescriptionExpanded ? 'æ”¶èµ·' : 'å±•å¼€æ›´å¤š')
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.isDescriptionExpanded = !this.isDescriptionExpanded;
          })
          .alignSelf(ItemAlign.Start)
      }
    }
    .width('90%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .padding({ left: 20, right: 20, top: 20, bottom: 20 })
    .margin({ top: 15 })
    .alignSelf(ItemAlign.Center)
    .shadow({ radius: 8, color: '#0000000D' })
  }

  // ==================== å®ç”¨ä¿¡æ¯å¡ç‰‡ ====================
  @Builder
  buildPracticalInfoCard() {
    Column({ space: 12 }) {
      // æ ‡é¢˜
      Text('å®ç”¨ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
        .width('100%')

      // ä¿¡æ¯åˆ—è¡¨
      Column({ space: 10 }) {


        // è¯¦ç»†åœ°å€
        Row() {
          Text('ğŸ“')
            .fontSize(16)
            .margin({ right: 10 })
          Text('è¯¦ç»†åœ°å€')
            .fontSize(15)
            .fontColor('#666666')
            .layoutWeight(1)
          Text('æš‚æ— ')
            .fontSize(15)
            .fontColor('#1A1A1A')
            .fontWeight(FontWeight.Medium)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .width('100%')
      }
    }
    .width('90%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .padding({ left: 20, right: 20, top: 20, bottom: 20 })
    .margin({ top: 15 })
    .alignSelf(ItemAlign.Center)
    .shadow({ radius: 8, color: '#0000000D' })
  }

  // ==================== ä½ç½®ä¿¡æ¯å¡ç‰‡ ====================
  @Builder
  buildLocationCard() {
    Column({ space: 12 }) {
      // æ ‡é¢˜
      Row() {
        Text('åœ°ç†ä½ç½®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .layoutWeight(1)

        Button('æŸ¥çœ‹åœ°å›¾ â†’')
          .fontSize(14)
          .fontColor('#007AFF')
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.onViewMap();
          })
      }
      .width('100%')


      // åæ ‡ä¿¡æ¯
      Text(`ç»çº¬åº¦ï¼š${this.spotDetail.latitude.toFixed(6)}, ${this.spotDetail.longitude.toFixed(6)}`)
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .textAlign(TextAlign.Center)
        .margin({ top: 8 })
    }
    .width('90%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .padding({ left: 20, right: 20, top: 20, bottom: 20 })
    .margin({ top: 15 })
    .alignSelf(ItemAlign.Center)
    .shadow({ radius: 8, color: '#0000000D' })
  }

  // ==================== æ¸¸ç©æç¤ºå¡ç‰‡ ====================
  @Builder
  buildTipsCard() {
    Column({ space: 12 }) {
      // æ ‡é¢˜
      Text('æ¸¸ç©æç¤º')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1A1A1A')
        .width('100%')


    }
    .width('90%')
    .backgroundColor(Color.White)
    .borderRadius(16)
    .padding({ left: 20, right: 20, top: 20, bottom: 20 })
    .margin({ top: 15 })
    .alignSelf(ItemAlign.Center)
    .shadow({ radius: 8, color: '#0000000D' })
  }

  // ==================== åº•éƒ¨æ“ä½œæ  ====================
  @Builder
  buildBottomActionBar() {
    Column() {
      // æŒ‰é’®å®¹å™¨
      Row({ space: 10 }) {
        // å¯¼èˆªæŒ‰é’®
        Button('å¯¼èˆªå‰å¾€')
          .fontSize(16)
          .fontColor('#007AFF')
          .backgroundColor('#007AFF10')
          .height(50)
          .borderRadius(25)
          .layoutWeight(1)
          .onClick(() => {
            this.onNavigate();
          })

        // æ‰“å¡æŒ‰é’®
        Button('ç«‹å³æ‰“å¡')
          .fontSize(16)
          .fontColor(Color.White)
          .backgroundColor('#007AFF')
          .height(50)
          .borderRadius(25)
          .layoutWeight(1)
          .onClick(() => {
            this.onCheckIn();
          })
      }
      .width('100%')
      .padding({ left: 15, right: 15 })
    }
    .width('100%')
    .height(70) // å›ºå®šé«˜åº¦
    .backgroundColor(Color.White)
    .shadow({ radius: 10, color: '#0000001A', offsetY: -3 })
    .padding({ top: 10, bottom: 10 })
  }

  // ==================== äº¤äº’æ–¹æ³• ====================

  // åˆ†äº«
  private onShare() {
    console.log('åˆ†äº«æ™¯ç‚¹:', this.spotDetail.name);
    // TODO: å®ç°åˆ†äº«åŠŸèƒ½
  }

  // åˆ‡æ¢æ”¶è—
  private onToggleCollect() {
    this.isCollected = !this.isCollected;
    console.log(this.isCollected ? 'å·²æ”¶è—' : 'å–æ¶ˆæ”¶è—', this.spotDetail.name);
    // TODO: è°ƒç”¨æ”¶è—API
  }

  // æ’­æ”¾è§†é¢‘
  private onPlayVideo() {
    console.log('æ’­æ”¾è§†é¢‘:', this.spotDetail.video);
    // TODO: æ’­æ”¾è§†é¢‘
  }

  // æŸ¥çœ‹åœ°å›¾
  private onViewMap() {
    console.log('æŸ¥çœ‹åœ°å›¾ï¼Œåæ ‡:', this.spotDetail.latitude, this.spotDetail.longitude);
    // TODO: è·³è½¬åˆ°åœ°å›¾é¡µé¢
  }

  // å¯¼èˆªå‰å¾€
  private onNavigate() {
    console.log('å¯¼èˆªå‰å¾€:', this.spotDetail.name);
    // TODO: æ‰“å¼€åœ°å›¾å¯¼èˆª
  }

  // ç«‹å³æ‰“å¡
  private onCheckIn() {
    console.log('æ‰“å¡æ™¯ç‚¹:', this.spotDetail.name);
    // TODO: è·³è½¬åˆ°æ‰“å¡é¡µé¢
  }

  // ==================== ç”Ÿå‘½å‘¨æœŸæ–¹æ³• ====================

  aboutToAppear() {
    console.log('æ™¯ç‚¹è¯¦æƒ…é¡µé¢æ˜¾ç¤º');

    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as RouterParam;
    if (params?.spotId) {
      this.spotId = params.spotId;
      console.log('æ¥æ”¶åˆ°çš„spotId:', this.spotId);

      // TODO: æ ¹æ®spotIdè°ƒç”¨APIè·å–æ™¯ç‚¹è¯¦æƒ…
      this.loadSpotDetail();
    } else {
      console.warn('æœªæ¥æ”¶åˆ°spotIdå‚æ•°ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
      // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œä½¿ç”¨å‡æ•°æ®
      this.loadMockData();
    }
  }

  // åŠ è½½æ™¯ç‚¹è¯¦æƒ…æ•°æ®
  private loadSpotDetail() {
    console.log('å¼€å§‹åŠ è½½æ™¯ç‚¹è¯¦æƒ…ï¼ŒID:', this.spotId);

    //getSpotDetail(this.spotId)

    // æš‚æ—¶ä½¿ç”¨å‡æ•°æ®
    this.loadMockData();
  }

  // åŠ è½½å‡æ•°æ®
  private loadMockData() {
    console.log('åŠ è½½å‡æ•°æ®');
    this.isLoading = false;
    // å‡æ•°æ®å·²ç»åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®äº†
  }

  aboutToDisappear() {
    console.log('æ™¯ç‚¹è¯¦æƒ…é¡µé¢å³å°†æ¶ˆå¤±');
    // æ¸…ç†èµ„æº
  }
}